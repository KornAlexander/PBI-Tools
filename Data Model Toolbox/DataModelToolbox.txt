    ,{
      "Id": 49,
      "Name": "8. Bernats Repo\\3. Calc Group\\Activate Relationship Calc Group",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing System.Windows.Forms; \r\nusing Microsoft.VisualBasic;\r\n\r\n//2022-09-14 / B.Agullo / first release\r\n//CREATE CALCULATION GROUP TO ENABLE INACTIVE RELEATIONSHIPS\r\n//Select releationships of your model and run the script\r\n\r\n//see https://www.esbrina-ba.com/activating-inactive-relationships-the-smart-way/ \r\n\r\n//initialize calc group variable\r\nCalculationGroupTable cg = null as CalculationGroupTable;\r\n\r\n//create calc group (only first time)\r\nif(!CalculationGroupUtils.CreateCalculationGroup(\r\n    model:Model,\r\n    myCalculationGroup: out cg,\r\n    defaultCalculationGroupName: \"Model\",annotationValue:\"Model modifications\")) return;\r\n\r\n//goes through selected relationships\r\nforeach (SingleColumnRelationship r in Selected.SingleColumnRelationships)\r\n{\r\n    //and only for those inactive\r\n    if (!r.IsActive)\r\n    {   \r\n        //prepare name and expression for the calculation item\r\n        string calcItemName = r.FromColumn.DaxObjectFullName + \" - \" + r.ToColumn.DaxObjectFullName;\r\n        string calcItemExpression =\r\n            String.Format(\r\n                \"CALCULATE(SELECTEDMEASURE(),USERELATIONSHIP({0},{1}))\",\r\n                r.FromColumn.DaxObjectFullName,\r\n                r.ToColumn.DaxObjectFullName\r\n            );\r\n        \r\n        //add calculation item\r\n        CalculationItem calcItem = null as CalculationItem; \r\n        if(!CalculationGroupUtils.CreateCalculationItem(\r\n            out calcItem,\r\n            cg: cg,\r\n            defaultCalculationItemName: calcItemName,\r\n            promptUser: false, \r\n            calcItemExpression:calcItemExpression,\r\n            regenerateIfPresent: false)) return;\r\n    }\r\n}\r\n \r\n        public static class StringUtils\r\n    {\r\n        public enum CheckType\r\n        {\r\n            Table,\r\n            Measure,\r\n            Column,\r\n            CalculationItem,\r\n            None\r\n        }\r\n        public static bool InitString\r\n            (\r\n                out string stringToInit,\r\n                string label = \"Name\",\r\n                string defaultValue = \"Default Name\",\r\n                string errorMessage = \"No name provided\",\r\n                string alreadyUsedNameErrorMessage = \"There is already another {0} called {1}\", //collision with names alerady in the model\r\n                string invalidNameErrorMessage = \"Name cannot be any of the following: {0}\", //arbitrary list of forbidden names\r\n                string[] invalidNames = null,\r\n                Model model = null,\r\n                Table table = null,\r\n                CalculationGroupTable cg = null,\r\n                CheckType checkType = CheckType.None,\r\n                string prompt = \"Default Prompt\",\r\n                string valueOnError = \"\",\r\n                bool promptUser = true //if false, validate only default name is not forbidden, ask for input if it is\r\n            )\r\n        {\r\n\r\n\r\n            bool validName;\r\n            string userValue;\r\n            stringToInit = valueOnError;\r\n\r\n            do\r\n            {\r\n                if (promptUser)\r\n                {\r\n                    //get name from user\r\n                    //userValue = Interaction.InputBox(prompt, label, defaultValue, 740, 400);\r\n                    if (!StringUtils.Input(\r\n                        userString: out userValue,\r\n                        prompt: prompt,\r\n                        label: label,\r\n                        defaultValue: defaultValue)\r\n                    )\r\n                    {\r\n                        stringToInit = valueOnError;\r\n                        return false;\r\n                    };\r\n                }\r\n                else\r\n                {\r\n                    //bypass interaction\r\n                    userValue = defaultValue;\r\n                }\r\n\r\n                switch (checkType)\r\n                {\r\n                    case CheckType.None:\r\n                        //nothing to check all is good \r\n                        validName = true;\r\n                        break;\r\n\r\n                    case CheckType.Table:\r\n                        if (model == null)\r\n                        {\r\n                            throw new ArgumentNullException();\r\n                        }\r\n                        //if it's going to be a table, there cannot be any table with the same name\r\n                        validName = !model.Tables.Any(x => x.Name == userValue);\r\n\r\n                        if (!validName)\r\n                        {\r\n                            MessageUtils.ErrorMessage(\r\n                                String.Format(\r\n                                    alreadyUsedNameErrorMessage,\r\n                                    \"table\",\r\n                                    userValue\r\n                                )\r\n                            );\r\n                        }\r\n                        break;\r\n\r\n                    case CheckType.Column:\r\n                        if (model == null)\r\n                        {\r\n                            throw new ArgumentNullException();\r\n                        }\r\n\r\n                        //if its a column, there cannot be any other column on that table with the same name\r\n                        validName = !table.Columns.Any(x => x.Name == userValue);\r\n\r\n                        if (!validName)\r\n                        {\r\n                            MessageUtils.ErrorMessage(\r\n                                String.Format(\r\n                                    alreadyUsedNameErrorMessage,\r\n                                    \"column\", userValue\r\n                                )\r\n                            );\r\n                        };\r\n\r\n                        break;\r\n\r\n                    case CheckType.Measure:\r\n                        if (model == null)\r\n                        {\r\n                            throw new ArgumentNullException();\r\n                        }\r\n                        if (table == null)\r\n                        {\r\n                            throw new ArgumentNullException();\r\n                        }\r\n\r\n\r\n                        //if its a measure, there cannot be any measure with the same name, or any column on that table with the same name \r\n                        validName = !table.Columns.Any(x => x.Name == userValue)\r\n                                    && !model.AllMeasures.Any(x => x.Name == userValue);\r\n\r\n                        if (!validName)\r\n                        {\r\n                            MessageUtils.ErrorMessage(\r\n                                String.Format(\r\n                                    alreadyUsedNameErrorMessage,\r\n                                    \"measure in the model or column in \" + table.Name,\r\n                                    userValue\r\n                                )\r\n                            );\r\n                        };\r\n                        break;\r\n\r\n\r\n                    case CheckType.CalculationItem:\r\n                        if (cg == null)\r\n                        {\r\n                            throw new ArgumentNullException();\r\n                        }\r\n                        //if its a calculation item, there cannot be any other calculation item with the same name\r\n                        validName = !cg.CalculationItems.Any(x => x.Name == userValue);\r\n\r\n                        if (!validName)\r\n                        {\r\n                            MessageUtils.ErrorMessage(\r\n                                String.Format(\r\n                                    alreadyUsedNameErrorMessage,\r\n                                    \"calculation item\",\r\n                                    userValue\r\n                                )\r\n                            );\r\n                        };\r\n                        break;\r\n\r\n\r\n                    default:\r\n                        validName = true;\r\n                        break;\r\n\r\n\r\n                }\r\n\r\n                //if we got a valid name so far check it's not in the invalid name list\r\n                if (validName)\r\n                {\r\n                    //if no invalid names then.. \r\n                    if (invalidNames == null || invalidNames.Length == 0)\r\n                    {\r\n                        //..all good\r\n                        validName = true;\r\n                    }\r\n                    else\r\n                    {\r\n                        //otherwise check if the name is any of the invalid ones\r\n                        validName = !invalidNames.Contains(userValue);\r\n                        if (!validName)\r\n                        {\r\n                            //tell user this name cannot be used.\r\n                            MessageUtils.ErrorMessage(\r\n                                String.Format(invalidNameErrorMessage, String.Join(\", \", invalidNames))\r\n                            );\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (!validName)\r\n                {\r\n                    //enable user interaction to fix it\r\n                    promptUser = true;\r\n                }\r\n\r\n\r\n            } while (!validName);\r\n\r\n            //emptystring will be counted as valid string, but is not a valid name ever and we take it as a key to abort\r\n            if (string.IsNullOrWhiteSpace(userValue))\r\n            {\r\n                MessageUtils.ErrorMessage(errorMessage);\r\n                stringToInit = valueOnError;\r\n                return false;\r\n            };\r\n\r\n            //if we reach this point then is all good\r\n            stringToInit = userValue;\r\n            return true;\r\n        }\r\n\r\n        public static bool Input\r\n            (\r\n                out string userString,\r\n                string prompt = \"Enter string\",\r\n                string label = \"String\",\r\n                string defaultValue = \"some text\",\r\n                int xPosition = 740,\r\n                int yPosition = 400,\r\n                bool nullOrWhiteSpaceAccepted = false,\r\n                string errorMessage = \"Null or Empty String provided\",\r\n                string unexpectedErrorMessage = \"Unexpected Error in StringUtils.Input\",\r\n                string valueOnError = \"\"\r\n            )\r\n        {\r\n            try\r\n            {\r\n                string tempUserString = Microsoft.VisualBasic.Interaction.InputBox(prompt, label, defaultValue, XPos: xPosition, YPos: yPosition);\r\n\r\n                if (string.IsNullOrWhiteSpace(tempUserString) && !nullOrWhiteSpaceAccepted)\r\n                {\r\n                    MessageUtils.ErrorMessage(errorMessage);\r\n                    userString = valueOnError;\r\n                    return false;\r\n                }\r\n                else\r\n                {\r\n                    userString = tempUserString;\r\n                    return true;\r\n                };\r\n            }\r\n            catch\r\n            {\r\n                MessageUtils.ErrorMessage(unexpectedErrorMessage);\r\n                userString = valueOnError;\r\n                return false;\r\n            }\r\n\r\n        }\r\n    }\r\n\r\n    public static class MessageUtils\r\n    {\r\n        public static void ErrorMessage\r\n            (\r\n                string errorMessage,\r\n                bool showMessage = true,\r\n                string caption = \"Error\"\r\n            )\r\n        {\r\n            try\r\n            {\r\n                if (showMessage)\r\n                {\r\n                    MessageBox.Show( errorMessage,  caption, MessageBoxButtons.OK, MessageBoxIcon.Error);\r\n                };\r\n\r\n                return;\r\n            }\r\n            catch\r\n            {\r\n                //can't really call error message right? \r\n                return;\r\n            };\r\n        }\r\n\r\n\r\n\r\n        public static bool IsAnswerOK\r\n            (\r\n                string question,\r\n                string caption = \"Before we proceed\"\r\n\r\n            )\r\n        {\r\n            try\r\n            {\r\n                DialogResult dialogResult = MessageBox.Show(question,  caption, MessageBoxButtons.YesNo);\r\n                if (dialogResult == DialogResult.Yes)\r\n                {\r\n                    return true;\r\n                }\r\n                else if (dialogResult == DialogResult.No)\r\n                {\r\n                    return false;\r\n                }\r\n                else\r\n                {\r\n                    return false; //??\r\n                }\r\n            }\r\n            catch\r\n            {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        public static bool SelectFromList\r\n            (\r\n                List<string> selectionList,\r\n                out List<string> selectedItems,\r\n                SelectionMode selectionMode = SelectionMode.One,\r\n                string title = \"Select from this list\",\r\n                string cancelMessage = \"You cancelled the process\",\r\n                bool selectionRequired = true,\r\n                string selectionRequiredMessage = \"Select item or cancel\",\r\n                bool skipDialogIfSingleItem = false,\r\n                bool preselectFirstItem = false,\r\n                bool showEmptyListError = true,\r\n                string emptyListErrorMessage = \"Empty selection list\"\r\n\r\n            )\r\n        {\r\n\r\n            selectedItems = new List<string>(); //initialize return list \r\n\r\n            if (selectionList.Count == 0)\r\n            {\r\n                if (showEmptyListError)\r\n                    MessageUtils.ErrorMessage(emptyListErrorMessage);\r\n                return false;\r\n            };\r\n\r\n            //general stuff\r\n            var form = new Form();\r\n            form.Text = title;\r\n\r\n            //it shows on top of the list box??\r\n            //var titleLabel = new Label();\r\n            //titleLabel.Text = title;\r\n            //titleLabel.Dock = DockStyle.Top;\r\n\r\n            //button pannel at the bottom\r\n            var buttonPanel = new Panel();\r\n            buttonPanel.Dock = DockStyle.Bottom;\r\n            buttonPanel.Height = 30;\r\n\r\n            //individual buttons\r\n            var okButton = new Button() { DialogResult = DialogResult.OK, Text = \"OK\" };\r\n            var cancelButton = new Button() { DialogResult = DialogResult.Cancel, Text = \"Cancel\", Left = 80 };\r\n\r\n            //listbox\r\n            var listBox = new ListBox();\r\n            listBox.Dock = DockStyle.Fill;\r\n            listBox.SelectionMode = selectionMode;\r\n\r\n            //fills listbox with options from selectionList\r\n            listBox.Items.AddRange(selectionList.ToArray());\r\n\r\n            //preselects first item by default\r\n            if (preselectFirstItem)\r\n                listBox.SelectedItem = selectionList[0];\r\n\r\n            //putting pieces together\r\n            //form.Controls.Add(titleLabel);\r\n            form.Controls.Add(listBox);\r\n            form.Controls.Add(buttonPanel);\r\n            buttonPanel.Controls.Add(okButton);\r\n            buttonPanel.Controls.Add(cancelButton);\r\n            //make sure it shows up in the middle of the screen\r\n            form.StartPosition = FormStartPosition.CenterScreen;\r\n\r\n            bool oneOrMoreSelected; //flag to check listbox selection\r\n\r\n            bool askAgain; //flag to ask again if no selection done but selection is required\r\n            DialogResult result; //variable to store the result of the dialog box\r\n\r\n            if (!skipDialogIfSingleItem || selectionList.Count > 1)\r\n            {\r\n                do\r\n                {\r\n                    //shows the form\r\n                    result = form.ShowDialog();\r\n\r\n                    if (result != DialogResult.OK)\r\n                    {\r\n                        //user cancelled (or aborted),  return false, selectedItems is empty list\r\n                        MessageUtils.ErrorMessage(cancelMessage);\r\n                        return false;\r\n                    }\r\n\r\n                    //true if one or more items are selected in the listbox\r\n                    oneOrMoreSelected = ListBoxUtils.OneOrMoreSelected(listBox);\r\n\r\n                    //if selection required and non present, raise flag\r\n                    askAgain = selectionRequired && !oneOrMoreSelected;\r\n\r\n                    //if flag is raised show message to select something or cancel\r\n                    if (askAgain)\r\n                        MessageUtils.ErrorMessage(selectionRequiredMessage);\r\n\r\n                } while (askAgain);\r\n\r\n                //if we reached this point user selected ok and selected something if so required\r\n\r\n                // Loop through all items the ListBox.\r\n                for (int x = 0; x < listBox.Items.Count; x++)\r\n                {\r\n                    // Determine if the item is selected and add to the list.\r\n                    if (listBox.GetSelected(x) == true)\r\n                        selectedItems.Add(listBox.Items[x].ToString());\r\n                }\r\n\r\n            }\r\n            else\r\n            {\r\n                //if we reach this point is because\r\n                //skipDialogIfSingleItem && selectionList.Count == 1\r\n                selectedItems.Add(selectionList.First());\r\n\r\n            };\r\n\r\n\r\n\r\n            //return true that all went fine\r\n            return true;\r\n\r\n\r\n        }\r\n\r\n\r\n    }\r\n\r\n    public static class ListBoxUtils\r\n    {\r\n        public static bool OneOrMoreSelected(ListBox listBox)\r\n        {\r\n            for (int x = 0; x < listBox.Items.Count; x++)\r\n            {\r\n                // Determine if the item is selected.\r\n                if (listBox.GetSelected(x) == true)\r\n                    return true;\r\n            }\r\n            return false;\r\n        }\r\n    }\r\n\r\n    public static class MeasureUtils\r\n    {\r\n\r\n        public enum CreateMode\r\n        {\r\n            EnforceNewName,\r\n            DeleteAndCreate,\r\n            UseExisting\r\n        }\r\n        public static Measure CreateMeasure\r\n            (\r\n                Table baseTable,\r\n                string defaultMeasureName = \"New Measure\",\r\n                string measureExpression = \"\",\r\n                string formatString = \"\",\r\n                string measureNameLabel = \"Measure Name\",\r\n                string displayFolder = null,\r\n                CreateMode createMode = CreateMode.EnforceNewName,\r\n                bool allowCustomName = true\r\n\r\n            )\r\n        {\r\n            /*test*/\r\n            if (baseTable == null)\r\n            {\r\n                throw new ArgumentNullException();\r\n            }\r\n\r\n            Measure returnMeasure;\r\n\r\n            string userMeasureName;\r\n\r\n            StringUtils.CheckType check;\r\n\r\n            if (createMode.Equals(CreateMode.EnforceNewName))\r\n            {\r\n                check = StringUtils.CheckType.Measure;\r\n            }\r\n            else\r\n            {\r\n                check = StringUtils.CheckType.None;\r\n            };\r\n\r\n\r\n            if (allowCustomName)\r\n            {\r\n                //allow user to select name\r\n                if (\r\n                    !StringUtils.InitString(\r\n                        stringToInit: out userMeasureName,\r\n                        label: measureNameLabel,\r\n                        defaultValue: defaultMeasureName,\r\n                        checkType: check)) { return null; }\r\n            }\r\n            else\r\n            {\r\n                userMeasureName = defaultMeasureName;\r\n            }\r\n\r\n            returnMeasure =\r\n                GetMeasure(\r\n                    measureName: userMeasureName,\r\n                    model: baseTable.Model);\r\n\r\n            if (returnMeasure != null)\r\n            {\r\n                if (createMode.Equals(CreateMode.DeleteAndCreate))\r\n                {\r\n                    //delete the measure found, will be recreated in a sec below\r\n                    returnMeasure.Delete();\r\n                }\r\n                else if (createMode.Equals(CreateMode.UseExisting))\r\n                {\r\n                    //do not recreate anything, just return the measure found (process does not continue)\r\n                    return returnMeasure;\r\n                }\r\n                else\r\n                {\r\n                    new Exception(\"this should not happen\");\r\n                };\r\n            };\r\n\r\n            //we reach this point if it's a new measure, or we are deleting and recreating the measure\r\n            returnMeasure = baseTable.AddMeasure(name: userMeasureName, expression: measureExpression, displayFolder: displayFolder);\r\n            returnMeasure.FormatString = formatString;\r\n\r\n            return returnMeasure;\r\n\r\n        }\r\n        public static Measure GetMeasure(string measureName, Model model)\r\n        {\r\n            var matchingMeasures = model.AllMeasures.Where(x => x.Name == measureName);\r\n\r\n            if (matchingMeasures.Count() == 0)\r\n            {\r\n                return null;\r\n            }\r\n            else\r\n            {\r\n                return matchingMeasures.First();\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n\r\n    public static class TableUtils\r\n\r\n    {\r\n        public static int TableCount(Model model)\r\n        {\r\n            MessageBox.Show(model.Name);\r\n            return model.Tables.Count;\r\n        }\r\n\r\n        public static Table GetTable(string tableName, Model Model)\r\n        {\r\n            var tbls = Model.Tables.Where(x => x.Name == tableName);\r\n\r\n            if (tbls.Count() == 0)\r\n            {\r\n                return null;\r\n            }\r\n            else\r\n            {\r\n                return tbls.First();\r\n            }\r\n\r\n        }\r\n\r\n        public static bool CreateMeasureTable\r\n            (\r\n                out Table createdTable,\r\n                Model model,\r\n                string defaultTableName = \"Some Measures\",\r\n                string label = \"Measure Table Name\",\r\n                string prompt = \"Provide a name for the measure Table\"\r\n            )\r\n        {\r\n\r\n            createdTable = null;\r\n\r\n            if (model == null)\r\n            {\r\n                throw new ArgumentNullException();\r\n            };\r\n\r\n            string tableName;\r\n            if (\r\n                !StringUtils.InitString(\r\n                    stringToInit: out tableName,\r\n                    label: label, prompt: prompt,\r\n                    checkType: StringUtils.CheckType.Table,\r\n                    defaultValue: defaultTableName,\r\n                    model: model\r\n                )\r\n               ) return false;\r\n\r\n\r\n\r\n            string tableExpression = \"{0}\";\r\n\r\n            createdTable = model.AddCalculatedTable(name: tableName, expression: tableExpression);\r\n\r\n            return true;\r\n\r\n        }\r\n\r\n        public static Table CreateMeasureTable2\r\n            (\r\n                Model model,\r\n                string defaultTableName = \"Some Measures\",\r\n                string label = \"Measure Table Name\",\r\n                string prompt = \"Provide a name for the measure Table\"\r\n            )\r\n        {\r\n            if (model == null)\r\n            {\r\n                throw new ArgumentNullException();\r\n            }\r\n\r\n\r\n\r\n            return model.AddCalculatedTable(name: defaultTableName, expression: \"{0}\");\r\n\r\n        }\r\n\r\n\r\n    }\r\n\r\n    public static class CalculationGroupUtils\r\n    {\r\n\r\n        public enum CreateMode\r\n        {\r\n            EnforceNewName,\r\n            DeleteAndCreate,\r\n            UseExistingWithConfirmation,\r\n            UseExistingWithoutConfirmation\r\n        }\r\n\r\n\r\n        // \r\n        public static bool CreateCalculationGroup\r\n            (\r\n                out CalculationGroupTable myCalculationGroup,\r\n                Model model,\r\n                string defaultCalculationGroupName = \"myCalcGroup\",\r\n                string defaultCalculationGroupColumnName = \"myCalcItems\",\r\n                bool matchColumnAndCalculationGroupName = true,\r\n                string annotationName = \"ExtendedTOMWrapper\",\r\n                string annotationValue = \"Default Calculation Group\",\r\n                string prompt = \"Provide name for the calculation group\",\r\n                string columnPrompt = \"Provide a name for the column of the calculation group\",\r\n                string inputFieldLabel = \"Name\",\r\n                string calcGroupDescription = \"\"\r\n\r\n\r\n            )\r\n        {\r\n\r\n\r\n            string calcGroupName;\r\n            string calcGroupColumnName;\r\n\r\n            var ts = model.Tables.Where(x => x.GetAnnotation(annotationName) == annotationValue);\r\n\r\n            myCalculationGroup = null as CalculationGroupTable;\r\n\r\n            if (ts.Count() == 1)\r\n            {\r\n                myCalculationGroup = ts.First() as CalculationGroupTable;\r\n            }\r\n            else if (ts.Count() < 1)\r\n            {\r\n\r\n                if (\r\n                    !StringUtils.InitString(\r\n                        stringToInit: out calcGroupName,\r\n                        prompt: prompt,\r\n                        label: inputFieldLabel,\r\n                        defaultValue: defaultCalculationGroupName,\r\n                        checkType: StringUtils.CheckType.Table,\r\n                        model: model\r\n                    )\r\n                ) { return false; }\r\n\r\n                myCalculationGroup = model.AddCalculationGroup(calcGroupName);\r\n                myCalculationGroup.Description = calcGroupDescription;\r\n                myCalculationGroup.SetAnnotation(annotationName, annotationValue);\r\n\r\n\r\n                if (matchColumnAndCalculationGroupName)\r\n                {\r\n                    defaultCalculationGroupColumnName = calcGroupName;\r\n                }\r\n                else\r\n                {\r\n                    if (\r\n                        !StringUtils.InitString(\r\n                           stringToInit: out calcGroupColumnName,\r\n                           prompt: columnPrompt\r\n                        )\r\n                    ) { return false; };\r\n                };\r\n\r\n                model.Tables[calcGroupName].Columns[\"Name\"].Name = defaultCalculationGroupColumnName;\r\n\r\n            }\r\n            else\r\n            {\r\n                //this should never happen -- who needs two calc groups for time intelligence? \r\n                //myCalculationGroup = SelectTable(ts, label: \"Select your 'Measure Group' Calculation Group\") as CalculationGroupTable;\r\n                myCalculationGroup = ts.First() as CalculationGroupTable;\r\n            };\r\n\r\n            if (myCalculationGroup == null)\r\n            {\r\n\r\n                return false;\r\n            } // doesn't work in TE3 as cancel button doesn't return null in TE3\r\n\r\n            return true;\r\n\r\n        }\r\n\r\n\r\n        public enum GetByMode\r\n        {\r\n            ByName,\r\n            ByAnnotation\r\n        }\r\n\r\n        //2022-02-19 / B.Agullo / \r\n        public static bool GetCalculationGroup\r\n        //get reference to an existing calcualtion group (if found)\r\n            (\r\n                out CalculationGroupTable myCalculationGroup,\r\n                Model model,\r\n                string selectionPrompt = \"Select calculation group\",\r\n                bool filterByAnnotation = false,\r\n                string annotationName = null,\r\n                string annotationValue = null,\r\n                string calcGroupName = null,\r\n                bool skipIfOnlyOneMatches = true\r\n\r\n            )\r\n        {\r\n            if (model == null)\r\n            {\r\n                throw new ArgumentNullException();\r\n            }\r\n\r\n            myCalculationGroup = null;\r\n\r\n            if (model.CalculationGroups.Count() == 0) return false;\r\n\r\n            List<string> matchingCalcGroupNames = new List<string>();\r\n\r\n            List<string> selectedCalcGroupNames = new List<string>();\r\n\r\n            if (annotationName != null && annotationValue != null)\r\n            {\r\n                matchingCalcGroupNames =\r\n                    (List<string>)model.CalculationGroups\r\n                        .Where(x => x.GetAnnotation(annotationName) == annotationValue)\r\n                        .Select(x => x.Name).ToList();\r\n            }\r\n            else if (calcGroupName != null)\r\n            {\r\n                matchingCalcGroupNames =\r\n                    (List<string>)model.CalculationGroups\r\n                    .Where(x => x.Name == calcGroupName)\r\n                    .Select(x => x.Name).ToList();\r\n            }\r\n            else\r\n            {\r\n                matchingCalcGroupNames =\r\n                    model.CalculationGroups\r\n                        .Select(x => x.Name).ToList();\r\n            }\r\n\r\n\r\n\r\n\r\n            if (!MessageUtils.SelectFromList(selectionList: matchingCalcGroupNames,\r\n\r\n                selectedItems: out selectedCalcGroupNames\r\n                )) return false;\r\n\r\n\r\n            myCalculationGroup = model.CalculationGroups.Where(x => x.Name == matchingCalcGroupNames.First()).First();\r\n\r\n\r\n            return true;\r\n        }\r\n\r\n        public static bool CreateCalculationItem\r\n             (\r\n                out CalculationItem myCalcItem,\r\n                CalculationGroupTable cg,\r\n                string defaultCalculationItemName = \"New Calc Item\",\r\n                bool promptUser = false,\r\n                string prompt = \"Provide name for the calculation item\",\r\n                string inputFieldLabel = \"Name\",\r\n                string calcItemDescription = \"\",\r\n                string calcItemExpression = \"\",\r\n                bool regenerateIfPresent = true\r\n\r\n            )\r\n        {\r\n            myCalcItem = null as CalculationItem;\r\n            \r\n            if(calcItemExpression == String.Empty)\r\n            {\r\n                MessageUtils.ErrorMessage(\"No calc Item Expression provided.\");\r\n                return false;\r\n            };\r\n\r\n            string calcItemName;\r\n\r\n            if (promptUser)\r\n            {\r\n                if (\r\n                        !StringUtils.InitString\r\n                            (\r\n                                out calcItemName, \r\n                                label: \"Calculation Item Name\", \r\n                                defaultValue: defaultCalculationItemName,\r\n                                cg:cg,\r\n                                checkType: StringUtils.CheckType.CalculationItem,\r\n                                prompt: prompt,\r\n                                promptUser: promptUser\r\n                                \r\n                            )\r\n                ) return false; //the naming step didn't go well\r\n            }\r\n            else\r\n            {\r\n                calcItemName = defaultCalculationItemName;\r\n            }\r\n\r\n            if(cg.CalculationItems.Any(x=> x.Name == calcItemName))\r\n            {\r\n                if(regenerateIfPresent)\r\n                {\r\n                    cg.CalculationItems.Where(x => x.Name == calcItemName).First().Delete();\r\n                }\r\n                else\r\n                {\r\n                    return true; //all is good, nothing to do\r\n                }\r\n                \r\n            }\r\n            \r\n            CalculationItem calcItem = cg.AddCalculationItem(name: calcItemName, expression: calcItemExpression);\r\n            calcItem.Description = calcItemExpression;\r\n            calcItem.FormatDax();\r\n\r\n            return true;\r\n\r\n\r\n\r\n        }\r\n    }\r\n    \r\n        ",
      "Tooltip": "",
      "ValidContexts": "Relationship"
    },
    {
      "Id": 50,
      "Name": "8. Bernats Repo\\7. Other\\Refresh BPA Rules",
      "Enabled": "true",
      "Execute": "System.Net.WebClient w = new System.Net.WebClient(); \r\n\r\nstring path = System.Environment.GetFolderPath(System.Environment.SpecialFolder.LocalApplicationData);\r\nstring downloadLoc = path+@\"\\TabularEditor\\BPARules.json\";\r\nstring url = \"https://raw.githubusercontent.com/microsoft/Analysis-Services/master/BestPracticeRules/Spanish/BPARules.json\";\r\nstring dlMessage = \"Downloaded BPARules.json. Please restart Tabular Editor.\";\r\n\r\nif (System.IO.File.Exists(downloadLoc))\r\n{\r\n    if (System.Windows.Forms.MessageBox.Show(\"Would you like to overwrite the existing BPARules.json file?\",\"Overwrite Existing BPA Rules\",System.Windows.Forms.MessageBoxButtons.YesNo,System.Windows.Forms.MessageBoxIcon.Warning) == System.Windows.Forms.DialogResult.Yes)\r\n    {\r\n        w.DownloadFile(url, downloadLoc);\r\n        System.Windows.Forms.MessageBox.Show(dlMessage,\"Overwrite Existing BPA Rules\",System.Windows.Forms.MessageBoxButtons.OK,System.Windows.Forms.MessageBoxIcon.Information);\r\n    }\r\n    else\r\n    {\r\n        System.Windows.Forms.MessageBox.Show(\"Did not download BPARules.json.\",\"Overwrite Existing BPA Rules\",System.Windows.Forms.MessageBoxButtons.OK,System.Windows.Forms.MessageBoxIcon.Information);\r\n    }\r\n}\r\nelse\r\n{\r\n    System.Windows.Forms.MessageBox.Show(dlMessage,\"Download BPA Rules\",System.Windows.Forms.MessageBoxButtons.OK,System.Windows.Forms.MessageBoxIcon.Information);\r\n    w.DownloadFile(url, downloadLoc);\r\n}",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 51,
      "Name": "8. Bernats Repo\\1. Measure\\Add Total by Calc Item",
      "Enabled": "true",
      "Execute": "string calcGroupTypeLabel = \"CalcGroupType\";\r\nstring calcGroupTypeValue = \"MultiTotal\";\r\nIEnumerable<Table> multiTotalCalcGroups = \r\n    Model.Tables.Where(\r\n        t => \r\n        t.GetAnnotation(calcGroupTypeLabel) \r\n            == calcGroupTypeValue);\r\nTable calcGroupAsTable = null as Table; \r\nif(multiTotalCalcGroups.Count() == 0)\r\n{\r\n    Error(\"No multi-total calc group found. \" +\r\n        \"Run the macro to create a multi-total \" +\r\n        \"calc group first and try again\");\r\n    return;\r\n} else if(multiTotalCalcGroups.Count() == 1)\r\n{\r\n    calcGroupAsTable = multiTotalCalcGroups.First();\r\n}\r\nelse\r\n{\r\n    calcGroupAsTable = SelectTable(multiTotalCalcGroups, label: \"Select Multi-total Calc Group to use\");\r\n    if(calcGroupAsTable == null)\r\n    {\r\n        Error(\"You cancelled the execution.\");\r\n        return;\r\n    }\r\n}\r\nif(Selected.CalculationItems.Count() == 0)\r\n{\r\n    Error(\"Select one or more calculation items and try again.\");\r\n    return;\r\n}\r\nstring calcGroupValuesFieldLabel = \"ValuesField\";\r\nstring multiTotalBreakDownColumnCode = calcGroupAsTable.GetAnnotation(calcGroupValuesFieldLabel);\r\nCalculationGroupTable calcGroup = calcGroupAsTable as CalculationGroupTable;\r\nforeach(CalculationItem calcItem in Selected.CalculationItems)\r\n{\r\n    string calcItemName = calcItem.Name;\r\n    string calcItemExpression =\r\n        String.Format(\r\n            @\"IF(\r\n                NOT ISINSCOPE( {0} ),\r\n                CALCULATE(\r\n                    SELECTEDMEASURE( ),\r\n                    {1} = \"\"{2}\"\"\r\n                )\r\n            )\",\r\n            multiTotalBreakDownColumnCode,\r\n            calcItem.CalculationGroupTable.Columns[0].DaxObjectFullName,\r\n            calcItem.Name);\r\n    CalculationItem customTotalCalcItem = \r\n        calcGroup.AddCalculationItem(\r\n            name:calcItemName, \r\n            expression:calcItemExpression);\r\n    string calcItemFormatStringExpression =\r\n        String.Format(\r\n            @\"IF(\r\n                NOT ISINSCOPE( {0} ),\r\n                CALCULATE(\r\n                    SELECTEDMEASUREFORMATSTRING( ),\r\n                    {1} = \"\"{2}\"\"\r\n                )\r\n            )\",\r\n            multiTotalBreakDownColumnCode,\r\n            calcItem.CalculationGroupTable.Columns[0].DaxObjectFullName,\r\n            calcItem.Name);\r\n    customTotalCalcItem.FormatStringExpression = \r\n        calcItemFormatStringExpression;\r\n    customTotalCalcItem.FormatDax();\r\n}\r\n",
      "Tooltip": "requires the existence of a Multi-total Calc Group",
      "ValidContexts": "CalculationItem"
    },
    {
      "Id": 52,
      "Name": "8. Bernats Repo\\1. Measure\\Add Total by Calc Item (NAMASDATA)",
      "Enabled": "true",
      "Execute": "string annotationLabel = \"Namasdata\";\r\nstring annotationValue = \"Totales\";\r\nstring sliceColumnLabel = \"sliceColumn\";\r\nif (Selected.CalculationItems.Count() == 0)\r\n{\r\n    Error(\"Selecciona al menos un elemento de cálculo\");\r\n    return;\r\n}\r\nif (!Model.Tables.Any(t => t.GetAnnotation(annotationLabel) == annotationValue))\r\n{\r\n    Error(\"Ejecuta primero la macro de crear Grupo de cálculo de Totales\");\r\n    return;\r\n}\r\nCalculationGroupTable totalsCG = Model.Tables.Where(t => t.GetAnnotation(annotationLabel) == annotationValue).First() as CalculationGroupTable;\r\nstring sliceColumn = totalsCG.GetAnnotation(sliceColumnLabel);\r\nforeach(CalculationItem cItem in Selected.CalculationItems)\r\n{\r\n    Column cItemColumn = cItem.CalculationGroupTable.Columns[0];\r\n    string calcItemName = cItem.Name;\r\n    string calcItemExpression =\r\n        String.Format(\r\n            @\"IF(\r\n                ISINSCOPE({0}),\r\n                BLANK(),\r\n                CALCULATE(\r\n                    SELECTEDMEASURE(),\r\n                    {1} = \"\"{2}\"\"\r\n                )\r\n            )\", sliceColumn, cItemColumn.DaxObjectFullName, cItem.Name);\r\n    CalculationItem calcItem = totalsCG.AddCalculationItem(calcItemName, calcItemExpression);\r\n    calcItem.FormatDax();\r\n}\r\n",
      "Tooltip": "",
      "ValidContexts": "CalculationItem"
    },
    {
      "Id": 53,
      "Name": "8. Bernats Repo\\3. Calc Group\\Add Totals Calc Group",
      "Enabled": "true",
      "Execute": "string annotationLabel = \"Namasdata\";\r\nstring annotationValue = \"Totales\";\r\nstring sliceColumnLabel = \"sliceColumn\";\r\nif (Selected.Columns.Count() != 1)\r\n{\r\n    Error(\"Selecciona una única columna y vuelve a intentarlo\");\r\n    return;\r\n}\r\nColumn sliceColumn = Selected.Column;\r\nstring sliceColumnValue = sliceColumn.DaxObjectFullName;\r\nCalculationGroupTable totalsCG = null as CalculationGroupTable;\r\nif (Model.Tables.Any(t => t.GetAnnotation(annotationLabel) == annotationValue))\r\n{\r\n    totalsCG = Model.Tables.Where(t => t.GetAnnotation(annotationLabel) == annotationValue).First() as CalculationGroupTable;\r\n}\r\nelse\r\n{\r\n    totalsCG = Model.AddCalculationGroup(\"Totals\");\r\n    totalsCG.SetAnnotation(annotationLabel, annotationValue);\r\n    totalsCG.SetAnnotation(sliceColumnLabel, sliceColumnValue);\r\n}\r\nstring valuesCalcItemName = \"Values\";\r\nstring valuesCalcItemExpression =\r\n    String.Format(\r\n    @\"IF(\r\n        ISINSCOPE({0}),\r\n        SELECTEDMEASURE(),\r\n        BLANK()\r\n    )\", sliceColumn.DaxObjectFullName);\r\nCalculationItem valuesCalcItem = totalsCG.AddCalculationItem(valuesCalcItemName, valuesCalcItemExpression);\r\nstring totalCalcItemName = \"Total\";\r\nstring totalCalcItemExpression =\r\n    String.Format(\r\n    @\"IF(\r\n        ISINSCOPE({0}),\r\n        BLANK(),\r\n        SELECTEDMEASURE()\r\n    )\", sliceColumn.DaxObjectFullName);\r\nCalculationItem totalCalcItem = totalsCG.AddCalculationItem(totalCalcItemName, totalCalcItemExpression);\r\n",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 54,
      "Name": "8. Bernats Repo\\4. Check\\Alert Summary Measures",
      "Enabled": "true",
      "Execute": "/* \r\n//2022-06-29 B.Agullo \r\n//\r\n// BLOG POST on the actual use case and how to use it\r\n// https://www.esbrina-ba.com/data-validation-with-power-bi/\r\n//\r\n//Selecting a table will select the table for the overall summary measures.\r\n//The script will go through all the tables of the model and \r\n//for each table if will scan the measures contained in the display folder that starts with \"Checks \" \r\n// and will generate a new display folder in the same table\r\n//called \"Titles \" followed by the original display folder name\r\n//where all measures original measures will have an equivalent measure\r\n//with the expression [original measure] & Original measure name\r\n//also another displayfolder called \"summary measures\" \r\n//will contain 2 measures. One is the sum of all selected measures \r\n//the other one is the concatenation of all the titles measures\r\n//Useful when setting alarms when one measure is greater than 0\r\n//on the original selected table it will store the sum of all the summary measures of the model\r\n//read the blog post for a more clear idea of how to use it.\r\n*/\r\n\r\n/*customize if needed*/\r\nstring dynamicMeasureCustomActionName = \"Dynamic Measure\"; \r\n\r\nstring alertDisplayFolderPrefix = \"Checks \";\r\nstring allMeasuresPrefix = \"Alerts Value \";\r\nstring allTitleMeasuresPrefix = \"Alerts Descriptions \";\r\nstring allMeasureCountPrefix = \"Alert Count \"; \r\n\r\nstring summaryMeasuresDisplayFolder = \"Summary Measures\";\r\nstring titleMeasuresPrefix = \"Title \";\r\nstring titleMeasuresDisplayFolderPrefix = \"Titles of \";\r\n\r\n\r\n\r\nstring overallAlertValueMeasureName = \"Total Alerts Value\";\r\nstring overallAlertDescMeasureName = \"Total Alerts Description\";\r\nstring overallAlertCountMeasureName = \"Total Alert Count\"; \r\n\r\n\r\n/*do not modify below this line*/\r\n\r\n\r\n\r\nstring annotationKey = \"@AgulloBernat\";\r\nstring annotationValue = \"Alert Summary Sum Measure\";\r\nstring annotationValueDesc = \"Alert Description Concat Measure\";\r\nstring annotationValueCount = \"Alert Count Measure\";\r\n\r\n\r\nif(Selected.Tables.Count() != 1)\r\n{\r\n    Error(\"Select a table for overall alert measures and try again.\");\r\n    return;\r\n}\r\n\r\n//create calculation group without any calc items\r\nModel.CustomAction(dynamicMeasureCustomActionName); \r\n\r\n/* go through each table ... */\r\nforeach (Table t in Model.Tables)\r\n{\r\n\r\n    string displayFolderName = \"\";\r\n    string titleMeasuresDisplayFolderName = \"\";\r\n    string allMeasureExpression = \"\";\r\n    string allMeasureName = \"\";\r\n    string allTitleMeasureExpression = \"\\\"\\\"\";\r\n    string allTitleMeasureName = \"\";\r\n    string allMeasureCountExpression = \"\";\r\n    string allMeasureCountName = \"\"; \r\n\r\n\r\n    /*check if there's any measure to process*/\r\n    List<Measure> alertMeasures = new List<Measure>();\r\n    foreach (Measure m in t.Measures)\r\n    {\r\n        if (m.DisplayFolder.Length >= alertDisplayFolderPrefix.Length)\r\n        {\r\n            if( m.DisplayFolder.Substring(0, alertDisplayFolderPrefix.Length) == alertDisplayFolderPrefix)\r\n            {\r\n\r\n                alertMeasures.Add(m);\r\n            }\r\n        }\r\n    }\r\n\r\n    /* if any was found */\r\n    if (alertMeasures.Count() > 0) { \r\n\r\n        /*for each measure found, process it */\r\n        foreach (Measure m in alertMeasures) { \r\n\r\n            if (displayFolderName == \"\")\r\n            {\r\n                displayFolderName = m.DisplayFolder;\r\n                titleMeasuresDisplayFolderName = titleMeasuresDisplayFolderPrefix + displayFolderName;\r\n            };\r\n\r\n            string titleMeasureName = titleMeasuresPrefix + m.Name;\r\n            string titleMeasureExpression = m.DaxObjectName + \" & \\\" \" + m.Name + \"\\\"\";\r\n\r\n            foreach (Measure delM in Model.AllMeasures.Where(x => x.Name == titleMeasureName).ToList())\r\n            {\r\n                delM.Delete();\r\n            };\r\n\r\n            Measure titleM = m.Table.AddMeasure(\r\n                name: titleMeasureName,\r\n                expression: titleMeasureExpression,\r\n                displayFolder: titleMeasuresDisplayFolderName\r\n            );\r\n            \r\n            titleM.FormatDax();\r\n\r\n            allMeasureExpression = allMeasureExpression + Environment.NewLine + \" + \" + m.DaxObjectName;\r\n\r\n            allTitleMeasureExpression =\r\n                allTitleMeasureExpression\r\n                    + \" & IF(\" + m.DaxObjectFullName + \"> 0,\"\r\n                    + titleM.DaxObjectFullName + \" & UNICHAR(10))\";\r\n                    \r\n            //m.CustomAction(\"Dynamic Measure\");\r\n            \r\n            allMeasureCountExpression = \r\n                allMeasureCountExpression \r\n                + Environment.NewLine + \" + IF(\" + m.DaxObjectFullName + \"> 0, 1)\";\r\n                \r\n        };\r\n\r\n        /*now create the summary measures for that table*/\r\n        allMeasureName = allMeasuresPrefix + t.Name;\r\n        allTitleMeasureName = allTitleMeasuresPrefix + t.Name;\r\n        allMeasureCountName = allMeasureCountPrefix + t.Name;\r\n\r\n        foreach (Measure delM in Model.AllMeasures.Where(x => x.Name == allMeasureName).ToList())\r\n        {\r\n            delM.Delete();\r\n        };\r\n\r\n        foreach (Measure delM in Model.AllMeasures.Where(x => x.Name == allTitleMeasureName).ToList())\r\n        {\r\n            delM.Delete();\r\n        };\r\n        \r\n        foreach (Measure delM in Model.AllMeasures.Where(x => x.Name == allMeasureCountName).ToList())\r\n        {\r\n            delM.Delete();\r\n        };\r\n\r\n        Measure measure =\r\n            t.AddMeasure(\r\n                name: allMeasureName,\r\n                expression: allMeasureExpression,\r\n                displayFolder: summaryMeasuresDisplayFolder);\r\n\r\n        measure.SetAnnotation(annotationKey, annotationValue);\r\n        measure.FormatString = \"#,##0\";\r\n        measure.FormatDax();\r\n        measure.CustomAction(dynamicMeasureCustomActionName);\r\n        \r\n        Measure titleMeasure =\r\n            t.AddMeasure(\r\n                name: allTitleMeasureName,\r\n                expression: allTitleMeasureExpression,\r\n                displayFolder: summaryMeasuresDisplayFolder);\r\n\r\n        titleMeasure.SetAnnotation(annotationKey, annotationValueDesc);\r\n        titleMeasure.FormatDax(); \r\n        titleMeasure.CustomAction(dynamicMeasureCustomActionName); \r\n        \r\n        Measure countMeasure =\r\n            t.AddMeasure(\r\n                name: allMeasureCountName,\r\n                expression: allMeasureCountExpression,\r\n                displayFolder: summaryMeasuresDisplayFolder);\r\n\r\n        countMeasure.SetAnnotation(annotationKey, annotationValueCount);\r\n        countMeasure.FormatDax(); \r\n        countMeasure.CustomAction(dynamicMeasureCustomActionName); \r\n        \r\n    }\r\n}\r\n\r\n\r\n/*once we processed all tables, time to create overall summary measures*/\r\n/*clean up*/\r\nif (Model.AllMeasures.Any(x => x.Name == overallAlertValueMeasureName))\r\n{\r\n    Model.AllMeasures.Where(\r\n        x => x.Name == overallAlertValueMeasureName\r\n        ).First().Delete();\r\n\r\n}\r\n\r\nif (Model.AllMeasures.Any(\r\n    x => x.Name == overallAlertDescMeasureName))\r\n{\r\n    Model.AllMeasures.Where(\r\n        x => x.Name == overallAlertDescMeasureName\r\n        ).First().Delete();\r\n\r\n}\r\n\r\nif (Model.AllMeasures.Any(\r\n    x => x.Name == overallAlertCountMeasureName))\r\n{\r\n    Model.AllMeasures.Where(\r\n        x => x.Name == overallAlertCountMeasureName\r\n        ).First().Delete();\r\n\r\n}\r\n\r\n\r\n/*regenerate if necessary*/\r\nif (Model.AllMeasures.Any(\r\n    x => x.DisplayFolder.IndexOf(summaryMeasuresDisplayFolder) == 0\r\n           & x.Name.IndexOf(allMeasuresPrefix) == 0))\r\n{\r\n\r\n    string overallAlertValueMeasureExpression = \"\";\r\n    string overallAlertDescMeasureExpression = \"\\\"\\\"\";\r\n    string overallAlertCountMeasureExpression = \"\";\r\n\r\n    foreach (Measure m in\r\n        Model.AllMeasures.Where(\r\n            x => x.DisplayFolder.IndexOf(summaryMeasuresDisplayFolder) == 0\r\n                & x.Name.IndexOf(allMeasuresPrefix) == 0))\r\n    {\r\n\r\n\r\n        overallAlertValueMeasureExpression =\r\n            overallAlertValueMeasureExpression\r\n                + \" + \" + m.DaxObjectFullName;\r\n\r\n    }\r\n\r\n    foreach (Measure m in\r\n         Model.AllMeasures.Where(\r\n             x => x.DisplayFolder.IndexOf(summaryMeasuresDisplayFolder) == 0\r\n                 & x.Name.IndexOf(allTitleMeasuresPrefix) == 0))\r\n    {\r\n        overallAlertDescMeasureExpression =\r\n            overallAlertDescMeasureExpression\r\n                + \" & IF(LEN(\" +m.DaxObjectFullName +\")>0, UNICHAR(10) & UNICHAR(10) & \\\"********** \" \r\n                    + m.Table.Name + \"*********\\\" & UNICHAR(10) & \" +  m.DaxObjectFullName + \")\";\r\n\r\n    }\r\n\r\n\r\n\r\n    foreach (Measure m in\r\n         Model.AllMeasures.Where(\r\n             x => x.DisplayFolder.IndexOf(summaryMeasuresDisplayFolder) == 0\r\n                 & x.Name.IndexOf(allMeasureCountPrefix) == 0))\r\n    {\r\n        overallAlertCountMeasureExpression =\r\n            overallAlertCountMeasureExpression\r\n                + \" + \" + m.DaxObjectFullName;\r\n\r\n    }\r\n\r\n\r\n    Measure alertValueMeasure = Selected.Table.AddMeasure(overallAlertValueMeasureName, overallAlertValueMeasureExpression);\r\n    alertValueMeasure.FormatDax();\r\n    alertValueMeasure.FormatString =\"#,##0\";\r\n\r\n    Measure alertDescMeasure = Selected.Table.AddMeasure(overallAlertDescMeasureName, overallAlertDescMeasureExpression);\r\n    alertDescMeasure.FormatDax();\r\n\r\n    Measure alertCountMeasure =  Selected.Table.AddMeasure(overallAlertCountMeasureName, overallAlertCountMeasureExpression);\r\n    alertCountMeasure.FormatDax();\r\n    alertCountMeasure.FormatString =\"#,##0\";\r\n\r\n\r\n};",
      "Tooltip": "",
      "ValidContexts": "Table"
    },
    {
      "Id": 55,
      "Name": "8. Bernats Repo\\1. Measure\\Avg by Custom Column",
      "Enabled": "true",
      "Execute": "if(Selected.Measures.Count() == 0)\r\n{\r\n    Error(\"You need to select at least one measure.\");\r\n    return;\r\n};\r\nTable table = SelectTable(label: \"Select a table\");\r\nif(table == null)\r\n{\r\n    Error(\"You cancelled\");\r\n    return;\r\n};\r\nColumn column = SelectColumn(table);\r\nif (column == null)\r\n{\r\n    Error(\"You cancelled\");\r\n    return;\r\n};\r\nforeach(Measure measure in Selected.Measures)\r\n{\r\n    string measureName = \"Avg \" + measure.Name + \" by \" + column.Name;\r\n    string measureExpression = String.Format(@\"AVERAGEX(  VALUES({0}),  {1})\", column.DaxObjectFullName, measure.DaxObjectFullName);\r\n    string measureDisplayFolder = \"Avgs of \" + measure.Name;\r\n    string measureDescription = measureName;\r\n    Measure newMeasure = measure.Table.AddMeasure(measureName, measureExpression,displayFolder:measureDisplayFolder);\r\n    newMeasure.Description = measureDescription;\r\n    newMeasure.FormatDax();\r\n}\r\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 56,
      "Name": "8. Bernats Repo\\3. Calc Group\\Create comparison Calc Group",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing System.Windows.Forms;\r\n\r\nusing Microsoft.VisualBasic;\r\nstring calcGroupName = Fx.GetNameFromUser(\"Input name\",DefaultResponse: \"Model\");\r\nstring selectedCalcItemName = Fx.GetNameFromUser(\"Input name\", DefaultResponse: \"Selected\");\r\nstring referenceCalcItemName =  Fx.GetNameFromUser(\"Input name\", DefaultResponse: \"Reference\");\r\nstring comparisonCalcItemName =  Fx.GetNameFromUser(\"Input name\", DefaultResponse: \"Comparison\");\r\nstring comparisonPctCalcItemName =  Fx.GetNameFromUser(\"Input name\", DefaultResponse: \"Comparison %\");\r\nstring daysMeasureName =  Fx.GetNameFromUser(\"Input name\", DefaultResponse: \"Days Selected\");\r\nstring referenceDaysRawMeasureName =  Fx.GetNameFromUser(\"Input name\", DefaultResponse: \"Days Reference Raw\");\r\nstring referenceDaysMeasureName =  Fx.GetNameFromUser(\"Input name\", DefaultResponse: \"Days Reference\");\r\nstring daysDifferenceMeasureName =  Fx.GetNameFromUser(\"Input name\", DefaultResponse: \"Days Difference\");\r\nIEnumerable<Table> dateTables = Fx.GetDateTables(Model);\r\nif (dateTables == null) return;\r\nif (dateTables.Count() < 2)\r\n{\r\n    Error(\"Less than 2 date tables detected in your model. A minimum of 2 date tables (marked as date tables) are required to run this script\");\r\n    return;\r\n}\r\nTable dateTable = SelectTable(tables: dateTables, preselect: dateTables.First(), label: \"Select main date table\");\r\nif (dateTable == null)\r\n{\r\n    Error(\"No table selected.\");\r\n    return;\r\n}\r\nFunc<Column, bool> weekColFunc = c => c.Name.Contains(\"Week\") || c.Name.Contains(\"Semana\");\r\nIEnumerable<Column> dayOfWeekColumns = Fx.GetFilteredColumns(dateTable.Columns, weekColFunc);\r\n//IEnumerable <Column> dayOfWeekColumns = null as IEnumerable<Column>;\r\n//if (dateTable.Columns.Any(c => c.Name.Contains(\"Week\") || c.Name.Contains(\"Semana\")))\r\n//{\r\n//    dayOfWeekColumns = dateTable.Columns.Where(c => c.Name.Contains(\"Week\") || c.Name.Contains(\"Semana\"));\r\n//}\r\n//else\r\n//{\r\n//    dayOfWeekColumns = dateTable.Columns;\r\n//}\r\nColumn dayOfWeekColumn = SelectColumn(dayOfWeekColumns, dayOfWeekColumns.First(), label: \"Select Day of Week column\");\r\nif (dayOfWeekColumn == null) { Error(\"No column selected\"); return; }\r\nTable referenceDateTable = SelectTable(tables: dateTables, preselect: dateTables.Last(), label: \"Select reference date table\");\r\nif (referenceDateTable == null)\r\n{\r\n    Error(\"No table selected.\");\r\n    return;\r\n}\r\nIEnumerable<Column> referenceDayOfWeekColumns = Fx.GetFilteredColumns(referenceDateTable.Columns, weekColFunc);\r\nColumn referenceDayOfWeekColumn = SelectColumn(referenceDayOfWeekColumns, referenceDayOfWeekColumns.First(), label: \"Select Day of Week column of reference Date Table\");\r\nif (referenceDayOfWeekColumn == null) { Error(\"No column selected\"); return; }\r\nCalculationGroupTable calcGroup = Model.AddCalculationGroup(calcGroupName);\r\nColumn calcGroupColumn = calcGroup.Columns[0];\r\ncalcGroupColumn.Name = calcGroup.Name;\r\nstring selectedCalcItemExpression =\r\n    String.Format(\r\n        @\"CALCULATE(\r\n            SELECTEDMEASURE( ),\r\n            REMOVEFILTERS( {0} )\r\n        )\",\r\n        referenceDateTable.DaxObjectFullName);\r\nCalculationItem selectedCalcItem = calcGroup.AddCalculationItem(selectedCalcItemName, selectedCalcItemExpression);\r\nselectedCalcItem.FormatDax();\r\nselectedCalcItem.Ordinal = 0;\r\nstring referenceCalcItemExpression =\r\n    String.Format(\r\n        @\"CALCULATE(\r\n            CALCULATE( SELECTEDMEASURE( ), REMOVEFILTERS( {0} ) ),\r\n            TREATAS(\r\n                VALUES( {1} ),\r\n                {2}\r\n            )\r\n        )\",\r\n        dateTable.DaxObjectFullName,\r\n        dayOfWeekColumn.DaxObjectFullName,\r\n        referenceDayOfWeekColumn.DaxObjectFullName\r\n     );\r\nCalculationItem referenceCalcItem = calcGroup.AddCalculationItem(referenceCalcItemName, referenceCalcItemExpression);\r\nreferenceCalcItem.FormatDax();\r\nreferenceCalcItem.Ordinal = 1;\r\nstring comparisonCalcItemExpression =\r\n    String.Format(\r\n        @\"VAR _selection =\r\n            CALCULATE(\r\n                SELECTEDMEASURE( ),\r\n                REMOVEFILTERS( {0} )\r\n            )\r\n        VAR _refrence =\r\n            CALCULATE(\r\n                CALCULATE( SELECTEDMEASURE( ),REMOVEFILTERS( {1} )),\r\n                TREATAS(\r\n                    VALUES( {2} ),\r\n                    {3}\r\n                )\r\n            )\r\n        VAR _result =\r\n            IF(\r\n                ISBLANK( _selection ) || ISBLANK( _refrence ),\r\n                BLANK( ),\r\n                _selection - _refrence\r\n            )\r\n        RETURN\r\n            _result\",\r\n        referenceDateTable.DaxObjectFullName,\r\n        dateTable.DaxObjectFullName,\r\n        dayOfWeekColumn.DaxObjectFullName,\r\n        referenceDayOfWeekColumn.DaxObjectFullName);\r\nstring comparisonCalcItemFormatStringExpression =\r\n    @\"VAR _fs = SELECTEDMEASUREFORMATSTRING()\r\n    RETURN \"\"+\"\" & _fs & \"\";-\"\" & _fs & \"\";-\"\" \";\r\nCalculationItem comparisonCalcItem = calcGroup.AddCalculationItem(comparisonCalcItemName, comparisonCalcItemExpression);\r\ncomparisonCalcItem.FormatStringExpression = comparisonCalcItemFormatStringExpression;\r\ncomparisonCalcItem.FormatDax();\r\ncomparisonCalcItem.Ordinal = 2;\r\nstring comparisonPctCalcItemExpression =\r\n    String.Format(\r\n        @\"VAR _selection =\r\n            CALCULATE(\r\n                SELECTEDMEASURE( ),\r\n                REMOVEFILTERS( {0} )\r\n            )\r\n        VAR _refrence =\r\n            CALCULATE(\r\n                CALCULATE( SELECTEDMEASURE( ),REMOVEFILTERS( {1} ) ),\r\n                TREATAS(\r\n                    VALUES( {2} ),\r\n                    {3}\r\n                )\r\n            )\r\n        VAR _result =\r\n            IF(\r\n                ISBLANK( _selection ) || ISBLANK( _refrence ),\r\n                BLANK( ),\r\n                DIVIDE( _selection - _refrence, _refrence )\r\n            )\r\n        RETURN\r\n            _result\",\r\n        referenceDateTable.DaxObjectFullName,\r\n        dateTable.DaxObjectFullName,\r\n        dayOfWeekColumn.DaxObjectFullName,\r\n        referenceDayOfWeekColumn.DaxObjectFullName);\r\nstring comparisonPctCalcItemFormatStringExpression = @\"\"\"+0 %;-0 %;-\"\"\";\r\nCalculationItem comparisonPctCalcItem = calcGroup.AddCalculationItem(comparisonPctCalcItemName, comparisonPctCalcItemExpression);\r\ncomparisonPctCalcItem.FormatStringExpression = comparisonPctCalcItemFormatStringExpression;\r\ncomparisonPctCalcItem.FormatDax();\r\ncomparisonPctCalcItem.Ordinal = 3;\r\nstring daysMeasureExpression =\r\n    String.Format(\r\n        @\"COUNTROWS({0})\",\r\n        dateTable.DaxObjectFullName);\r\nMeasure daysMeasure = dateTable.AddMeasure(name: daysMeasureName, expression: daysMeasureExpression);\r\ndaysMeasure.FormatString = @\"\"\"0\"\"\"; \r\ndaysMeasure.FormatDax();\r\nstring referenceDaysRawMeasureExpression =\r\n    String.Format(\r\n        @\"COUNTROWS({0})\",\r\n        referenceDateTable.DaxObjectFullName);\r\nMeasure referenceDaysRawMeasure = referenceDateTable.AddMeasure(name: referenceDaysRawMeasureName, expression: referenceDaysRawMeasureExpression);\r\nreferenceDaysRawMeasure.FormatString = @\"\"\"0\"\"\";\r\nreferenceDaysRawMeasure.FormatDax();\r\nstring referenceDaysMeasureExpression =\r\n    String.Format(\r\n        @\"CALCULATE({0},{1}=\"\"{2}\"\")\",\r\n        referenceDaysRawMeasure.DaxObjectFullName,\r\n        calcGroupColumn.DaxObjectFullName,\r\n        referenceCalcItem.Name);\r\nMeasure referenceDaysMeasure = referenceDateTable.AddMeasure(name: referenceDaysMeasureName, expression: referenceDaysMeasureExpression);\r\nreferenceDaysMeasure.FormatDax();\r\nstring daysDifferenceMeasureExpression =\r\n    String.Format(\r\n        @\"{0} - {1}\",\r\n        daysMeasure.DaxObjectFullName,\r\n        referenceDaysMeasure.DaxObjectFullName);\r\nMeasure differenceDaysMeasure = referenceDateTable.AddMeasure(name: daysDifferenceMeasureName, expression: daysDifferenceMeasureExpression);\r\ndifferenceDaysMeasure.FormatDax();\r\ndifferenceDaysMeasure.FormatString = @\"\"\"0\"\"\";\r\n\r\npublic static class Fx\r\n{\r\n    public static IEnumerable<Table> GetDateTables(Model model)\r\n    {\r\n        IEnumerable<Table> dateTables = null as IEnumerable<Table>;\r\n        if (model.Tables.Any(t => t.DataCategory == \"Time\" && t.Columns.Any(c => c.IsKey == true)))\r\n        {\r\n            dateTables = model.Tables.Where(t => t.DataCategory == \"Time\" && t.Columns.Any(c => c.IsKey == true && c.DataType == DataType.DateTime));\r\n        }\r\n        else\r\n        {\r\n            Error(\"No date table detected in the model. Please mark your date table(s) as date table\");\r\n        }\r\n        return dateTables;\r\n    }\r\n    public static Table GetTablesWithAnnotation(IEnumerable<Table> tables, string annotationLabel, string annotationValue)\r\n    {\r\n        Func<Table, bool> lambda = t => t.GetAnnotation(annotationLabel) == annotationValue;\r\n        IEnumerable<Table> matchTables = GetFilteredTables(tables, lambda);\r\n        if(matchTables == null)\r\n        {\r\n            return null;\r\n        }\r\n        else\r\n        {\r\n            return matchTables.First();\r\n        }\r\n    }\r\n    public static IEnumerable<Table> GetFilteredTables(IEnumerable<Table> tables, Func<Table,bool> lambda)\r\n    {\r\n        if (tables.Any(t => lambda(t)))\r\n        {\r\n            return tables.Where(t => lambda(t));\r\n        }\r\n        else\r\n        {\r\n            return null as IEnumerable<Table>; \r\n        }\r\n    }\r\n    public static IEnumerable<Column> GetFilteredColumns(IEnumerable<Column> columns, Func<Column,bool> lambda, bool returnAllIfNoneFound = true) \r\n    {\r\n        if (columns.Any(c => lambda(c)))\r\n        {\r\n            return columns.Where(c => lambda(c));\r\n        }\r\n        else\r\n        {\r\n            if(returnAllIfNoneFound)\r\n            {\r\n                return columns;\r\n            }\r\n            else\r\n            {\r\n                return null as IEnumerable<Column>;\r\n            }\r\n        }\r\n    }\r\n    public static Table CreateCalcTable(Model model, string tableName, string tableExpression)\r\n    {\r\n        if(!model.Tables.Any(t => t.Name == tableName))\r\n        {\r\n            return model.AddCalculatedTable(tableName, tableExpression);\r\n        }\r\n        else\r\n        {\r\n            return model.Tables.Where(t => t.Name == tableName).First();\r\n        }\r\n    }\r\n    public static string GetNameFromUser(string Prompt, string Title =\"\", string DefaultResponse = \"\")\r\n    {    \r\n        string response = Interaction.InputBox(Prompt, Title, DefaultResponse, 740, 400);\r\n        return response;\r\n    }\r\n    public static string ChooseString(IList<string> OptionList)\r\n    {\r\n        Func<IList<string>, string, string> SelectString = (IList<string> options, string title) =>\r\n        {\r\n            var form = new Form();\r\n            form.Text = title;\r\n            var buttonPanel = new Panel();\r\n            buttonPanel.Dock = DockStyle.Bottom;\r\n            buttonPanel.Height = 30;\r\n            var okButton = new Button() { DialogResult = DialogResult.OK, Text = \"OK\" };\r\n            var cancelButton = new Button() { DialogResult = DialogResult.Cancel, Text = \"Cancel\", Left = 80 };\r\n            var listbox = new ListBox();\r\n            listbox.Dock = DockStyle.Fill;\r\n            listbox.Items.AddRange(options.ToArray());\r\n            listbox.SelectedItem = options[0];\r\n            form.Controls.Add(listbox);\r\n            form.Controls.Add(buttonPanel);\r\n            buttonPanel.Controls.Add(okButton);\r\n            buttonPanel.Controls.Add(cancelButton);\r\n            var result = form.ShowDialog();\r\n            if (result == DialogResult.Cancel) return null;\r\n            return listbox.SelectedItem.ToString();\r\n        };\r\n        //let the user select the name of the macro to copy\r\n        String select = SelectString(OptionList, \"Choose a macro\");\r\n        //check that indeed one macro was selected\r\n        if (select == null)\r\n        {\r\n            Info(\"You cancelled!\");\r\n        }\r\n        return select;\r\n    }\r\n}\r\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 57,
      "Name": "8. Bernats Repo\\1. Measure\\Create Measures From Calc Group",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic; \r\nusing System.Windows.Forms;\r\n\r\n/* '2022-06-13 / B.Agullo / */\r\n/* '2022-09-17 / B.Agullo / possibility to create a Field Parameter with a column for the base measure & calc Item\r\n/* CREATE MEASURES WITH BASE MEASURES AND A CALCULATION GROUP */ \r\n\r\n/* See: https://www.esbrina-ba.com/creating-well-formatted-measures-based-on-a-calculation-group/  */\r\n/* See: https://www.esbrina-ba.com/a-dynamic-legend-for-a-dynamic-measure-time-intel-chart/\r\n/* select measures and execute, you will need to run it twice */ \r\n/* first time to create aux calc group, second time to actually create measuree*/ \r\n/* remove aux calc group before going to production, do the right thing */ \r\n\r\nstring auxCgTag = \"@AgulloBernat\";\r\nstring auxCgTagValue = \"CG to extract format strings\";\r\n\r\nstring auxCalcGroupName = \"DELETE AUX CALC GROUP\";\r\nstring auxCalcItemName = \"Get Format String\";\r\n\r\nstring baseMeasureAnnotationName = \"Base Measure\"; \r\nstring calcItemAnnotationName = \"Calc Item\"; \r\nstring calcItemSortOrderName = \"Sort Order\";\r\nstring calcItemSortOrderValue = String.Empty;  \r\n\r\nstring scriptAnnotationName = \"Script\";\r\nstring scriptAnnotationValue = \"Create Measures with a Calculation Group\"; \r\n\r\nbool generateFieldParameter;\r\n\r\nDialogResult dialogResult = MessageBox.Show(\"Generate Field Parameter?\", \"Field Parameter\", MessageBoxButtons.YesNo);\r\ngenerateFieldParameter = (dialogResult == DialogResult.Yes);\r\n\r\n\r\n/*find any regular CGs (excluding the one we might have created)*/\r\nvar regularCGs = Model.Tables.Where(\r\n    x => x.ObjectType == ObjectType.CalculationGroupTable\r\n    & x.GetAnnotation(auxCgTag) != auxCgTagValue);\r\n\r\nif (regularCGs.Count() == 0)\r\n{\r\n    Error(\"No Calculation Groups Found\");\r\n    return;\r\n};\r\n\r\n/*check if we already created the auxiliary calculation group*/\r\nvar auxCgs = Model.Tables.Where(x => x.GetAnnotation(auxCgTag) == auxCgTagValue);\r\n\r\nCalculationGroupTable auxCg = null as CalculationGroupTable; \r\n\r\n/*if there are more than one for some reason we'll just use the first one*/\r\nif(auxCgs.Count() >= 1)\r\n{\r\n    auxCg = auxCgs.First() as CalculationGroupTable; \r\n} else \r\n{\r\n    /*create the aux calc group and ask for a refresh since it cannot be used in a query before that*/\r\n    auxCg = Model.AddCalculationGroup(name: auxCalcGroupName);\r\n    auxCg.AddCalculationItem(name: auxCalcItemName, expression: \"SELECTEDMEASUREFORMATSTRING()\");\r\n    auxCg.SetAnnotation(auxCgTag, auxCgTagValue);\r\n\r\n    /*better hidden in case someone forgets to delete it*/\r\n    auxCg.IsHidden = true; \r\n    int maxPrecedence = 0; \r\n\r\n    /*check for the max precedence of other calc groups*/\r\n    foreach (CalculationGroupTable cg in regularCGs)\r\n    {\r\n        if (cg.CalculationGroupPrecedence > maxPrecedence)\r\n        {\r\n            maxPrecedence = cg.CalculationGroupPrecedence;\r\n        };\r\n    };\r\n\r\n    /*assign the highest precedence and some margin*/\r\n    auxCg.CalculationGroupPrecedence = maxPrecedence + 10; \r\n\r\n    Info(\"Save changes to the model, recalculate the model, and launch the script again.\");\r\n    return;\r\n\r\n};\r\n\r\n\r\n\r\n\r\n/*check if any measures are selected*/\r\nif (Selected.Measures.Count == 0)\r\n{\r\n    Error(\"No measures selected\");\r\n    return;\r\n}\r\n\r\nCalculationGroupTable regularCg = null as CalculationGroupTable;\r\n\r\n/*allow user to select calculation group if more than one is found*/\r\nif (regularCGs.Count() > 1)\r\n{\r\n    regularCg = SelectTable(regularCGs) as CalculationGroupTable;\r\n}\r\n/*otherwise just pick the first (and only)*/\r\nelse\r\n{\r\n    regularCg = regularCGs.First() as CalculationGroupTable;\r\n}\r\n\r\n/*check if no selection was made*/ \r\nif(regularCg == null)\r\n{\r\n    Error(\"No Target Calculation Group selected\");\r\n    return;\r\n};\r\n\r\nstring name = String.Empty; \r\nif(generateFieldParameter) {\r\n    name = Interaction.InputBox(\"Provide a name for the field parameter\", \"Field Parameter\", regularCg.Name + \" Measures\", 740, 400);\r\n    if(name == \"\") {Error(\"Execution Aborted\"); return;};\r\n}; \r\n\r\n\r\nMeasureCollection measures; \r\n\r\n/*iterates through each selected measure*/\r\nforeach (Measure m in Selected.Measures)\r\n{\r\n    /*check that base measure has a proper format string*/ \r\n    if(m.FormatString == \"\") {\r\n        Error(\"Define FormatString for \" + m.Name + \" and try again\");\r\n        return;\r\n    };\r\n\r\n    /*prepares a displayfolder to store all new measures*/\r\n    string displayFolderName = m.Name + \" Measures\";\r\n\r\n    /*iterates thorough all calculation items of the selected calc group*/ \r\n    foreach (CalculationItem calcItem in regularCg.CalculationItems)\r\n    {\r\n        /*measure name*/ \r\n        string measureName = m.Name + \" \" + calcItem.Name;           \r\n        \r\n        //only if the measure is not yet there (think of reruns)\r\n        if(!Model.AllMeasures.Any(x => x.Name == measureName)){\r\n\r\n            /*prepares a query to calculate the resulting format when applying the calculation item on the measure*/ \r\n            string query = string.Format(\r\n                \"EVALUATE {{CALCULATE({0},{1},{2})}}\",\r\n                m.DaxObjectFullName,\r\n                string.Format(\r\n                    \"{0}=\\\"{1}\\\"\",\r\n                    regularCg.Columns[0].DaxObjectFullName,\r\n                    calcItem.Name),\r\n                string.Format(\r\n                    \"{0}=\\\"{1}\\\"\",\r\n                    auxCg.Columns[0].DaxObjectFullName,\r\n                    auxCalcItemName)\r\n                );\r\n\r\n            /*executes the query*/ \r\n            using (var reader = Model.Database.ExecuteReader(query))\r\n            {\r\n                // resultset should contain just one row, with the format string\r\n                while (reader.Read())\r\n                {\r\n                                 \r\n\r\n                    /*retrive the formatstring from the query*/ \r\n                    string formatString = reader.GetValue(0).ToString();\r\n\r\n                    /*build the expression of the measure*/\r\n                    string measureExpression = string.Format(\r\n                        \"CALCULATE({0},{1}=\\\"{2}\\\")\",\r\n                        m.DaxObjectName,\r\n                        regularCg.Columns[0].DaxObjectFullName,\r\n                        calcItem.Name);\r\n\r\n                    \r\n                    \r\n                    /*actually build the measure*/ \r\n                    Measure newMeasure = \r\n                        m.Table.AddMeasure(\r\n                            name: measureName,\r\n                            expression: measureExpression);\r\n\r\n\r\n                    /*the all important format string!*/\r\n                    newMeasure.FormatString = formatString;\r\n\r\n                    /*final polish*/\r\n                    newMeasure.DisplayFolder = displayFolderName;\r\n                    newMeasure.FormatDax();\r\n                    \r\n                    /*add annotations for the creation of the field parameter*/\r\n                    newMeasure.SetAnnotation(baseMeasureAnnotationName,m.Name); \r\n                    newMeasure.SetAnnotation(calcItemAnnotationName,calcItem.Name);\r\n                    newMeasure.SetAnnotation(scriptAnnotationName,scriptAnnotationValue);\r\n                    newMeasure.SetAnnotation(calcItemSortOrderName,calcItem.Ordinal.ToString(\"000\"));\r\n\r\n                }\r\n            }\r\n        }\r\n    } \r\n}\r\n\r\n\r\nif(!generateFieldParameter) {\r\n    //end of execution\r\n    return;\r\n};\r\n\r\n\r\n// Before running the script, select the measures or columns that you\r\n// would like to use as field parameters (hold down CTRL to select multiple\r\n// objects). Also, you may change the name of the field parameter table\r\n// below. NOTE: If used against Power BI Desktop, you must enable unsupported\r\n// features under File > Preferences (TE2) or Tools > Preferences (TE3).\r\n\r\n\r\nif(Selected.Columns.Count == 0 && Selected.Measures.Count == 0) throw new Exception(\"No columns or measures selected!\");\r\n\r\n// Construct the DAX for the calculated table based on the measures created previously by the script\r\nvar objects = Model.AllMeasures\r\n    .Where(x => x.GetAnnotation(scriptAnnotationName) == scriptAnnotationValue)\r\n    .OrderBy(x => x.GetAnnotation(baseMeasureAnnotationName) + x.GetAnnotation(calcItemSortOrderName)); \r\n\r\nvar dax = \"{\\n    \" + string.Join(\",\\n    \", objects.Select((c,i) => string.Format(\"(\\\"{0}\\\", NAMEOF('{1}'[{0}]), {2},\\\"{3}\\\",\\\"{4}\\\")\", \r\n    c.Name, c.Table.Name, i,\r\n    Model.Tables[c.Table.Name].Measures[c.Name].GetAnnotation(\"Base Measure\"),\r\n    Model.Tables[c.Table.Name].Measures[c.Name].GetAnnotation(\"Calc Item\")))) + \"\\n}\";\r\n\r\n// Add the calculated table to the model:\r\nvar table = Model.AddCalculatedTable(name, dax);\r\n\r\n// In TE2 columns are not created automatically from a DAX expression, so \r\n// we will have to add them manually:\r\nvar te2 = table.Columns.Count == 0;\r\nvar nameColumn = te2 ? table.AddCalculatedTableColumn(name, \"[Value1]\") : table.Columns[\"Value1\"] as CalculatedTableColumn;\r\nvar fieldColumn = te2 ? table.AddCalculatedTableColumn(name + \" Fields\", \"[Value2]\") : table.Columns[\"Value2\"] as CalculatedTableColumn;\r\nvar orderColumn = te2 ? table.AddCalculatedTableColumn(name + \" Order\", \"[Value3]\") : table.Columns[\"Value3\"] as CalculatedTableColumn;\r\n\r\nif(!te2) {\r\n    // Rename the columns that were added automatically in TE3:\r\n    nameColumn.IsNameInferred = false;\r\n    nameColumn.Name = name;\r\n    fieldColumn.IsNameInferred = false;\r\n    fieldColumn.Name = name + \" Fields\";\r\n    orderColumn.IsNameInferred = false;\r\n    orderColumn.Name = name + \" Order\";\r\n}\r\n// Set remaining properties for field parameters to work\r\n// See: https://twitter.com/markbdi/status/1526558841172893696\r\nnameColumn.SortByColumn = orderColumn;\r\nnameColumn.GroupByColumns.Add(fieldColumn);\r\nfieldColumn.SortByColumn = orderColumn;\r\nfieldColumn.SetExtendedProperty(\"ParameterMetadata\", \"{\\\"version\\\":3,\\\"kind\\\":2}\", ExtendedPropertyType.Json);\r\nfieldColumn.IsHidden = true;\r\norderColumn.IsHidden = true;",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 58,
      "Name": "8. Bernats Repo\\4. Check\\DATA PROBLEMS",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n\r\n\r\n// '2021-05-26 / B.Agullo / \r\n// '2021-10-13 / B.Agullo / dynamic parameters for one-click operation\r\n// '2022-10-18 / B.Agullo / Bug fixes\r\n// by Bernat Agulló\r\n// www.esbrina-ba.com\r\n\r\n// Instructions: \r\n// select the measures that counts the number of \"data problems\" the model has and then run the script or as macro\r\n// when adding macro select measure context for execution \r\n\r\n//\r\n// ----- do not modify script below this line -----\r\n//\r\n\r\n\r\nif (Selected.Measures.Count != 1) {\r\n    Error(\"Select one and only one measure\");\r\n    return;\r\n};\r\n\r\nstring navigationTableName = Interaction.InputBox(\"Provide a name for navigation measures table name\", \"Navigation Table Name\", \"Navigation\", 740, 400);\r\nif(navigationTableName == \"\") return;\r\n\r\nif(Model.Tables.Any(Table => Table.Name == navigationTableName)) {\r\n    Error(navigationTableName + \" already exists!\");\r\n    return; \r\n};\r\n\r\nstring buttonTextMeasureName = Interaction.InputBox(\"Name for your button text measure\", \"Button text measure name\", \"Button Text\", 740, 400);\r\nif(buttonTextMeasureName == \"\") return;\r\n\r\nstring buttonTextPattern = Interaction.InputBox(\"Provide a pattern for your button text\", \"Button text pattern (# = no. of problems)\", \"There are # data problems\", 740, 400);\r\nif(buttonTextPattern == \"\") return;\r\n\r\nstring buttonBackgroundMeasureName = Interaction.InputBox(\"Name your button background measure\", \"Button Background Measure\", \"Button Background\", 740, 400);\r\nif(buttonBackgroundMeasureName == \"\") return;\r\n\r\nstring buttonNavigationMeasureName = Interaction.InputBox(\"Name your button navigation measure\", \"Button Navigation Measure\", \"Button Navigation\", 740, 400);\r\nif(buttonNavigationMeasureName == \"\") return;\r\n\r\nstring thereAreDataProblemsMeasureName = Interaction.InputBox(\"Name your data problems flag measure\", \"Data problems Flag Measure\", \"There are Data Problems\", 740, 400);\r\nif(thereAreDataProblemsMeasureName == \"\") return;\r\n\r\nstring dataProblemsSheetName = Interaction.InputBox(\"Where are the data problems detail?\", \"Data problems Sheet\", \"Data Problems\", 740, 400);\r\nif(dataProblemsSheetName == \"\") return;\r\n\r\n\r\n// colors will be created if not present\r\nstring buttonColorMeasureNameWhenVisible = Interaction.InputBox(\"What's the color measure name when the button is visible?\", \"Visible color measure name\", \"Warning Color\", 740, 400);\r\nif(buttonColorMeasureNameWhenVisible == \"\") return;\r\n\r\nstring buttonColorMeasureValueWhenVisible = Interaction.InputBox(\"What's the color code of \" + buttonColorMeasureNameWhenVisible + \"?\", \"Visible color code\", \"#D64554\", 740, 400);\r\nif(buttonColorMeasureValueWhenVisible == \"\") return;\r\nbuttonColorMeasureValueWhenVisible = \"\\\"\" + buttonColorMeasureValueWhenVisible + \"\\\"\";\r\n\r\nstring buttonColorMeasureNameWhenInvisible = Interaction.InputBox(\"What's the color measure name when button is invisible?\", \"Invisible color measure name\", \"Report Background Color\", 740, 400);\r\nif(buttonColorMeasureNameWhenInvisible == \"\") return;\r\n\r\nstring buttonColorMeasureValueWhenInvisible = Interaction.InputBox(\"What's the color code of \" + buttonColorMeasureNameWhenInvisible + \"?\", \"Invisible color measure name\", \"#FFFFFF\", 740, 400);\r\nif(buttonColorMeasureValueWhenInvisible == \"\") return;\r\nbuttonColorMeasureValueWhenInvisible = \"\\\"\" + buttonColorMeasureValueWhenInvisible + \"\\\"\";\r\n\r\n\r\n// prepare array to iterate on new measure names \r\nstring[] newMeasureNames = \r\n    {\r\n        buttonTextMeasureName,\r\n        buttonBackgroundMeasureName,\r\n        buttonNavigationMeasureName,\r\n        thereAreDataProblemsMeasureName\r\n    };\r\n\r\n\r\n// check none of the new measure names already exist as such \r\nforeach(string measureName in newMeasureNames) {\r\n    if(Model.AllMeasures.Any(Measure => Measure.Name == measureName)) {\r\n        Error(measureName + \" already exists!\"); \r\n        return;\r\n    };\r\n};\r\n    \r\nvar dataProblemsMeasure = Selected.Measure; \r\n\r\nstring navigationTableExpression = \r\n    \"FILTER({1},[Value] = 0)\";\r\n\r\nvar navigationTable = \r\n    Model.AddCalculatedTable(navigationTableName,navigationTableExpression);\r\n    \r\nnavigationTable.FormatDax(); \r\nnavigationTable.Description = \r\n    \"Table to store the measures for the dynamic button that leads to the data problems sheet\";\r\n\r\nnavigationTable.IsHidden = true;     \r\n\r\nif(!Model.AllMeasures.Any(Measure => Measure.Name == buttonColorMeasureNameWhenVisible)) {\r\n    navigationTable.AddMeasure(buttonColorMeasureNameWhenVisible,buttonColorMeasureValueWhenVisible);\r\n};\r\n\r\nif(!Model.AllMeasures.Any(Measure => Measure.Name == buttonColorMeasureNameWhenInvisible)) {\r\n    navigationTable.AddMeasure(buttonColorMeasureNameWhenInvisible,\"\\\"#FFFFFF00\\\"\");\r\n};\r\n\r\nstring thereAreDataProblemsMeasureExpression = \r\n    \"[\" + dataProblemsMeasure.Name + \"]>0\";\r\n\r\nvar thereAreDataProblemsMeasure = \r\n    navigationTable.AddMeasure(\r\n        thereAreDataProblemsMeasureName,\r\n        thereAreDataProblemsMeasureExpression\r\n    );\r\n\r\nthereAreDataProblemsMeasure.FormatDax(); \r\nthereAreDataProblemsMeasure.Description = \"Boolean measure, if true, the button leading to data problems sheet should show (internal use only)\" ;\r\n \r\nstring buttonBackgroundMeasureExpression = \r\n    \"VAR colorCode = \" + \r\n    \"    IF(\" + \r\n    \"        [\" + thereAreDataProblemsMeasureName + \"],\" + \r\n    \"        [\" + buttonColorMeasureNameWhenVisible + \"],\" + \r\n    \"        [\" + buttonColorMeasureNameWhenInvisible + \"]\" + \r\n    \"    )\" + \r\n    \"RETURN \" + \r\n    \"    FORMAT(colorCode,\\\"@\\\")\";\r\n    \r\nvar buttonBackgroundMeasure = \r\n    navigationTable.AddMeasure(\r\n        buttonBackgroundMeasureName,\r\n        buttonBackgroundMeasureExpression\r\n    );\r\n    \r\nbuttonBackgroundMeasure.FormatDax(); \r\nbuttonBackgroundMeasure.Description = \"Use this measure for conditional formatting of button background\";  \r\n\r\nstring buttonNavigationMeasureExpression = \r\n    \"IF(\" + \r\n    \"    [\" + thereAreDataProblemsMeasureName + \"],\" + \r\n    \"    \\\"\" + dataProblemsSheetName + \"\\\",\" + \r\n    \"    \\\"\\\"\" + \r\n    \")\";\r\n\r\nvar buttonNavigationMeasure = \r\n    navigationTable.AddMeasure(\r\n        buttonNavigationMeasureName,\r\n        buttonNavigationMeasureExpression\r\n    );\r\n    \r\nbuttonNavigationMeasure.FormatDax(); \r\nbuttonNavigationMeasure.Description = \"Use this measure for conditional page navigation\";  \r\n\r\nstring buttonTextMeasureExpression = \r\n    \"IF(\" + \r\n    \"    [\" + thereAreDataProblemsMeasureName + \"],\" + \r\n    \"    SUBSTITUTE(\\\"\" + buttonTextPattern + \"\\\",\\\"#\\\",FORMAT([\" + dataProblemsMeasure.Name + \"],0)),\" + \r\n    \"    \\\"\\\"\" + \r\n    \")\";    \r\n    \r\nvar buttonTextMeasure = \r\n    navigationTable.AddMeasure(\r\n        buttonTextMeasureName,\r\n        buttonTextMeasureExpression\r\n    );\r\n    \r\nbuttonTextMeasure.FormatDax(); \r\nbuttonTextMeasure.Description = \"Use this measure for dynamic button text\";  \r\n\r\n//dataProblemsMeasure.MoveTo(navigationTable);\r\n    ",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 59,
      "Name": "8. Bernats Repo\\4. Check\\Data problems button",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n\r\n\r\n// '2021-05-26 / B.Agullo / \r\n// '2021-10-13 / B.Agullo / dynamic parameters for one-click operation\r\n// by Bernat Agulló\r\n// www.esbrina-ba.com\r\n\r\n// Instructions: \r\n// select the measures that counts the number of \"data problems\" the model has and then run the script or as macro\r\n// when adding macro select measure context for execution \r\n\r\n//\r\n// ----- do not modify script below this line -----\r\n//\r\n\r\n\r\nif (Selected.Measures.Count != 1) {\r\n    Error(\"Select one and only one measure\");\r\n    return;\r\n};\r\n\r\nstring navigationTableName = Interaction.InputBox(\"Provide a name for navigation measures table name\", \"Navigation Table Name\", \"Navigation\", 740, 400);\r\nif(navigationTableName == \"\") return;\r\n\r\nif(Model.Tables.Any(Table => Table.Name == navigationTableName)) {\r\n    Error(navigationTableName + \" already exists!\");\r\n    return; \r\n};\r\n\r\nstring buttonTextMeasureName = Interaction.InputBox(\"Name for your button text measure\", \"Button text measure name\", \"Button Text\", 740, 400);\r\nif(buttonTextMeasureName == \"\") return;\r\n\r\nstring buttonTextPattern = Interaction.InputBox(\"Provide a pattern for your button text\", \"Button text pattern (# = no. of problems)\", \"There are # data problems\", 740, 400);\r\nif(buttonTextPattern == \"\") return;\r\n\r\nstring buttonBackgroundMeasureName = Interaction.InputBox(\"Name your button background measure\", \"Button Background Measure\", \"Button Background\", 740, 400);\r\nif(buttonBackgroundMeasureName == \"\") return;\r\n\r\nstring buttonNavigationMeasureName = Interaction.InputBox(\"Name your button navigation measure\", \"Button Navigation Measure\", \"Button Navigation\", 740, 400);\r\nif(buttonNavigationMeasureName == \"\") return;\r\n\r\nstring thereAreDataProblemsMeasureName = Interaction.InputBox(\"Name your data problems flag measure\", \"Data problems Flag Measure\", \"There are Data Problems\", 740, 400);\r\nif(thereAreDataProblemsMeasureName == \"\") return;\r\n\r\nstring dataProblemsSheetName = Interaction.InputBox(\"Where are the data problems detail?\", \"Data problems Sheet\", \"Data Problems\", 740, 400);\r\nif(dataProblemsSheetName == \"\") return;\r\n\r\n\r\n// colors will be created if not present\r\nstring buttonColorMeasureNameWhenVisible = Interaction.InputBox(\"What's the color measure name when the button is visible?\", \"Visible color measure name\", \"Warning Color\", 740, 400);\r\nif(buttonColorMeasureNameWhenVisible == \"\") return;\r\n\r\nstring buttonColorMeasureValueWhenVisible = Interaction.InputBox(\"What's the color code of \" + buttonColorMeasureNameWhenVisible + \"?\", \"Visible color code\", \"#D64554\", 740, 400);\r\nif(buttonColorMeasureValueWhenVisible == \"\") return;\r\nbuttonColorMeasureValueWhenVisible = \"\\\"\" + buttonColorMeasureValueWhenVisible + \"\\\"\";\r\n\r\nstring buttonColorMeasureNameWhenInvisible = Interaction.InputBox(\"What's the color measure name when button is invisible?\", \"Invisible color measure name\", \"Report Background Color\", 740, 400);\r\nif(buttonColorMeasureNameWhenInvisible == \"\") return;\r\n\r\nstring buttonColorMeasureValueWhenInvisible = Interaction.InputBox(\"What's the color code of \" + buttonColorMeasureNameWhenInvisible + \"?\", \"Invisible color measure name\", \"#FFFFFF\", 740, 400);\r\nif(buttonColorMeasureValueWhenInvisible == \"\") return;\r\nbuttonColorMeasureValueWhenInvisible = \"\\\"\" + buttonColorMeasureValueWhenInvisible + \"\\\"\";\r\n\r\n\r\n// prepare array to iterate on new measure names \r\nstring[] newMeasureNames = \r\n    {\r\n        buttonTextMeasureName,\r\n        buttonBackgroundMeasureName,\r\n        buttonNavigationMeasureName,\r\n        thereAreDataProblemsMeasureName\r\n    };\r\n\r\n\r\n// check none of the new measure names already exist as such \r\nforeach(string measureName in newMeasureNames) {\r\n    if(Model.AllMeasures.Any(Measure => Measure.Name == measureName)) {\r\n        Error(measureName + \" already exists!\"); \r\n        return;\r\n    };\r\n};\r\n    \r\nvar dataProblemsMeasure = Selected.Measure; \r\n\r\nstring navigationTableExpression = \r\n    \"FILTER({1},[Value] = 0)\";\r\n\r\nvar navigationTable = \r\n    Model.AddCalculatedTable(navigationTableName,navigationTableExpression);\r\n    \r\nnavigationTable.FormatDax(); \r\nnavigationTable.Description = \r\n    \"Table to store the measures for the dynamic button that leads to the data problems sheet\";\r\n\r\nnavigationTable.IsHidden = true;     \r\n\r\nif(!Model.AllMeasures.Any(Measure => Measure.Name == buttonColorMeasureNameWhenVisible)) {\r\n    navigationTable.AddMeasure(buttonColorMeasureNameWhenVisible,buttonColorMeasureValueWhenVisible);\r\n};\r\n\r\nif(!Model.AllMeasures.Any(Measure => Measure.Name == buttonColorMeasureNameWhenInvisible)) {\r\n    navigationTable.AddMeasure(buttonColorMeasureNameWhenInvisible,\"\\\"#FFFFFF00\\\"\");\r\n};\r\n\r\nstring thereAreDataProblemsMeasureExpression = \r\n    \"[\" + dataProblemsMeasure.Name + \"]>0\";\r\n\r\nvar thereAreDataProblemsMeasure = \r\n    navigationTable.AddMeasure(\r\n        thereAreDataProblemsMeasureName,\r\n        thereAreDataProblemsMeasureExpression\r\n    );\r\n\r\nthereAreDataProblemsMeasure.FormatDax(); \r\nthereAreDataProblemsMeasure.Description = \"Boolean measure, if true, the button leading to data problems sheet should show (internal use only)\" ;\r\n \r\nstring buttonBackgroundMeasureExpression = \r\n    \"VAR colorCode = \" + \r\n    \"    IF(\" + \r\n    \"        [\" + thereAreDataProblemsMeasureName + \"],\" + \r\n    \"        [\" + buttonColorMeasureNameWhenVisible + \"],\" + \r\n    \"        [\" + buttonColorMeasureNameWhenInvisible + \"]\" + \r\n    \"    )\" + \r\n    \"RETURN \" + \r\n    \"    FORMAT(colorCode,\\\"@\\\")\";\r\n    \r\nvar buttonBackgroundMeasure = \r\n    navigationTable.AddMeasure(\r\n        buttonBackgroundMeasureName,\r\n        buttonBackgroundMeasureExpression\r\n    );\r\n    \r\nbuttonBackgroundMeasure.FormatDax(); \r\nbuttonBackgroundMeasure.Description = \"Use this measure for conditional formatting of button background\";  \r\n\r\nstring buttonNavigationMeasureExpression = \r\n    \"IF(\" + \r\n    \"    [\" + thereAreDataProblemsMeasureName + \"],\" + \r\n    \"    \\\"\" + dataProblemsSheetName + \"\\\",\" + \r\n    \"    \\\"\\\"\" + \r\n    \")\";\r\n\r\nvar buttonNavigationMeasure = \r\n    navigationTable.AddMeasure(\r\n        buttonNavigationMeasureName,\r\n        buttonNavigationMeasureExpression\r\n    );\r\n    \r\nbuttonNavigationMeasure.FormatDax(); \r\nbuttonNavigationMeasure.Description = \"Use this measure for conditional page navigation\";  \r\n\r\nstring buttonTextMeasureExpression = \r\n    \"IF(\" + \r\n    \"    [\" + thereAreDataProblemsMeasureName + \"],\" + \r\n    \"    SUBSTITUTE(\\\"\" + buttonTextPattern + \"\\\",\\\"#\\\",FORMAT([\" + dataProblemsMeasure.Name + \"],0)),\" + \r\n    \"    \\\"\\\"\" + \r\n    \")\";    \r\n    \r\nvar buttonTextMeasure = \r\n    navigationTable.AddMeasure(\r\n        buttonTextMeasureName,\r\n        buttonTextMeasureExpression\r\n    );\r\n    \r\nbuttonTextMeasure.FormatDax(); \r\nbuttonTextMeasure.Description = \"Use this measure for dynamic button text\";  \r\n\r\n//dataProblemsMeasure.MoveTo(navigationTable);\r\n    ",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 60,
      "Name": "8. Bernats Repo\\1. Measure\\DISTINCTCOUNT",
      "Enabled": "true",
      "Execute": "if(Selected.Columns.Count() == 0)\r\n{\r\n    Error(\"You need to select at least one measure.\");\r\n    return;\r\n};\r\nforeach(Column column in Selected.Columns)\r\n{\r\n    string measureName = \"Distinct \" + column.Name;\r\n    string measureExpression = String.Format(\"DISTINCTCOUNT({0})\", column.DaxObjectFullName);\r\n    string measureDescription = \"Distinct count of \" + column.Name;\r\n    Measure measure = column.Table.AddMeasure(measureName, measureExpression);\r\n    measure.Description = measureDescription;\r\n    measure.FormatDax(); \r\n};\r\n",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 61,
      "Name": "8. Bernats Repo\\2. Calc Table\\Duplicate Date Table",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing System.Windows.Forms;\r\n\r\nusing Microsoft.VisualBasic;\r\nstring annotationLabel = \"createSecondaryDateTable\";\r\nstring annotationValue1 = \"Main\";\r\nstring annotationValue2 = \"Secondary\"; \r\nTable dateTable = Fx.GetTablesWithAnnotation(Model.Tables, annotationLabel, annotationValue1); \r\nTable dateTable2 = Fx.GetTablesWithAnnotation(Model.Tables, annotationLabel, annotationValue2);\r\nif (dateTable == null || dateTable2 == null)\r\n{\r\n    IEnumerable<Table> dateTables = Fx.GetDateTables(Model);\r\n    if (dateTables == null) return;\r\n    if (dateTables.Count() != 1)\r\n    {\r\n        dateTable = SelectTable(dateTables, dateTables.First(), \"Select Date table to duplicate\");\r\n        if (dateTable == null) return;\r\n    }\r\n    else\r\n    {\r\n        dateTable = dateTables.First();\r\n    }\r\n    string dateTable2Name = Fx.GetNameFromUser(\"Secondary Date Table Name\", \"Name\", dateTable.Name + \" comparison\");\r\n    dateTable2 = Model.AddCalculatedTable(name: dateTable2Name, expression: dateTable.DaxObjectFullName);\r\n    dateTable2.DataCategory = dateTable.DataCategory;\r\n    var te2 = dateTable2.Columns.Count == 0;\r\n    for (int i = 0; i < dateTable2.Columns.Count(); i++)\r\n    {\r\n        Column c = dateTable.Columns[i];\r\n        Column c2 = te2 ? dateTable2.AddCalculatedColumn(c.Name, String.Format(\"[Value{0}]\", i)) : dateTable2.Columns[i];\r\n    }\r\n    dateTable.SetAnnotation(annotationLabel, annotationValue1);\r\n    dateTable2.SetAnnotation(annotationLabel, annotationValue2);\r\n    Info(\"Save changes back to the model, recalculate and run again\");\r\n}\r\nelse\r\n{\r\n    for (int i = 0; i < dateTable2.Columns.Count(); i++)\r\n    {\r\n        Column c = dateTable.Columns[i];\r\n        Column c2 = dateTable2.Columns[i];\r\n        c2.IsKey = c.IsKey;\r\n        c2.SortByColumn = c.SortByColumn;\r\n    }\r\n    IEnumerable<SingleColumnRelationship> dateTableRelatioships =\r\n        Model.Relationships.Where(r => r.FromTable.Name == dateTable.Name\r\n        || r.ToTable.Name == dateTable.Name);\r\n    foreach (SingleColumnRelationship r in dateTableRelatioships)\r\n    {\r\n        SingleColumnRelationship newR = Model.AddRelationship();\r\n        if (r.FromTable.Name == dateTable.Name)\r\n        {\r\n            newR.FromColumn = dateTable2.Columns[r.FromColumn.Name];\r\n            newR.ToColumn = r.ToColumn;\r\n        }else\r\n        {\r\n            newR.ToColumn = dateTable2.Columns[r.ToColumn.Name];\r\n            newR.FromColumn = r.FromColumn;\r\n        }\r\n        newR.FromCardinality = r.FromCardinality;\r\n        newR.ToCardinality = r.ToCardinality;\r\n        newR.CrossFilteringBehavior = r.CrossFilteringBehavior;\r\n        newR.IsActive = r.IsActive; \r\n    }\r\n    Info(\"Metadata updated\");\r\n}\r\n\r\npublic static class Fx\r\n{\r\n    public static IEnumerable<Table> GetDateTables(Model model)\r\n    {\r\n        IEnumerable<Table> dateTables = null as IEnumerable<Table>;\r\n        if (model.Tables.Any(t => t.DataCategory == \"Time\" && t.Columns.Any(c => c.IsKey == true)))\r\n        {\r\n            dateTables = model.Tables.Where(t => t.DataCategory == \"Time\" && t.Columns.Any(c => c.IsKey == true && c.DataType == DataType.DateTime));\r\n        }\r\n        else\r\n        {\r\n            Error(\"No date table detected in the model. Please mark your date table(s) as date table\");\r\n        }\r\n        return dateTables;\r\n    }\r\n    public static Table GetTablesWithAnnotation(IEnumerable<Table> tables, string annotationLabel, string annotationValue)\r\n    {\r\n        Func<Table, bool> lambda = t => t.GetAnnotation(annotationLabel) == annotationValue;\r\n        IEnumerable<Table> matchTables = GetFilteredTables(tables, lambda);\r\n        if(matchTables == null)\r\n        {\r\n            return null;\r\n        }\r\n        else\r\n        {\r\n            return matchTables.First();\r\n        }\r\n    }\r\n    public static IEnumerable<Table> GetFilteredTables(IEnumerable<Table> tables, Func<Table,bool> lambda)\r\n    {\r\n        if (tables.Any(t => lambda(t)))\r\n        {\r\n            return tables.Where(t => lambda(t));\r\n        }\r\n        else\r\n        {\r\n            return null as IEnumerable<Table>; \r\n        }\r\n    }\r\n    public static IEnumerable<Column> GetFilteredColumns(IEnumerable<Column> columns, Func<Column,bool> lambda, bool returnAllIfNoneFound = true) \r\n    {\r\n        if (columns.Any(c => lambda(c)))\r\n        {\r\n            return columns.Where(c => lambda(c));\r\n        }\r\n        else\r\n        {\r\n            if(returnAllIfNoneFound)\r\n            {\r\n                return columns;\r\n            }\r\n            else\r\n            {\r\n                return null as IEnumerable<Column>;\r\n            }\r\n        }\r\n    }\r\n    public static Table CreateCalcTable(Model model, string tableName, string tableExpression)\r\n    {\r\n        if(!model.Tables.Any(t => t.Name == tableName))\r\n        {\r\n            return model.AddCalculatedTable(tableName, tableExpression);\r\n        }\r\n        else\r\n        {\r\n            return model.Tables.Where(t => t.Name == tableName).First();\r\n        }\r\n    }\r\n    public static string GetNameFromUser(string Prompt, string Title =\"\", string DefaultResponse = \"\")\r\n    {    \r\n        string response = Interaction.InputBox(Prompt, Title, DefaultResponse, 740, 400);\r\n        return response;\r\n    }\r\n    public static string ChooseString(IList<string> OptionList)\r\n    {\r\n        Func<IList<string>, string, string> SelectString = (IList<string> options, string title) =>\r\n        {\r\n            var form = new Form();\r\n            form.Text = title;\r\n            var buttonPanel = new Panel();\r\n            buttonPanel.Dock = DockStyle.Bottom;\r\n            buttonPanel.Height = 30;\r\n            var okButton = new Button() { DialogResult = DialogResult.OK, Text = \"OK\" };\r\n            var cancelButton = new Button() { DialogResult = DialogResult.Cancel, Text = \"Cancel\", Left = 80 };\r\n            var listbox = new ListBox();\r\n            listbox.Dock = DockStyle.Fill;\r\n            listbox.Items.AddRange(options.ToArray());\r\n            listbox.SelectedItem = options[0];\r\n            form.Controls.Add(listbox);\r\n            form.Controls.Add(buttonPanel);\r\n            buttonPanel.Controls.Add(okButton);\r\n            buttonPanel.Controls.Add(cancelButton);\r\n            var result = form.ShowDialog();\r\n            if (result == DialogResult.Cancel) return null;\r\n            return listbox.SelectedItem.ToString();\r\n        };\r\n        //let the user select the name of the macro to copy\r\n        String select = SelectString(OptionList, \"Choose a macro\");\r\n        //check that indeed one macro was selected\r\n        if (select == null)\r\n        {\r\n            Info(\"You cancelled!\");\r\n        }\r\n        return select;\r\n    }\r\n}\r\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 62,
      "Name": "8. Bernats Repo\\1. Measure\\Dynamic Headers by measure",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\nusing System.Windows.Forms;\r\n\r\n\r\n/* '2023-01-26 / B.Agullo / creates a field parameter of measures filtered by calc group and values of a column with a name defined by a measure evaluated in the filtered value and calc item  */\r\n\r\n/* DYNAMIC HEADER FIELD PARAMETER SCRIPT */ \r\n\r\n/* see https://www.esbrina-ba.com/dynamic-headers-in-power-bi-sort-of/ */\r\n/* select measures and execute, you will need to run it twice */\r\n/* first time to create aux calc group, second time to actually create measuree*/\r\n/* remove aux calc group before going to production, do the right thing */\r\n\r\nstring auxCgTag = \"@AgulloBernat\";\r\nstring auxCgTagValue = \"CG to extract format strings\";\r\n\r\nstring auxCalcGroupName = \"DELETE AUX CALC GROUP\";\r\nstring auxCalcItemName = \"Get Format String\";\r\n\r\nstring baseMeasureAnnotationName = \"Base Measure\";\r\nstring calcItemAnnotationName = \"Calc Item\";\r\nstring calcItemSortOrderName = \"Sort Order\";\r\nstring calcItemSortOrderValue = String.Empty;\r\n\r\nstring filterValueAnnotationName = String.Empty;\r\nstring dynamicNameAnnotationName = \"Dynamic Name\";\r\n\r\n\r\nstring scriptAnnotationName = \"Script\";\r\nstring scriptAnnotationValue = \"Create Measures with a Calculation Group \" + DateTime.Now.ToString(\"yyyyMMddHHmmss\") ;\r\n\r\nbool generateFieldParameter;\r\n\r\nDialogResult dialogResult = MessageBox.Show(\"Generate Field Parameter?\", \"Field Parameter\", MessageBoxButtons.YesNo);\r\ngenerateFieldParameter = (dialogResult == DialogResult.Yes);\r\n\r\n/*check if any measures are selected*/\r\nif (Selected.Measures.Count == 0)\r\n{\r\n    Error(\"No measures selected\");\r\n    return;\r\n}\r\n\r\n/*find any regular CGs (excluding the one we might have created)*/\r\nvar regularCGs = Model.Tables.Where(\r\n    x => x.ObjectType == ObjectType.CalculationGroupTable\r\n    & x.GetAnnotation(auxCgTag) != auxCgTagValue);\r\n\r\nif (regularCGs.Count() == 0)\r\n{\r\n    Error(\"No Calculation Groups Found\");\r\n    return;\r\n};\r\n\r\n\r\n\r\n\r\n//the lambda expression will be avaluated for all calc groups to find a matching calc group\r\n//CalculationGroupTable auxCg = Fx.SelectCalculationGroup(model:Model,lambdaExpression:lambda,selectFirst:true, showErrorIfNoTablesFound:false);\r\n\r\nbool calcGroupWasCreated = false;\r\n\r\n//the calc group will only be created if not found, and when so the boolean will point to it\r\nCalculationGroupTable auxCg = Fx.AddCalculationGroupExt(model: Model, calcGroupWasCreated: out calcGroupWasCreated, \r\n    defaultName: auxCalcGroupName, customCalcGroupName: false, annotationName: auxCgTag, annotationValue: auxCgTagValue);\r\n\r\nif (calcGroupWasCreated)\r\n{\r\n    CalculationItem cItem = Fx.AddCalculationItemExt(cg: auxCg, calcItemName: auxCalcItemName, valueExpression: \"SELECTEDMEASUREFORMATSTRING()\");\r\n    auxCg.IsHidden = true; \r\n    \r\n    Info(\"Save changes to the model, recalculate the model, and launch the script again.\");\r\n    return;\r\n}\r\n\r\n//to avoid showing the aux calc group in the list\r\nFunc<Table, bool> lambda = (x) => x.GetAnnotation(auxCgTag) != auxCgTagValue;\r\n\r\nCalculationGroupTable regularCg = Fx.SelectCalculationGroup(model: Model, lambdaExpression: lambda);\r\nif (regularCg == null) return;\r\n\r\n\r\nTable filterTable = Fx.SelectTableExt(model: Model, excludeCalcGroups: true, label:\"Select table of filter field\",showErrorIfNoSelection:true);\r\nif(filterTable == null) return;\r\nColumn filterColumn = SelectColumn(filterTable,label:\"Select filter Field\");\r\nif (filterColumn == null) return;\r\n\r\nfilterValueAnnotationName = filterColumn.Name; \r\n\r\nString filterQuery = String.Format(\"EVALUATE DISTINCT({0})\", filterColumn.DaxObjectFullName);\r\n\r\nList<String> filterValues = new List<String>();\r\n\r\nusing (var filterReader = Model.Database.ExecuteReader(filterQuery))\r\n{\r\n\r\n    while (filterReader.Read())\r\n    {\r\n\r\n        filterValues.Add(filterReader.GetValue(0).ToString());\r\n    }\r\n}\r\n\r\nstring name = String.Empty;\r\nif (generateFieldParameter)\r\n{\r\n    name = Interaction.InputBox(\"Provide a name for the field parameter\", \"Field Parameter\", regularCg.Name + \" Measures\", 740, 400);\r\n    if (name == \"\") { Error(\"Execution Aborted\"); return; };\r\n};\r\n\r\nMeasure dynamicNameMeasure = SelectMeasure(label: \"Select measure for dynamic name, cancel if none\");\r\n\r\n\r\n/*iterates through each selected measure*/\r\nforeach (Measure m in Selected.Measures)\r\n{\r\n    /*check that base measure has a proper format string*/\r\n    if (m.FormatString == \"\")\r\n    {\r\n        Error(\"Define FormatString for \" + m.Name + \" and try again\");\r\n        return;\r\n    };\r\n\r\n    /*prepares a displayfolder to store all new measures*/\r\n    string displayFolderName = m.Name + \" Measures\";\r\n\r\n    /*iterates thorough all calculation items of the selected calc group*/\r\n    foreach (CalculationItem calcItem in regularCg.CalculationItems)\r\n    {\r\n\r\n        string measureNamePrefix = string.Concat(Enumerable.Repeat(\"\\u200B\", calcItem.Ordinal));\r\n\r\n        foreach (string filterValue in filterValues)\r\n        {\r\n            \r\n            \r\n            \r\n            /*measure name*/\r\n            string measureName = measureName = m.Name + \" \" + calcItem.Name + \" \" + filterValue;\r\n\r\n            string dynamicMeasureName = String.Empty;  \r\n\r\n            if (dynamicNameMeasure == null)\r\n            {\r\n                dynamicMeasureName = measureName;\r\n            }\r\n            else\r\n            {\r\n\r\n                string measureNameQuery = String.Empty;\r\n\r\n                if (filterColumn.DataType == DataType.String)\r\n                {\r\n\r\n                    measureNameQuery =\r\n                        String.Format(\"EVALUATE {{CALCULATE({0},{1}=\\\"{2}\\\",{3}=\\\"{4}\\\") & \\\"\\\"}}\", \r\n                            dynamicNameMeasure.DaxObjectFullName, \r\n                            filterColumn.DaxObjectFullName, \r\n                            filterValue,\r\n                            regularCg.Columns[0].DaxObjectFullName,\r\n                            calcItem.Name);\r\n                }\r\n                else\r\n                {\r\n                    measureNameQuery =\r\n                        String.Format(\"EVALUATE {{CALCULATE({0},{1}={2},{3}=\\\"{4}\\\") & \\\"\\\"}}\",\r\n                            dynamicNameMeasure.DaxObjectFullName,\r\n                            filterColumn.DaxObjectFullName,\r\n                            filterValue,\r\n                            regularCg.Columns[0].DaxObjectFullName,\r\n                            calcItem.Name);\r\n                }\r\n\r\n\r\n               \r\n                using (var reader = Model.Database.ExecuteReader(measureNameQuery))\r\n                {\r\n                    while (reader.Read())\r\n                    {\r\n                        dynamicMeasureName = reader.GetString(0).ToString();\r\n\r\n                    }\r\n                }\r\n\r\n                dynamicMeasureName =  m.Name + \" \" +  measureNamePrefix + dynamicMeasureName;\r\n\r\n\r\n            }\r\n\r\n            \r\n\r\n            //only if the measure is not yet there (think of reruns)\r\n            if (!Model.AllMeasures.Any(x => x.Name == measureName))\r\n            {\r\n\r\n                /*prepares a query to calculate the resulting format when applying the calculation item on the measure*/\r\n                string query = string.Format(\r\n                    \"EVALUATE {{CALCULATE({0},{1},{2})}}\",\r\n                    m.DaxObjectFullName,\r\n                    string.Format(\r\n                        \"{0}=\\\"{1}\\\"\",\r\n                        regularCg.Columns[0].DaxObjectFullName,\r\n                        calcItem.Name),\r\n                    string.Format(\r\n                        \"{0}=\\\"{1}\\\"\",\r\n                        auxCg.Columns[0].DaxObjectFullName,\r\n                        auxCalcItemName)\r\n                );\r\n\r\n                /*executes the query*/\r\n                using (var reader = Model.Database.ExecuteReader(query))\r\n                {\r\n                    // resultset should contain just one row, with the format string\r\n                    while (reader.Read())\r\n                    {\r\n\r\n\r\n                        /*retrive the formatstring from the query*/\r\n                        string formatString = reader.GetValue(0).ToString();\r\n\r\n                       \r\n\r\n\r\n\r\n\r\n                        /*build the expression of the measure*/\r\n                        string measureExpression = String.Empty;\r\n\r\n                        if(filterColumn.DataType == DataType.String)\r\n                        {\r\n                            measureExpression = string.Format(\r\n                                \"CALCULATE({0},{1}=\\\"{2}\\\",KEEPFILTERS({3}=\\\"{4}\\\"))\",\r\n                                m.DaxObjectName,\r\n                                regularCg.Columns[0].DaxObjectFullName,\r\n                                calcItem.Name,\r\n                                filterColumn.DaxObjectFullName,\r\n                                filterValue\r\n                            );\r\n                        }\r\n                        else\r\n                        {\r\n                            measureExpression = string.Format(\r\n                                \"CALCULATE({0},{1}=\\\"{2}\\\",KEEPFILTERS({3}={4}))\",\r\n                                m.DaxObjectName,\r\n                                regularCg.Columns[0].DaxObjectFullName,\r\n                                calcItem.Name,\r\n                                filterColumn.DaxObjectFullName,\r\n                                filterValue\r\n                            );\r\n                        }\r\n\r\n                            \r\n                            \r\n                            \r\n\r\n\r\n\r\n                        /*actually build the measure*/\r\n                        Measure newMeasure =\r\n                            m.Table.AddMeasure(\r\n                                name: measureName,\r\n                                expression: measureExpression);\r\n\r\n\r\n                        /*the all important format string!*/\r\n                        newMeasure.FormatString = formatString;\r\n\r\n                        /*final polish*/\r\n                        newMeasure.DisplayFolder = displayFolderName;\r\n                        newMeasure.FormatDax();\r\n\r\n                        /*add annotations for the creation of the field parameter*/\r\n                        newMeasure.SetAnnotation(baseMeasureAnnotationName, m.Name);\r\n                        newMeasure.SetAnnotation(calcItemAnnotationName, calcItem.Name);\r\n                        newMeasure.SetAnnotation(scriptAnnotationName, scriptAnnotationValue);\r\n                        newMeasure.SetAnnotation(calcItemSortOrderName, calcItem.Ordinal.ToString(\"000\"));\r\n                        newMeasure.SetAnnotation(filterValueAnnotationName, filterValue);\r\n                        newMeasure.SetAnnotation(dynamicNameAnnotationName, dynamicMeasureName);\r\n\r\n\r\n                    }\r\n                }\r\n            }\r\n        }\r\n            \r\n        \r\n    }\r\n}\r\n\r\n\r\nif (!generateFieldParameter)\r\n{\r\n    //end of execution\r\n    return;\r\n};\r\n\r\n\r\n// Before running the script, select the measures or columns that you\r\n// would like to use as field parameters (hold down CTRL to select multiple\r\n// objects). Also, you may change the name of the field parameter table\r\n// below. NOTE: If used against Power BI Desktop, you must enable unsupported\r\n// features under File > Preferences (TE2) or Tools > Preferences (TE3).\r\n\r\n\r\nif (Selected.Columns.Count == 0 && Selected.Measures.Count == 0) throw new Exception(\"No columns or measures selected!\");\r\n\r\n// Construct the DAX for the calculated table based on the measures created previously by the script\r\nvar objects = Model.AllMeasures\r\n    .Where(x => x.GetAnnotation(scriptAnnotationName) == scriptAnnotationValue)\r\n    .OrderBy(x => x.GetAnnotation(baseMeasureAnnotationName) + x.GetAnnotation(calcItemSortOrderName));\r\n\r\nvar dax = \"{\\n    \" + string.Join(\",\\n    \", objects.Select((c, i) => string.Format(\"(\\\"{6}\\\", NAMEOF('{1}'[{0}]), {2},\\\"{3}\\\",\\\"{4}\\\",\\\"{5}\\\")\",\r\n    c.Name, c.Table.Name, i,\r\n    Model.Tables[c.Table.Name].Measures[c.Name].GetAnnotation(baseMeasureAnnotationName),\r\n    Model.Tables[c.Table.Name].Measures[c.Name].GetAnnotation(calcItemAnnotationName),\r\n    Model.Tables[c.Table.Name].Measures[c.Name].GetAnnotation(filterValueAnnotationName),\r\n    Model.Tables[c.Table.Name].Measures[c.Name].GetAnnotation(dynamicNameAnnotationName)\r\n    ))) + \"\\n}\";\r\n\r\n// Add the calculated table to the model:\r\nvar table = Model.AddCalculatedTable(name, dax);\r\n\r\n// In TE2 columns are not created automatically from a DAX expression, so \r\n// we will have to add them manually:\r\nvar te2 = table.Columns.Count == 0;\r\nvar nameColumn = te2 ? table.AddCalculatedTableColumn(name, \"[Value1]\") : table.Columns[\"Value1\"] as CalculatedTableColumn;\r\nvar fieldColumn = te2 ? table.AddCalculatedTableColumn(name + \" Fields\", \"[Value2]\") : table.Columns[\"Value2\"] as CalculatedTableColumn;\r\nvar orderColumn = te2 ? table.AddCalculatedTableColumn(name + \" Order\", \"[Value3]\") : table.Columns[\"Value3\"] as CalculatedTableColumn;\r\n\r\nif (!te2)\r\n{\r\n    // Rename the columns that were added automatically in TE3:\r\n    nameColumn.IsNameInferred = false;\r\n    nameColumn.Name = name;\r\n    fieldColumn.IsNameInferred = false;\r\n    fieldColumn.Name = name + \" Fields\";\r\n    orderColumn.IsNameInferred = false;\r\n    orderColumn.Name = name + \" Order\";\r\n}\r\n// Set remaining properties for field parameters to work\r\n// See: https://twitter.com/markbdi/status/1526558841172893696\r\nnameColumn.SortByColumn = orderColumn;\r\nnameColumn.GroupByColumns.Add(fieldColumn);\r\nfieldColumn.SortByColumn = orderColumn;\r\nfieldColumn.SetExtendedProperty(\"ParameterMetadata\", \"{\\\"version\\\":3,\\\"kind\\\":2}\", ExtendedPropertyType.Json);\r\nfieldColumn.IsHidden = true;\r\norderColumn.IsHidden = true;\r\n\r\n\r\npublic static class Fx\r\n{\r\n    \r\n\r\n\r\n\r\n    //in TE2 (at least up to 2.17.2) any method that accesses or modifies the model needs a reference to the model \r\n    //the following is an example method where you can build extra logic\r\n    public static Table CreateCalcTable(Model model, string tableName, string tableExpression) \r\n    { \r\n        return model.AddCalculatedTable(name:tableName,expression:tableExpression);\r\n    }\r\n\r\n    public static Table SelectTableExt(Model model, string possibleName = null, string annotationName = null, string annotationValue = null, \r\n        Func<Table,bool>  lambdaExpression = null, string label = \"Select Table\", bool skipDialogIfSingleMatch = true, bool showOnlyMatchingTables = true,\r\n        IEnumerable<Table> candidateTables = null, bool showErrorIfNoTablesFound = false, string errorMessage = \"No tables found\", bool selectFirst = false,\r\n        bool showErrorIfNoSelection = true, string noSelectionErrorMessage = \"No table was selected\", bool excludeCalcGroups = false,bool returnNullIfNoTablesFound = false)\r\n    {\r\n\r\n        Table table = null as Table;\r\n\r\n        if (lambdaExpression == null)\r\n        {\r\n            if (possibleName != null) { \r\n                lambdaExpression = (t) => t.Name == possibleName;\r\n            } else if(annotationName!= null && annotationValue != null)\r\n            {\r\n                lambdaExpression = (t) => t.GetAnnotation(annotationName) == annotationValue;\r\n            }\r\n            else\r\n            {\r\n                lambdaExpression = (t) => true; //no filtering\r\n            }\r\n        }\r\n\r\n        //use candidateTables if passed as argument\r\n        IEnumerable<Table> tables = null as IEnumerable<Table>;\r\n\r\n        if(candidateTables != null)\r\n        {\r\n            tables = candidateTables;\r\n        }\r\n        else\r\n        {\r\n            tables = model.Tables;\r\n        }\r\n\r\n        if(lambdaExpression != null)\r\n        {\r\n            tables = tables.Where(lambdaExpression);\r\n        }\r\n\r\n        if (excludeCalcGroups)\r\n        {\r\n            tables = tables.Where(t => t.ObjectType != ObjectType.CalculationGroupTable);\r\n        }\r\n\r\n        //none found, let the user choose from all tables\r\n        if (tables.Count() == 0)\r\n        {\r\n\r\n            if (returnNullIfNoTablesFound)\r\n            {\r\n                if (showErrorIfNoTablesFound) Error(errorMessage);\r\n                return table;\r\n            } \r\n            else\r\n            {\r\n                \r\n                table =  SelectTable(tables: model.Tables, label: label);\r\n            }\r\n            \r\n        }\r\n        else if (tables.Count() == 1 && !skipDialogIfSingleMatch)\r\n        {\r\n            \r\n            table = SelectTable(tables: model.Tables, preselect: tables.First(), label: label);\r\n        }\r\n        else if (tables.Count() == 1 && skipDialogIfSingleMatch)\r\n        {\r\n            table = tables.First();\r\n        } \r\n        else if (tables.Count() > 1) \r\n            \r\n        {\r\n            if (selectFirst)\r\n            {\r\n                table = tables.First();\r\n            }\r\n            else if (showOnlyMatchingTables)\r\n            {\r\n                \r\n                table = SelectTable(tables: tables, preselect: tables.First(), label: label);\r\n            }\r\n            else\r\n            {\r\n               \r\n                table = SelectTable(tables: model.Tables, preselect: tables.First(), label: label);\r\n            }\r\n            \r\n        }\r\n        else\r\n        {\r\n            Error(@\"Unexpected logic in \"\"SelectTableExt\"\"\");\r\n            return null;\r\n        }\r\n\r\n        if(showErrorIfNoSelection && table == null)\r\n        {\r\n            Error(noSelectionErrorMessage);\r\n        }\r\n\r\n        return table;\r\n\r\n    }\r\n\r\n\r\n    public static CalculationGroupTable SelectCalculationGroup(Model model, string possibleName = null, string annotationName = null, string annotationValue = null,\r\n        Func<Table, bool> lambdaExpression = null, string label = \"Select Table\", bool skipDialogIfSingleMatch = true, bool showOnlyMatchingTables = true,\r\n        bool showErrorIfNoTablesFound = true, string errorMessage = \"No calculation groups found\",bool selectFirst = false, \r\n        bool showErrorIfNoSelection = true, string noSelectionErrorMessage = \"No calculation group was selected\", bool returnNullIfNoTablesFound = false)\r\n    {\r\n\r\n        CalculationGroupTable calculationGroupTable = null as CalculationGroupTable;\r\n        \r\n        Func<Table, bool> lambda = (x) => x.ObjectType == ObjectType.CalculationGroupTable;\r\n        if (!model.Tables.Any(lambda)) return calculationGroupTable;\r\n\r\n        IEnumerable<Table> tables = model.Tables.Where(lambda);\r\n\r\n        Table table = Fx.SelectTableExt(\r\n            model:model,\r\n            possibleName:possibleName,\r\n            annotationName:annotationName,\r\n            annotationValue:annotationValue,\r\n            lambdaExpression:lambdaExpression,\r\n            label:label,\r\n            skipDialogIfSingleMatch:skipDialogIfSingleMatch,\r\n            showOnlyMatchingTables:showOnlyMatchingTables,\r\n            showErrorIfNoTablesFound:showErrorIfNoTablesFound,\r\n            errorMessage:errorMessage, \r\n            selectFirst:selectFirst,\r\n            showErrorIfNoSelection:showErrorIfNoSelection,\r\n            noSelectionErrorMessage:noSelectionErrorMessage, \r\n            returnNullIfNoTablesFound:returnNullIfNoTablesFound, \r\n            candidateTables:tables);\r\n\r\n        if(table == null) return calculationGroupTable;\r\n\r\n        calculationGroupTable = table as CalculationGroupTable;\r\n\r\n        return calculationGroupTable;\r\n\r\n    }\r\n\r\n    public static CalculationGroupTable AddCalculationGroupExt(Model model, out bool calcGroupWasCreated, string defaultName = \"New Calculation Group\", \r\n        string annotationName = null, string annotationValue = null, bool createOnlyIfNotFound = true, \r\n        string prompt = \"Name\", string Title = \"Provide a name for the Calculation Group\", bool customCalcGroupName = true)\r\n    {\r\n        \r\n        Func<Table,bool> lambda = null as Func<Table,bool>;\r\n        CalculationGroupTable cg = null as CalculationGroupTable;\r\n        calcGroupWasCreated = false;\r\n        string calcGroupName = String.Empty;\r\n\r\n        if (createOnlyIfNotFound)\r\n        {\r\n\r\n            if (annotationName == null && annotationValue == null)\r\n            {\r\n\r\n                if (customCalcGroupName)\r\n                {\r\n                    calcGroupName = Interaction.InputBox(Prompt: \"Name\", Title: \"Provide a name for the Calculation Group\");\r\n                }\r\n                else\r\n                {\r\n                    calcGroupName = defaultName;\r\n                }\r\n\r\n                cg = Fx.SelectCalculationGroup(model: model, possibleName: calcGroupName, showErrorIfNoTablesFound: false, selectFirst: true);\r\n\r\n            }\r\n            else\r\n            {\r\n                cg = Fx.SelectCalculationGroup(model: model, \r\n                    showErrorIfNoTablesFound: false, \r\n                    annotationName: annotationName, \r\n                    annotationValue: annotationValue, \r\n                    returnNullIfNoTablesFound: true);\r\n            }\r\n\r\n            if (cg != null) return cg;\r\n        }\r\n        \r\n        if (calcGroupName == String.Empty)\r\n        {\r\n            if (customCalcGroupName)\r\n            {\r\n                calcGroupName = Interaction.InputBox(Prompt: \"Name\", Title: \"Provide a name for the Calculation Group\");\r\n            }\r\n            else\r\n            {\r\n                calcGroupName = defaultName;\r\n            }\r\n        }\r\n\r\n        cg = model.AddCalculationGroup(name: calcGroupName);\r\n\r\n        if (annotationName != null && annotationValue != null)\r\n        {\r\n            cg.SetAnnotation(annotationName,annotationValue);\r\n        }\r\n\r\n        calcGroupWasCreated = true;\r\n\r\n        return cg;\r\n\r\n    }\r\n\r\n    public static CalculationItem AddCalculationItemExt(CalculationGroupTable cg, string calcItemName, string valueExpression = \"SELECTEDMEASURE()\",\r\n        string formatStringExpression = \"\", bool createOnlyIfNotFound = true, bool rewriteIfFound = false)\r\n    {\r\n\r\n        CalculationItem calcItem = null as CalculationItem;\r\n\r\n        Func<CalculationItem, bool> lambda = (ci) => ci.Name == calcItemName;\r\n\r\n        if(createOnlyIfNotFound)\r\n        {\r\n            if (cg.CalculationItems.Any(lambda))\r\n            {\r\n\r\n                calcItem = cg.CalculationItems.Where(lambda).FirstOrDefault();\r\n\r\n                if (!rewriteIfFound)\r\n                {\r\n                    return calcItem;\r\n                }\r\n            }\r\n        }\r\n\r\n\r\n        if(calcItem == null)\r\n        {\r\n            calcItem = cg.AddCalculationItem(name: calcItemName, expression: valueExpression);\r\n        }\r\n        else \r\n        {\r\n            //rewrite the found calcItem\r\n            calcItem.Expression = valueExpression;\r\n        }\r\n\r\n        if(formatStringExpression != String.Empty)\r\n        {\r\n            calcItem.FormatStringExpression = formatStringExpression;\r\n        }\r\n        \r\n        return calcItem;\r\n            \r\n    }\r\n\r\n}",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 63,
      "Name": "8. Bernats Repo\\1. Measure\\Dynamic Measure",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n\r\n// by Johnny Winter\r\n// www.greyskullanalytics.com\r\n// '2021-10-15 / B.Agullo / dynamic parameters by B.Agullo / \r\n// '2022-05-14 / B.Agullo / you can now rerun the script to simply add new measures or update existing ones\r\n// '2022-07-11 / B.Agullo / no check on the number of measures selected so it can be launched just to create the calc group table\r\n\r\n// Instructions:\r\n//select the measures you want to add to your Dynamic Measure and then run this script (or store it as macro)\r\n\r\n//\r\n// ----- do not modify script below this line -----\r\n//\r\n\r\nstring dynamicMeasureCgTag = \"@GreyskullPBI\";\r\nstring dynamicMeasureCgValue = \"Dynamic Measure Calculation Group\";\r\n\r\nstring dummyMeasureTag = dynamicMeasureCgTag;\r\nstring dummyMeasureValue = \"Dummy Measure\";\r\n\r\nstring calcGroupName = \"\";\r\nstring columnName = \"\";\r\nstring measureName = \"\";\r\nstring secondaryMeasureName = \"\";\r\nstring conditionalFormatMeasureName = \"\"; \r\n\r\nMeasure dummyMeasure = null as Measure;\r\n\r\nvar dynamicCGs = Model.Tables.Where(x => x.GetAnnotation(dynamicMeasureCgTag) == dynamicMeasureCgValue);\r\n\r\nCalculationGroupTable cgTable = null as CalculationGroupTable; \r\n// CalculationGroup cg = null as CalculationGroup;\r\n\r\nif(dynamicCGs.Count() == 1)\r\n{\r\n    //reuse the calc group\r\n    cgTable = dynamicCGs.First() as CalculationGroupTable;\r\n\r\n}\r\nelse if (dynamicCGs.Count() < 1)\r\n{\r\n    //create the calc group\r\n    calcGroupName = Interaction.InputBox(\"Provide a name for your Calc Group\", \"Calc Group Name\", \"Dynamic Measure\", 740, 400);\r\n    if (calcGroupName == \"\") return;\r\n\r\n    columnName = Interaction.InputBox(\"Calc Group column name\", \"Column Name\", calcGroupName, 740, 400);\r\n    if (columnName == \"\") return;\r\n\r\n    //check to see if a table with this name already exists\r\n    //if it doesnt exist, create a calculation group with this name\r\n    if (!Model.Tables.Contains(calcGroupName))\r\n    {\r\n        cgTable = Model.AddCalculationGroup(calcGroupName);\r\n        cgTable.Description = \"Contains dynamic measures and a column called \" + columnName + \". The contents of the dynamic measures can be controlled by selecting values from \" + columnName + \".\";\r\n    };\r\n    \r\n    //set variable for the calc group\r\n    Table calcGroup = Model.Tables[calcGroupName];\r\n\r\n    //if table already exists, make sure it is a Calculation Group type\r\n    if (calcGroup.SourceType.ToString() != \"CalculationGroup\")\r\n    {\r\n        Error(\"Table exists in Model but is not a Calculation Group. Rename the existing table or choose an alternative name for your Calculation Group.\");\r\n        return;\r\n    };\r\n\r\n    //apply the annotation so the user is not asked again\r\n    cgTable = calcGroup as CalculationGroupTable;\r\n    cgTable.SetAnnotation(dynamicMeasureCgTag, dynamicMeasureCgValue);\r\n\r\n    //by default the calc group has a column called Name. If this column is still called Name change this in line with specfied variable\r\n    if (cgTable.Columns.Contains(\"Name\"))\r\n    {\r\n        cgTable.Columns[\"Name\"].Name = columnName;\r\n    };\r\n    cgTable.Columns[columnName].Description = \"Select value(s) from this column to control the contents of the dynamic measures.\";\r\n\r\n}\r\nelse\r\n{\r\n    //make them choose the calc group -- should not happen! \r\n    cgTable = SelectTable(dynamicCGs, label: \"Select your Dynamic Measure Calculation Group For Arbitrary 2-row Header\") as CalculationGroupTable;\r\n}\r\n\r\n//get the column name in case the calc group was already there\r\ncolumnName = cgTable.Columns.Where(x => x.Name != \"Ordinal\").First().Name;\r\n\r\nvar dummyMeasures = Model.AllMeasures.Where(x => x.GetAnnotation(dummyMeasureTag) == dummyMeasureValue);\r\n\r\nif (dummyMeasures.Count() == 1)\r\n{\r\n    //get the measure\r\n    measureName = dummyMeasures.First().Name;\r\n\r\n}\r\nelse if (dummyMeasures.Count() < 1)\r\n{\r\n    //create the measure\r\n    measureName = Interaction.InputBox(\"Dynamic Measure Name (cannot be named \\\"\" + columnName + \"\\\")\", \"Measure Name\", \"Dummy\", 740, 400);\r\n    if (measureName == \"\") return;\r\n\r\n}\r\nelse\r\n{\r\n    //choose measure (should not happen!)\r\n    measureName = SelectMeasure(dummyMeasures).Name;\r\n};\r\n\r\nsecondaryMeasureName = measureName + \" 2\";\r\nconditionalFormatMeasureName = measureName + \" CF\";\r\n\r\n//check to see if dynamic measure has been created, if not create it now\r\n//if a measure with that name alredy exists elsewhere in the model, throw an error\r\nif (!cgTable.Measures.Contains(measureName))\r\n{\r\n    dummyMeasure = cgTable.AddMeasure(measureName, \"BLANK()\");\r\n    dummyMeasure.Description = \"Control the content of this measure by selecting values from \" + columnName + \".\";\r\n    dummyMeasure.SetAnnotation(dummyMeasureTag, dummyMeasureValue);\r\n};\r\n\r\nif (!cgTable.Measures.Contains(secondaryMeasureName))\r\n{\r\n    dummyMeasure = cgTable.AddMeasure(secondaryMeasureName, \"BLANK()\");\r\n    dummyMeasure.Description = \"Control the content of this measure by selecting values from \" + columnName + \". Secondary dynamic measure for complex use cases\";\r\n};\r\n\r\nif (!cgTable.Measures.Contains(conditionalFormatMeasureName))\r\n{\r\n    dummyMeasure = cgTable.AddMeasure(conditionalFormatMeasureName, \"BLANK()\");\r\n    dummyMeasure.Description = \"Control the content of this measure by selecting values from \" + columnName + \". Used this measure for conditional format purposes\";\r\n};\r\n\r\n\r\n\r\nstring isSelectedMeasureString = \"[\" + measureName + \"],[\" + secondaryMeasureName + \"],[\" + conditionalFormatMeasureName + \"]\";\r\n\r\n//if no measures were selected that's the end of the story\r\n//(only makes sense if being launched from another script and soon after will be launched against one or more measures)\r\nif (Selected.Measures.Count == 0) \r\n{\r\n    return;\r\n}\r\nforeach (var m in Selected.Measures)\r\n{\r\n    \r\n    //remove calculation item if already exists\r\n    if (cgTable.CalculationItems.Contains(m.Name)) {\r\n        cgTable.CalculationItems[m.Name].Delete();\r\n    };\r\n            \r\n    //if (!cg.CalculationItems.Contains(m.Name))\r\n    //{\r\n\r\n    var newCalcItem = \r\n        cgTable.AddCalculationItem(\r\n            m.Name, \r\n            \"IF ( \" + \"ISSELECTEDMEASURE (\" + isSelectedMeasureString + \"), \" + \"[\" + m.Name + \"], \" + \"SELECTEDMEASURE() )\"\r\n        );\r\n\r\n    // '2021-10-15 / B.Agullo / double quotes in format string need to be doubled to be preserved\r\n    newCalcItem.FormatStringExpression = \"IF ( \" + \"ISSELECTEDMEASURE (\" + isSelectedMeasureString + \"),\\\"\" + m.FormatString.Replace(\"\\\"\", \"\\\"\\\"\") + \"\\\", SELECTEDMEASUREFORMATSTRING() )\";\r\n    newCalcItem.FormatDax();\r\n\r\n\r\n    //};\r\n};",
      "Tooltip": "",
      "ValidContexts": "Model, Measure"
    },
    {
      "Id": 64,
      "Name": "8. Bernats Repo\\1. Measure\\Dynamic Measure Cambra",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n\r\n// by Johnny Winter\r\n// www.greyskullanalytics.com\r\n// '2021-10-15 / B.Agullo / dynamic parameters by B.Agullo / \r\n// '2022-05-14 / B.Agullo / you can now rerun the script to simply add new measures or update existing ones\r\n// '2022-07-11 / B.Agullo / no check on the number of measures selected so it can be launched just to create the calc group table\r\n\r\n// Instructions:\r\n//select the measures you want to add to your Dynamic Measure and then run this script (or store it as macro)\r\n\r\n//\r\n// ----- do not modify script below this line -----\r\n//\r\n\r\nstring dynamicMeasureCgTag = \"@GreyskullPBI\";\r\nstring dynamicMeasureCgValue = \"Dynamic Measure Calculation Group\";\r\n\r\nstring dummyMeasureTag = dynamicMeasureCgTag;\r\nstring dummyMeasureValue = \"Dummy Measure\";\r\n\r\nstring calcGroupName = \"\";\r\nstring columnName = \"\";\r\nstring measureName = \"\";\r\nstring secondaryMeasureName = \"\";\r\nstring conditionalFormatMeasureName = \"\"; \r\n\r\nMeasure dummyMeasure = null as Measure;\r\n\r\nvar dynamicCGs = Model.Tables.Where(x => x.GetAnnotation(dynamicMeasureCgTag) == dynamicMeasureCgValue);\r\n\r\nCalculationGroupTable cgTable = null as CalculationGroupTable; \r\n// CalculationGroup cg = null as CalculationGroup;\r\n\r\nif(dynamicCGs.Count() == 1)\r\n{\r\n    //reuse the calc group\r\n    cgTable = dynamicCGs.First() as CalculationGroupTable;\r\n\r\n}\r\nelse if (dynamicCGs.Count() < 1)\r\n{\r\n    //create the calc group\r\n    calcGroupName = Interaction.InputBox(\"Provide a name for your Calc Group\", \"Calc Group Name\", \"Dynamic Measure\", 740, 400);\r\n    if (calcGroupName == \"\") return;\r\n\r\n    columnName = Interaction.InputBox(\"Calc Group column name\", \"Column Name\", calcGroupName, 740, 400);\r\n    if (columnName == \"\") return;\r\n\r\n    //check to see if a table with this name already exists\r\n    //if it doesnt exist, create a calculation group with this name\r\n    if (!Model.Tables.Contains(calcGroupName))\r\n    {\r\n        cgTable = Model.AddCalculationGroup(calcGroupName);\r\n        cgTable.Description = \"Contains dynamic measures and a column called \" + columnName + \". The contents of the dynamic measures can be controlled by selecting values from \" + columnName + \".\";\r\n    };\r\n    \r\n    //set variable for the calc group\r\n    Table calcGroup = Model.Tables[calcGroupName];\r\n\r\n    //if table already exists, make sure it is a Calculation Group type\r\n    if (calcGroup.SourceType.ToString() != \"CalculationGroup\")\r\n    {\r\n        Error(\"Table exists in Model but is not a Calculation Group. Rename the existing table or choose an alternative name for your Calculation Group.\");\r\n        return;\r\n    };\r\n\r\n    //apply the annotation so the user is not asked again\r\n    cgTable = calcGroup as CalculationGroupTable;\r\n    cgTable.SetAnnotation(dynamicMeasureCgTag, dynamicMeasureCgValue);\r\n\r\n    //by default the calc group has a column called Name. If this column is still called Name change this in line with specfied variable\r\n    if (cgTable.Columns.Contains(\"Name\"))\r\n    {\r\n        cgTable.Columns[\"Name\"].Name = columnName;\r\n    };\r\n    cgTable.Columns[columnName].Description = \"Select value(s) from this column to control the contents of the dynamic measures.\";\r\n\r\n}\r\nelse\r\n{\r\n    //make them choose the calc group -- should not happen! \r\n    cgTable = SelectTable(dynamicCGs, label: \"Select your Dynamic Measure Calculation Group For Arbitrary 2-row Header\") as CalculationGroupTable;\r\n}\r\n\r\n//get the column name in case the calc group was already there\r\ncolumnName = cgTable.Columns.Where(x => x.Name != \"Ordinal\").First().Name;\r\n\r\nvar dummyMeasures = Model.AllMeasures.Where(x => x.GetAnnotation(dummyMeasureTag) == dummyMeasureValue);\r\n\r\nif (dummyMeasures.Count() == 1)\r\n{\r\n    //get the measure\r\n    measureName = dummyMeasures.First().Name;\r\n\r\n}\r\nelse if (dummyMeasures.Count() < 1)\r\n{\r\n    //create the measure\r\n    measureName = Interaction.InputBox(\"Dynamic Measure Name (cannot be named \\\"\" + columnName + \"\\\")\", \"Measure Name\", \"Dummy\", 740, 400);\r\n    if (measureName == \"\") return;\r\n\r\n}\r\nelse\r\n{\r\n    //choose measure (should not happen!)\r\n    measureName = SelectMeasure(dummyMeasures).Name;\r\n};\r\n\r\nsecondaryMeasureName = measureName + \" 2\";\r\nconditionalFormatMeasureName = measureName + \" CF\";\r\n\r\n//check to see if dynamic measure has been created, if not create it now\r\n//if a measure with that name alredy exists elsewhere in the model, throw an error\r\nif (!cgTable.Measures.Contains(measureName))\r\n{\r\n    dummyMeasure = cgTable.AddMeasure(measureName, \"BLANK()\");\r\n    dummyMeasure.Description = \"Control the content of this measure by selecting values from \" + columnName + \".\";\r\n    dummyMeasure.SetAnnotation(dummyMeasureTag, dummyMeasureValue);\r\n};\r\n\r\nif (!cgTable.Measures.Contains(secondaryMeasureName))\r\n{\r\n    dummyMeasure = cgTable.AddMeasure(secondaryMeasureName, \"BLANK()\");\r\n    dummyMeasure.Description = \"Control the content of this measure by selecting values from \" + columnName + \". Secondary dynamic measure for complex use cases\";\r\n};\r\n\r\nif (!cgTable.Measures.Contains(conditionalFormatMeasureName))\r\n{\r\n    dummyMeasure = cgTable.AddMeasure(conditionalFormatMeasureName, \"BLANK()\");\r\n    dummyMeasure.Description = \"Control the content of this measure by selecting values from \" + columnName + \". Used this measure for conditional format purposes\";\r\n};\r\n\r\n\r\n\r\nstring isSelectedMeasureString = \"[\" + measureName + \"],[\" + secondaryMeasureName + \"],[\" + conditionalFormatMeasureName + \"]\";\r\n\r\n//if no measures were selected that's the end of the story\r\n//(only makes sense if being launched from another script and soon after will be launched against one or more measures)\r\nif (Selected.Measures.Count == 0) \r\n{\r\n    return;\r\n}\r\nforeach (var m in Selected.Measures)\r\n{\r\n    \r\n    //remove calculation item if already exists\r\n    if (cgTable.CalculationItems.Contains(m.Name)) {\r\n        cgTable.CalculationItems[m.Name].Delete();\r\n    };\r\n            \r\n    //if (!cg.CalculationItems.Contains(m.Name))\r\n    //{\r\n\r\n    var newCalcItem = \r\n        cgTable.AddCalculationItem(\r\n            m.Name, \r\n            \"IF ( \" + \"ISSELECTEDMEASURE (\" + isSelectedMeasureString + \"), \" + \"[\" + m.Name + \"], \" + \"SELECTEDMEASURE() )\"\r\n        );\r\n\r\n    // '2021-10-15 / B.Agullo / double quotes in format string need to be doubled to be preserved\r\n    newCalcItem.FormatStringExpression = \"IF ( \" + \"ISSELECTEDMEASURE (\" + isSelectedMeasureString + \"),\\\"\" + m.FormatString.Replace(\"\\\"\", \"\\\"\\\"\") + \"\\\", SELECTEDMEASUREFORMATSTRING() )\";\r\n    newCalcItem.FormatDax();\r\n\r\n\r\n    //};\r\n};",
      "Tooltip": "creates sum measures for selected columns",
      "ValidContexts": "Measure"
    },
    {
      "Id": 65,
      "Name": "8. Bernats Repo\\5. Excel\\Export to Excel",
      "Enabled": "true",
      "Execute": "#r \"System.IO\"\r\n#r \"Microsoft.Office.Interop.Excel\"\r\n\r\nusing System.IO;\r\nusing Excel = Microsoft.Office.Interop.Excel;\r\n\r\nstring filePath = @\"G:\\Mi unidad\\CONFERENCIES POWER BI\\2022-09-30 Power BI Day Barcelona - Automatizando con Tabular Editor\\Descriptions.txt\"; // Update this to be the desired location of the Descriptions file\r\nstring excelFilePath = filePath + \".xlsx\"; \r\nstring textFilePath = filePath + \".txt\";\r\nstring excelTabName = \"ModelDescriptions\";\r\nvar sb = new System.Text.StringBuilder();\r\nstring newline = Environment.NewLine;\r\n\r\nsb.Append(\"TableName\" + '\\t' + \"ObjectType\" + '\\t' + \"ObjectName\" + '\\t' + \"HiddenFlag\" + '\\t' + \"Description\" + newline);\r\n\r\nforeach (var t in Model.Tables.Where(a => a.ObjectType.ToString() != \"CalculationGroupTable\").OrderBy(a => a.Name).ToList())\r\n{\r\n    string tableName = t.Name;\r\n    string tableDesc = t.Description;\r\n    string tblhid;\r\n    \r\n    if (t.IsHidden)\r\n    {\r\n        tblhid = \"Yes\";\r\n    }\r\n    else\r\n    {\r\n        tblhid = \"No\";\r\n    }\r\n    \r\n    sb.Append(tableName + '\\t' + \"Table\" + '\\t' + tableName + '\\t' + tblhid + '\\t' + tableDesc + newline);\r\n    \r\n    foreach (var o in t.Columns.OrderBy(a => a.Name).ToList())\r\n    {\r\n        string objName = o.Name;\r\n        string objDesc = o.Description;\r\n        string objhid;\r\n    \r\n        if (o.IsHidden)\r\n        {\r\n            objhid = \"Yes\";\r\n        }\r\n        else\r\n        {\r\n            objhid = \"No\";\r\n        }\r\n        \r\n        sb.Append(tableName + '\\t' + \"Column\" + '\\t' + objName + '\\t' + objhid + '\\t' + objDesc + newline);        \r\n    }\r\n    \r\n    foreach (var o in t.Measures.OrderBy(a => a.Name).ToList())\r\n    {\r\n        string objName = o.Name;\r\n        string objDesc = o.Description;\r\n        string objhid;\r\n    \r\n        if (o.IsHidden)\r\n        {\r\n            objhid = \"Yes\";\r\n        }\r\n        else\r\n        {\r\n            objhid = \"No\";\r\n        }\r\n        \r\n        sb.Append(tableName + '\\t' + \"Measure\" + '\\t' + objName + '\\t' + objhid + '\\t' + objDesc + newline);        \r\n    }\r\n    \r\n    foreach (var o in t.Hierarchies.OrderBy(a => a.Name).ToList())\r\n    {\r\n        string objName = o.Name;\r\n        string objDesc = o.Description;\r\n        string objhid;\r\n    \r\n        if (o.IsHidden)\r\n        {\r\n            objhid = \"Yes\";\r\n        }\r\n        else\r\n        {\r\n            objhid = \"No\";\r\n        }\r\n        \r\n        sb.Append(tableName + '\\t' + \"Hierarchy\" + '\\t' + objName + '\\t' + objhid + '\\t' + objDesc + newline);        \r\n    }    \r\n}\r\n\r\nforeach (var o in Model.CalculationGroups.OrderBy(a => a.Name).ToList())\r\n{\r\n    string tableName = o.Name;\r\n    string tableDesc = o.Description;\r\n    string tblhid;\r\n    \r\n    if (o.IsHidden)\r\n    {\r\n        tblhid = \"Yes\";\r\n    }\r\n    else\r\n    {\r\n        tblhid = \"No\";\r\n    }\r\n    \r\n    sb.Append(tableName + '\\t' + \"Calculation Group\" + '\\t' + tableName + '\\t' + tblhid + '\\t' + tableDesc + newline);  \r\n    \r\n    foreach (var i in o.CalculationItems.ToList())\r\n    {        \r\n        string objName = i.Name;\r\n        string objDesc = i.Description;\r\n        \r\n        sb.Append(tableName + '\\t' + \"Calculation Item\" + '\\t' + objName + '\\t' + \"No\" + '\\t' + objDesc + newline);        \r\n    }\r\n}\r\n\r\n// Delete existing text/Excel files\r\ntry\r\n{\r\n    File.Delete(textFilePath);\r\n    File.Delete(excelFilePath);\r\n}\r\ncatch\r\n{\r\n}\r\n\r\n// Save to text file\r\nSaveFile(textFilePath, sb.ToString());\r\n\r\n// Save to Excel file\r\nvar excelApp = new Excel.Application();\r\nexcelApp.Visible = false;\r\nexcelApp.DisplayAlerts = false;\r\nexcelApp.Workbooks.OpenText(textFilePath, 65001, 1, Excel.XlTextParsingType.xlDelimited, Excel.XlTextQualifier.xlTextQualifierNone, false, true, false, false, false, false, false, Type.Missing, Type.Missing, Type.Missing, Type.Missing, true, Type.Missing);\r\n\r\nvar wb = excelApp.ActiveWorkbook;\r\nvar ws = wb.ActiveSheet as Excel.Worksheet;\r\nws.Name = excelTabName;\r\nwb.SaveAs(excelFilePath, Excel.XlFileFormat.xlWorkbookDefault, Type.Missing, Type.Missing, Type.Missing, Type.Missing, Excel.XlSaveAsAccessMode.xlNoChange);\r\n\r\n// Close workbook and quit Excel program\r\nwb.Close();\r\nexcelApp.Quit();\r\nSystem.Runtime.InteropServices.Marshal.ReleaseComObject(excelApp);\r\n\r\n// Delete text file as it is no longer necessary\r\ntry\r\n{\r\n    File.Delete(textFilePath);\r\n}\r\ncatch\r\n{\r\n}",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 66,
      "Name": "8. Bernats Repo\\1. Measure\\Filtered Measures",
      "Enabled": "true",
      "Execute": "// '2022-09-24 / B.Agullo / Removed ScriptHost to make it TE2 compatible\r\n// '2022-05-21 / B.Agullo / \r\n// FILTERED MEASURES BY COLUMN VALUES SCRIPT \r\n// creates a measure for each of the values in a column filtering the selected base measure\r\n// step by step instructions at https://www.esbrina-ba.com/creating-filtered-measures-or-how-to-show-the-total-along-with-the-detail-in-a-chart/\r\n\r\nvar measures = Selected.Measures;\r\n\r\nif (measures.Count == 0)\r\n{\r\n    Error(\"Select one or more measures\");\r\n}\r\n\r\nTable table = SelectTable();\r\nColumn column = SelectColumn(table);\r\n\r\nstring query = \"EVALUATE DISTINCT(\" + column.DaxObjectFullName + \")\";\r\n\r\nusing (var reader = Model.Database.ExecuteReader(query))\r\n{\r\n    // Create a loop for every row in the resultset\r\n    while (reader.Read())\r\n    {\r\n        string columnValue = reader.GetValue(0).ToString();\r\n        string formulaColumnValue = columnValue; \r\n\r\n\r\n\r\n        if (column.DataType.Equals(DataType.String))\r\n        {\r\n            formulaColumnValue = \"\\\"\" + columnValue + \"\\\"\";\r\n        }\r\n\r\n\r\n        foreach (Measure measure in measures)\r\n        {\r\n            string measureName = measure.Name + \" \" + columnValue;\r\n            string measureExpression =\r\n                string.Format(\"CALCULATE({0},{1}={2})\",\r\n                    measure.DaxObjectName,\r\n                    column.DaxObjectFullName,\r\n                    formulaColumnValue\r\n                );\r\n            string measureDescription =\r\n                string.Format(\"{0} filtered by {1} = {2}\",\r\n                    measure.Name,\r\n                    column.Name,\r\n                    columnValue\r\n               );\r\n            string displayFolderName =\r\n                string.Format(\"{0} by {1}\",\r\n                    measure.Name,\r\n                    column.Name\r\n                );\r\n            Measure newMeasure =\r\n                measure.Table.AddMeasure(\r\n                    name: measureName,\r\n                    expression: measureExpression,\r\n                    displayFolder: displayFolderName\r\n                );\r\n            newMeasure.Description = measureDescription;\r\n            newMeasure.FormatDax();\r\n            newMeasure.FormatString = measure.FormatString;\r\n\r\n\r\n        }\r\n    }\r\n}",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 67,
      "Name": "8. Bernats Repo\\4. Check\\HAS DATA",
      "Enabled": "true",
      "Execute": "// '2023-06-08 / B.Agullo / Creates a measure to show only relevant items in slicers for a fact table.\r\n\r\n\r\nif(Selected.Tables.Count() == 0)\r\n{\r\n    Error(\"Select at least one table and try again\");\r\n    return;\r\n}\r\nforeach(Table table in Selected.Tables)\r\n{\r\n    string measureExpression = String.Format(@\"INT(NOT ISEMPTY({0}))\",table.DaxObjectFullName);\r\n    string measureName = table.Name + \" has data\";\r\n    string measureDescription = String.Format(@\"Returns 1 if {0} has visible rows in filter context, 0 otherwise. Can be used to show only relevant slicer items.\", table.DaxObjectFullName);\r\n    Measure measure = table.AddMeasure(measureName, measureExpression);\r\n    measure.Description = measureDescription;\r\n}",
      "Tooltip": "creates sum measures for selected columns",
      "ValidContexts": "Table"
    },
    {
      "Id": 68,
      "Name": "8. Bernats Repo\\5. Excel\\Import From Excel",
      "Enabled": "true",
      "Execute": "#r \"System.IO\"\r\n#r \"Microsoft.Office.Interop.Excel\"\r\n\r\nusing System.IO;\r\nusing Excel = Microsoft.Office.Interop.Excel;\r\n\r\nstring filePath = @\"G:\\Mi unidad\\CONFERENCIES POWER BI\\2022-09-30 Power BI Day Barcelona - Automatizando con Tabular Editor\\Descriptions.txt\"; // Update this to be the location of the Descriptions file\r\nstring excelFilePath = filePath + \".xlsx\"; \r\nstring excelTabName = \"ModelDescriptions\";\r\n\r\n// Open Excel\r\nvar excelApp = new Excel.Application();\r\nexcelApp.Visible = false;\r\nexcelApp.DisplayAlerts = false;\r\n\r\n// Open Workbook, Worksheet\r\nvar wb = excelApp.Workbooks.Open(excelFilePath); \r\nvar ws = wb.Worksheets[excelTabName] as Excel.Worksheet;\r\n\r\n// Count rows and columns\r\nExcel.Range xlRange = ws.UsedRange;\r\n\r\nint rowCount = xlRange.Rows.Count;\r\n\r\nfor (int r = 2; r <= rowCount; r++)\r\n{\r\n    string tableName = (string)(ws.Cells[r,1] as Excel.Range).Text.ToString();\r\n    string objType = (string)(ws.Cells[r,2] as Excel.Range).Text.ToString();\r\n    string objName = (string)(ws.Cells[r,3] as Excel.Range).Text.ToString();\r\n    string desc = (string)(ws.Cells[r,5] as Excel.Range).Text.ToString();\r\n    \r\n    if (objType == \"Table\")\r\n    {\r\n        try\r\n        {\r\n            Model.Tables[tableName].Description = desc;\r\n        }\r\n        catch\r\n        {\r\n        }\r\n    }\r\n    else if (objType == \"Column\")\r\n    {\r\n        try\r\n        {\r\n            Model.Tables[tableName].Columns[objName].Description = desc;\r\n        }\r\n        catch\r\n        {            \r\n        }\r\n    }\r\n    else if (objType == \"Measure\")\r\n    {\r\n        try\r\n        {\r\n            Model.Tables[tableName].Measures[objName].Description = desc;\r\n        }\r\n        catch\r\n        {\r\n        }\r\n    }\r\n    else if (objType == \"Hierarchy\")\r\n    {\r\n        try\r\n        {\r\n            Model.Tables[tableName].Hierarchies[objName].Description = desc;\r\n        }\r\n        catch\r\n        {\r\n        }\r\n    }\r\n    else if (objType == \"Calculation Group\")\r\n    {\r\n        try\r\n        {\r\n            Model.Tables[tableName].Description = desc;\r\n        }\r\n        catch\r\n        {\r\n        }\r\n    }\r\n    else if (objType == \"Calculation Item\")\r\n    {\r\n        try\r\n        {\r\n            (Model.Tables[tableName] as CalculationGroupTable).CalculationItems[objName].Description = desc;\r\n        }\r\n        catch\r\n        {\r\n        }\r\n    }\r\n}\r\n\r\n// Close workbook and quit Excel program\r\nwb.Close();\r\nexcelApp.Quit();\r\nSystem.Runtime.InteropServices.Marshal.ReleaseComObject(excelApp);",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 69,
      "Name": "8. Bernats Repo\\3. Calc Group\\Mask Calc Group Test",
      "Enabled": "true",
      "Execute": "if(Selected.Measures.Count() != 1)\r\n{\r\n    Error(\"No measures seleted\");\r\n    return;\r\n}\r\nMeasure targetMeasure = Selected.Measure;\r\nTable table = SelectTable(label: \"Pick the table of the slicing column\");\r\nif(table == null) { return; };\r\nColumn column = SelectColumn(table, label: \"Pick the slicing column\");\r\nif(column == null) { return; };\r\nMeasure sliderMeasure = SelectMeasure(label:\"Pick Slider Measure\");\r\nCalculationGroupTable cg = Model.AddCalculationGroup(\"Mask\");\r\nstring calcItemName = \"Mask\";\r\nstring calcItemExpression = \"SELECTEDMEASURE()\";\r\nstring calcItemFormatString =\r\n    String.Format(@\"VAR threshold = {2}\r\n    VAR tbl =\r\n        CALCULATETABLE(\r\n            ADDCOLUMNS(\r\n                VALUES( {1} ),\r\n                \"\"@{3}\"\", {0}\r\n            ),\r\n            ALLSELECTED( {1} )\r\n        )\r\n    VAR tbl2 =\r\n        ADDCOLUMNS(\r\n            tbl,\r\n            \"\"@RANK\"\", RANKX( tbl, [@{3}], , ASC, SKIP )\r\n        )\r\n    VAR valuesUnderThreshold =\r\n        COUNTROWS( FILTER( tbl2, [@{3}] < threshold ) )\r\n    VAR valuesToMask =\r\n        switch( \r\n            TRUE(),\r\n            valuesUnderThreshold = 0, 0,\r\n            valuesUnderThreshold < 2, 2, \r\n            valuesUnderThreshold\r\n        )\r\n    VAR currentRank = \r\n        VAR tbl = \r\n        CALCULATETABLE(\r\n            VALUES({1}),\r\n            ALLSELECTED({1})\r\n        )\r\n        RETURN \r\n            RANKX(tbl,{0}, ,ASC)\r\n    VAR result =\r\n        IF( currentRank <= valuesToMask, \"\"'*'\"\", SELECTEDMEASUREFORMATSTRING( ) )\r\n    RETURN\r\n        result\", \r\n    targetMeasure.DaxObjectFullName,\r\n    column.DaxObjectFullName,\r\n    sliderMeasure.DaxObjectFullName,\r\n    targetMeasure.Name);\r\nCalculationItem calcItem = cg.AddCalculationItem(calcItemName,calcItemExpression);\r\ncalcItem.FormatStringExpression = calcItemFormatString;\r\ncalcItem.FormatDax();\r\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 70,
      "Name": "8. Bernats Repo\\1. Measure\\MAX",
      "Enabled": "true",
      "Execute": "string annotationLabel = \"Namasdata\";\r\nstring annotationValue = \"Statistics\";\r\nif(Selected.Columns.Count() != 1)\r\n{\r\n    Error(\"Selecciona una única columna y vuelve a intentarlo\");\r\n    return;\r\n}\r\nColumn sliceColumn = Selected.Column;\r\nCalculationGroupTable statisticsCG = null as CalculationGroupTable;\r\nif(Model.Tables.Any(t => t.GetAnnotation(annotationLabel) == annotationValue))\r\n{\r\n    statisticsCG = Model.Tables.Where(t => t.GetAnnotation(annotationLabel) == annotationValue).First() as CalculationGroupTable;\r\n} else\r\n{\r\n    statisticsCG = Model.AddCalculationGroup(\"Statistics\");\r\n    statisticsCG.SetAnnotation(annotationLabel, annotationValue);\r\n}\r\nstring calcItemName = \"MAX\";\r\nstring calcItemExpression =\r\n    String.Format(\r\n        @\"MAXX (\r\n            VALUES ( {0} ),\r\n            SELECTEDMEASURE ()\r\n        )\", sliceColumn.DaxObjectFullName);\r\nCalculationItem calcItem = statisticsCG.AddCalculationItem(calcItemName, calcItemExpression);\r\ncalcItem.FormatDax();\r\n",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 71,
      "Name": "8. Bernats Repo\\1. Measure\\Measure in Calc Item",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n\r\n// CHANGE LOG: \r\n// '2021-10-20 / B.Agullo / \r\n// '2021-11-22 / B.Agullo / Totally rewrote the script as did not work the way it was \r\n\r\n\r\n// Instructions:\r\n// select the calculation items and and the measure(s) for which the calculation should be shown. \r\n// the first time you will be asked to introduce a name for your calc group and dummy measure \r\n// second time on it will reuse the same group and dummy measure to add new calc items \r\n// the script will create a new calc item for eachs elected measure\r\n// A pop-up will show if the measure has been previously selected and thus already has a calculation item with its name\r\n\r\n\r\n//\r\n// ----- do not modify script below this line -----\r\n//\r\n\r\nstring affectedMeasures = \"\"; \r\nstring selectedCalcItems = \"\"; \r\nstring selectedCalcItemsCalcGroupName = \"\"; \r\n\r\nCalculationGroup selectedCalculationGroup = null as CalculationGroup; \r\nColumn selectedCalcItemsCalcGroupColumn = null as Column; \r\n\r\nif (Selected.Measures.Count == 0) {\r\n    \r\n    Error(\"No measures selected\"); \r\n    return; \r\n\r\n} else if (Selected.CalculationItems.Count == 0) { \r\n    \r\n    Error(\"No calculation items selected\"); \r\n    return; \r\n\r\n} else {\r\n    \r\n    // create in-line table with selected calc item names \r\n    foreach(var ci in Selected.CalculationItems) { \r\n        \r\n        if(selectedCalcItems == \"\") {\r\n            selectedCalcItems += \"{\\\"\" + ci.Name + \"\\\"\"; \r\n\r\n        } else { \r\n            \r\n            selectedCalcItems += \",\\\"\" + ci.Name + \"\\\"\"; \r\n\r\n        }; \r\n        \r\n        if(selectedCalcItemsCalcGroupName == \"\") {\r\n             \r\n            //selectedCalculationGroup = ci.CalculationGroupTable;\r\n            selectedCalcItemsCalcGroupName = ci.CalculationGroupTable.Name; \r\n            \r\n        };\r\n        \r\n        if(selectedCalcItemsCalcGroupColumn == null) {\r\n            \r\n            //get the only column that is not \"ordinal\"\r\n            selectedCalcItemsCalcGroupColumn = (ci.CalculationGroupTable as Table).Columns.Where(x => x.Name != \"Ordinal\").First(); \r\n            \r\n        };\r\n    };  \r\n    \r\n    selectedCalcItems += \"}\"; \r\n    \r\n};\r\n\r\nstring calcGroupTag = \"Dynamic Measure Calculation Group For Arbitrary 2-row Header\";\r\nstring dummyMeasureTag = \"Dummy Measure for the Dynamic Measure Calculation Group For Arbitrary 2-row Header\";\r\n\r\n//dynamic Measure CG for 2 row header\r\nvar DynamicMeasureCGs = Model.Tables.Where(x => x.GetAnnotation(\"@AgulloBernat\") == calcGroupTag);\r\n\r\nvar DynamicMeasureCG = null as CalculationGroupTable; \r\n\r\nif (DynamicMeasureCGs.Count() == 1 ) {\r\n    \r\n    DynamicMeasureCG = DynamicMeasureCGs.First() as CalculationGroupTable;\r\n    \r\n} else if (DynamicMeasureCGs.Count() < 1) {\r\n    \r\n    string calcGroupName = \r\n        Interaction.InputBox(\r\n            \"Provide a name for your Dynamic Measure Calculation Group For Arbitrary 2-row Header\", \r\n            \"Calculation Group Name\", \"\", 740, 400\r\n        );\r\n\r\n    if(calcGroupName == \"\") {\r\n        \r\n        Error(\"No name provided\");         \r\n        return;\r\n        \r\n    };\r\n    \r\n    DynamicMeasureCG = Model.AddCalculationGroup(calcGroupName);\r\n    DynamicMeasureCG.Description = \r\n        \"Under this calc group only certain calculation items of \" \r\n            + selectedCalcItemsCalcGroupName \r\n            + \" calculation group will be visible and with a certain measure. See calculation items for details\";\r\n    \r\n    DynamicMeasureCG.SetAnnotation(\"@AgulloBernat\",calcGroupTag);\r\n    Model.Tables[calcGroupName].Columns[\"Name\"].Name = calcGroupName; \r\n\r\n} else {\r\n    \r\n    //this should never happen --\r\n    DynamicMeasureCG = SelectTable(DynamicMeasureCGs, label:\"Select your Dynamic Measure Calculation Group For Arbitrary 2-row Header\") as CalculationGroupTable;\r\n    \r\n};\r\n\r\nif (DynamicMeasureCG == null) { return; } // doesn't work in TE3 as cancel button doesn't return null in TE3\r\n\r\n//INIT DUMMY MEASURE (if necessary) \r\nvar dummyMeasureCandidates = DynamicMeasureCG.Measures.Where(x => x.GetAnnotation(\"@AgulloBernat\") == dummyMeasureTag);\r\nMeasure dummyMeasure = null as Measure; \r\n\r\nif (dummyMeasureCandidates.Count() == 1) {\r\n    \r\n    dummyMeasure = dummyMeasureCandidates.First() as Measure; \r\n\r\n} else if (dummyMeasureCandidates.Count() < 1) {\r\n    \r\n    string dummyMeasureName = Interaction.InputBox(\"Enter a name for the dummy measure\", \"Measure Name\", \"\", 740, 400);\r\n\r\n    if(dummyMeasureName == \"\") {\r\n        \r\n        Error(\"No name provided\");         \r\n        return;\r\n        \r\n    };\r\n    \r\n    //add dummy measure if not present yet\r\n    if(!DynamicMeasureCG.Measures.Where(m => m.Name == dummyMeasureName).Any())  {\r\n        \r\n        dummyMeasure = DynamicMeasureCG.AddMeasure(dummyMeasureName,\"0\");\r\n        \r\n    } else { \r\n        \r\n        //get the reference if already exists \r\n        dummyMeasure = DynamicMeasureCG.Measures.Where(m => m.Name == dummyMeasureName).First(); \r\n        \r\n    };\r\n\r\n    //in any case add the annotation so it will be found next time \r\n    dummyMeasure.SetAnnotation(\"@AgulloBernat\",dummyMeasureTag); \r\n\r\n} else {\r\n    \r\n    dummyMeasure = \r\n        SelectMeasure(\r\n            dummyMeasureCandidates,\r\n            label:\"Select your Dummy Measure for your Dynamic Measure Calculation Group For Arbitrary 2-row Header\"\r\n        ) as Measure; \r\n\r\n} ; \r\n\r\nforeach (var m in Selected.Measures) { \r\n    \r\n    if (!DynamicMeasureCG.CalculationItems.Where(x => x.Name == m.Name).Any()) { \r\n        \r\n        string newCalcItemName = m.Name; \r\n        string newCalcItemExpression = \r\n             \"IF(\" + \r\n             \"    ISSELECTEDMEASURE( [\" + dummyMeasure.Name + \"] ),\" + \r\n             \"    VAR currentCalcItem =\" + \r\n             \"        SELECTEDVALUE( \"+  selectedCalcItemsCalcGroupColumn.DaxObjectFullName +\", \\\"NO SELECTION\\\" )\" + \r\n             \"    RETURN\" + \r\n             \"        IF( currentCalcItem IN \" + selectedCalcItems + \", [\" + m.Name + \"] ),\" + \r\n             \"    SELECTEDMEASURE()\" + \r\n             \")\";\r\n        \r\n        CalculationItem newCalcItem =  DynamicMeasureCG.AddCalculationItem(newCalcItemName, newCalcItemExpression); \r\n        newCalcItem.FormatDax(); \r\n        \r\n    } else { \r\n        \r\n        Info(\"Calculation item \" + m.Name + \" already present. Please modify manually, or delete it and try again\"); \r\n        \r\n    };\r\n    \r\n}; \r\n\r\nCallDaxFormatter(); ",
      "Tooltip": "",
      "ValidContexts": "Measure, CalculationItem"
    },
    {
      "Id": 72,
      "Name": "8. Bernats Repo\\1. Measure\\Measures from Calculation Group",
      "Enabled": "true",
      "Execute": "/* '2022-06-13 / B.Agullo / */\r\n/* CREATE MEASURES WITH BASE MEASURES AND A CALCULATION GROUP */ \r\n/* https://www.esbrina-ba.com/creating-well-formatted-measures-based-on-a-calculation-group/  */\r\n/* select measures and execute, you will need to run it twice */ \r\n/* first time to create aux calc group, second time to actually create measuree*/ \r\n/* remove aux calc group before going to production, do the right thing */ \r\n\r\nstring auxCgTag = \"@AgulloBernat\";\r\nstring auxCgTagValue = \"CG to extract format strings\";\r\n\r\nstring auxCalcGroupName = \"DELETE AUX CALC GROUP\";\r\nstring auxCalcItemName = \"Get Format String\";\r\n\r\n/*find any regular CGs (excluding the one we might have created)*/\r\nvar regularCGs = Model.Tables.Where(\r\n    x => x.ObjectType == ObjectType.CalculationGroupTable\r\n    & x.GetAnnotation(auxCgTag) != auxCgTagValue);\r\n\r\nif (regularCGs.Count() == 0)\r\n{\r\n    Error(\"No Calculation Groups Found\");\r\n    return;\r\n};\r\n\r\n/*check if we already created the auxiliary calculation group*/\r\nvar auxCgs = Model.Tables.Where(x => x.GetAnnotation(auxCgTag) == auxCgTagValue);\r\n\r\nCalculationGroupTable auxCg = null as CalculationGroupTable; \r\n\r\n/*if there are more than one for some reason we'll just use the first one*/\r\nif(auxCgs.Count() >= 1)\r\n{\r\n    auxCg = auxCgs.First() as CalculationGroupTable; \r\n} else \r\n{\r\n    /*create the aux calc group and ask for a refresh since it cannot be used in a query before that*/\r\n    auxCg = Model.AddCalculationGroup(name: auxCalcGroupName);\r\n    auxCg.AddCalculationItem(name: auxCalcItemName, expression: \"SELECTEDMEASUREFORMATSTRING()\");\r\n    auxCg.SetAnnotation(auxCgTag, auxCgTagValue);\r\n\r\n    /*better hidden in case someone forgets to delete it*/\r\n    auxCg.IsHidden = true; \r\n    int maxPrecedence = 0; \r\n\r\n    /*check for the max precedence of other calc groups*/\r\n    foreach (CalculationGroupTable cg in regularCGs)\r\n    {\r\n        if (cg.CalculationGroupPrecedence > maxPrecedence)\r\n        {\r\n            maxPrecedence = cg.CalculationGroupPrecedence;\r\n        };\r\n    };\r\n\r\n    /*assign the highest precedence and some margin*/\r\n    auxCg.CalculationGroupPrecedence = maxPrecedence + 10; \r\n\r\n    Info(\"Save changes to the model, recalculate the model, and launch the script again.\");\r\n    return;\r\n\r\n};\r\n\r\n/*check if any measures are selected*/\r\nif (Selected.Measures.Count == 0)\r\n{\r\n    Error(\"No measures selected\");\r\n    return;\r\n}\r\n\r\nCalculationGroupTable regularCg = null as CalculationGroupTable;\r\n\r\n/*allow user to select calculation group if more than one is found*/\r\nif (regularCGs.Count() > 1)\r\n{\r\n    regularCg = SelectTable(regularCGs) as CalculationGroupTable;\r\n}\r\n/*otherwise just pick the first (and only)*/\r\nelse\r\n{\r\n    regularCg = regularCGs.First() as CalculationGroupTable;\r\n}\r\n\r\n/*check if no selection was made*/ \r\nif(regularCg == null)\r\n{\r\n    Error(\"No Target Calculation Group selected\");\r\n    return;\r\n};\r\n\r\n/*iterates through each selected measure*/\r\nforeach (Measure m in Selected.Measures)\r\n{\r\n    /*prepares a displayfolder to store all new measures*/\r\n    string displayFolderName = m.Name + \" Measures\";\r\n\r\n    /*iterates thorough all calculation items of the selected calc group*/ \r\n    foreach (CalculationItem calcItem in regularCg.CalculationItems)\r\n    {\r\n        \r\n        /*prepares a query to calculate the resulting format when applying the calculation item on the measure*/ \r\n        string query = string.Format(\r\n            \"EVALUATE {{CALCULATE({0},{1},{2})}}\",\r\n            m.DaxObjectFullName,\r\n            string.Format(\r\n                \"{0}=\\\"{1}\\\"\",\r\n                regularCg.Columns[0].DaxObjectFullName,\r\n                calcItem.Name),\r\n            string.Format(\r\n                \"{0}=\\\"{1}\\\"\",\r\n                auxCg.Columns[0].DaxObjectFullName,\r\n                auxCalcItemName)\r\n            );\r\n\r\n        /*executes the query*/ \r\n        using (var reader = Model.Database.ExecuteReader(query))\r\n        {\r\n            // resultset should contain just one row, with the format string\r\n            while (reader.Read())\r\n            {\r\n                /*retrive the formatstring from the query*/ \r\n                string formatString = reader.GetValue(0).ToString();\r\n\r\n                /*build the expression of the measure*/\r\n                string measureExpression = string.Format(\r\n                    \"CALCULATE({0},{1}=\\\"{2}\\\")\",\r\n                    m.DaxObjectName,\r\n                    regularCg.Columns[0].DaxObjectFullName,\r\n                    calcItem.Name);\r\n\r\n                /*measure name*/ \r\n                string measureName = m.Name + \" \" + calcItem.Name;\r\n                \r\n                /*actually build the measure*/ \r\n                Measure newMeasure = \r\n                    m.Table.AddMeasure(\r\n                        name: measureName,\r\n                        expression: measureExpression);\r\n\r\n\r\n                /*the all important format string!*/\r\n                newMeasure.FormatString = formatString;\r\n\r\n                /*final polish*/\r\n                newMeasure.DisplayFolder = displayFolderName;\r\n                newMeasure.FormatDax();\r\n\r\n            }\r\n        }\r\n    } \r\n}",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 73,
      "Name": "8. Bernats Repo\\1. Measure\\MIN",
      "Enabled": "true",
      "Execute": "string annotationLabel = \"Namasdata\";\r\nstring annotationValue = \"Statistics\";\r\nif (Selected.Columns.Count() != 1)\r\n{\r\n    Error(\"Selecciona una única columna y vuelve a intentarlo\");\r\n    return;\r\n}\r\nColumn sliceColumn = Selected.Column;\r\nCalculationGroupTable statisticsCG = null as CalculationGroupTable;\r\nif (Model.Tables.Any(t => t.GetAnnotation(annotationLabel) == annotationValue))\r\n{\r\n    statisticsCG = Model.Tables.Where(t => t.GetAnnotation(annotationLabel) == annotationValue).First() as CalculationGroupTable;\r\n}\r\nelse\r\n{\r\n    statisticsCG = Model.AddCalculationGroup(\"Statistics\");\r\n    statisticsCG.SetAnnotation(annotationLabel, annotationValue);\r\n}\r\nstring calcItemName = \"MIN\";\r\nstring calcItemExpression =\r\n    String.Format(\r\n        @\"MINX (\r\n            VALUES ( {0} ),\r\n            SELECTEDMEASURE ()\r\n        )\", sliceColumn.DaxObjectFullName);\r\nCalculationItem calcItem = statisticsCG.AddCalculationItem(calcItemName, calcItemExpression);\r\ncalcItem.FormatDax();\r\n",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 74,
      "Name": "8. Bernats Repo\\1. Measure\\MultiTotal (add total)",
      "Enabled": "true",
      "Execute": "string calcGroupTypeLabel = \"CalcGroupType\";\r\nstring calcGroupTypeValue = \"MultiTotal\";\r\nIEnumerable<Table> multiTotalCalcGroups = \r\n    Model.Tables.Where(\r\n        t => \r\n        t.GetAnnotation(calcGroupTypeLabel) \r\n            == calcGroupTypeValue);\r\nTable calcGroupAsTable = null as Table; \r\nif(multiTotalCalcGroups.Count() == 0)\r\n{\r\n    Error(\"No multi-total calc group found. \" +\r\n        \"Run the macro to create a multi-total \" +\r\n        \"calc group first and try again\");\r\n    return;\r\n} else if(multiTotalCalcGroups.Count() == 1)\r\n{\r\n    calcGroupAsTable = multiTotalCalcGroups.First();\r\n}\r\nelse\r\n{\r\n    calcGroupAsTable = SelectTable(multiTotalCalcGroups, label: \"Select Multi-total Calc Group to use\");\r\n    if(calcGroupAsTable == null)\r\n    {\r\n        Error(\"You cancelled the execution.\");\r\n        return;\r\n    }\r\n}\r\nif(Selected.CalculationItems.Count() == 0)\r\n{\r\n    Error(\"Select one or more calculation items and try again.\");\r\n    return;\r\n}\r\nstring calcGroupValuesFieldLabel = \"ValuesField\";\r\nstring multiTotalBreakDownColumnCode = calcGroupAsTable.GetAnnotation(calcGroupValuesFieldLabel);\r\nCalculationGroupTable calcGroup = calcGroupAsTable as CalculationGroupTable;\r\nforeach(CalculationItem calcItem in Selected.CalculationItems)\r\n{\r\n    string calcItemName = calcItem.Name;\r\n    string calcItemExpression =\r\n        String.Format(\r\n            @\"IF(\r\n                NOT ISINSCOPE( {0} ),\r\n                CALCULATE(\r\n                    SELECTEDMEASURE( ),\r\n                    {1} = \"\"{2}\"\"\r\n                )\r\n            )\",\r\n            multiTotalBreakDownColumnCode,\r\n            calcItem.CalculationGroupTable.Columns[0].DaxObjectFullName,\r\n            calcItem.Name);\r\n    CalculationItem customTotalCalcItem = \r\n        calcGroup.AddCalculationItem(\r\n            name:calcItemName, \r\n            expression:calcItemExpression);\r\n    string calcItemFormatStringExpression =\r\n        String.Format(\r\n            @\"IF(\r\n                NOT ISINSCOPE( {0} ),\r\n                CALCULATE(\r\n                    SELECTEDMEASUREFORMATSTRING( ),\r\n                    {1} = \"\"{2}\"\"\r\n                )\r\n            )\",\r\n            multiTotalBreakDownColumnCode,\r\n            calcItem.CalculationGroupTable.Columns[0].DaxObjectFullName,\r\n            calcItem.Name);\r\n    customTotalCalcItem.FormatStringExpression = \r\n        calcItemFormatStringExpression;\r\n    customTotalCalcItem.FormatDax();\r\n}",
      "Tooltip": "",
      "ValidContexts": "CalculationItem"
    },
    {
      "Id": 75,
      "Name": "8. Bernats Repo\\1. Measure\\MultiTotal (base)",
      "Enabled": "true",
      "Execute": "// '2023-07-09 / B.Agullo / \r\n//\r\n// Multi-Total Calc Group: Base script\r\n//\r\n// The development of this script is shown here https://www.esbrina-ba.com/industrializing-calculation-groups/\r\n// store as macro and select only column as target object\r\n// to use the right click on a single column you want to use to slice your data from the columns section of your matrix.\r\n// to add custom totals to the matrix using this calc group as top level column field, you need to run \r\n// the script shared in the file \"Multi-Total Calc Group (add total script).csx\" in this same repository folder. \r\n//\r\n// Follow Bernat on LinkedIn and Twitter\r\n// https://www.linkedin.com/in/bernatagullo/\r\n// https://twitter.com/AgulloBernat\r\n\r\n#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n\r\nif (Selected.Columns.Count() != 1)\r\n{\r\n    Error(\"Select only 1 column and try again\");\r\n    return;\r\n}\r\nColumn column = Selected.Column;\r\nstring suggestedCalcGroupName = column.Name + \" Multi-Totals\";\r\nstring calcGroupName = Interaction.InputBox(\r\n    Prompt:\"Please provide the name of the multi-total calc group.\",\r\n    DefaultResponse:suggestedCalcGroupName);\r\nif (calcGroupName == \"\")\r\n{\r\n    Error(\"No name provided\");\r\n    return;\r\n};\r\nCalculationGroupTable calcGroup = \r\n    Model.AddCalculationGroup(\r\n        calcGroupName);\r\nstring valuesCalcItemName = \"Values\";\r\nstring valuesCalcItemExpression =\r\n    String.Format(\r\n        @\"IF(\r\n            ISINSCOPE( {0} ),\r\n            SELECTEDMEASURE()\r\n        )\", column.DaxObjectFullName);\r\nCalculationItem valuesCalcItem =\r\n    calcGroup.AddCalculationItem(\r\n        name: valuesCalcItemName,\r\n        expression: valuesCalcItemExpression);\r\nvaluesCalcItem.FormatDax();\r\nvaluesCalcItem.Description = \"This calculation item is to show the breakdown by \" + column.Name;\r\nvaluesCalcItem.Ordinal = 0;\r\nstring totalCalcItemName = \"Total\";\r\nstring totalCalcItemExpression =\r\n    String.Format(\r\n        @\"IF(\r\n            NOT ISINSCOPE( {0} ),\r\n            SELECTEDMEASURE()\r\n        )\", column.DaxObjectFullName);\r\nCalculationItem totalCalcItem =\r\n    calcGroup.AddCalculationItem(\r\n        name: totalCalcItemName,\r\n        expression: totalCalcItemExpression);\r\ntotalCalcItem.FormatDax();\r\ntotalCalcItem.Description = \"This calculation item is to show the regular total as a calculation item along with different totals that will be added to this calculation group\";\r\ntotalCalcItem.Ordinal = 1; \r\nstring calcGroupTypeLabel = \"CalcGroupType\";\r\nstring calcGroupTypeValue = \"MultiTotal\";\r\ncalcGroup.SetAnnotation(\r\n    calcGroupTypeLabel,\r\n    calcGroupTypeValue);\r\nstring calcGroupValuesFieldLabel = \"ValuesField\";\r\nstring calcGroupValuesFieldValue = column.DaxObjectFullName;\r\ncalcGroup.SetAnnotation(\r\n    calcGroupValuesFieldLabel,\r\n    calcGroupValuesFieldValue);",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 76,
      "Name": "8. Bernats Repo\\3. Calc Group\\Multi-Total Calc Group",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n\r\nif (Selected.Columns.Count() != 1)\r\n{\r\n    Error(\"Select only 1 column and try again\");\r\n    return;\r\n}\r\nColumn column = Selected.Column;\r\nstring suggestedCalcGroupName = column.Name + \" Multi-Totals\";\r\nstring calcGroupName = Interaction.InputBox(\r\n    Prompt:\"Please provide the name of the multi-total calc group.\",\r\n    DefaultResponse:suggestedCalcGroupName);\r\nif (calcGroupName == \"\")\r\n{\r\n    Error(\"No name provided\");\r\n    return;\r\n};\r\nCalculationGroupTable calcGroup = \r\n    Model.AddCalculationGroup(\r\n        calcGroupName);\r\nstring valuesCalcItemName = \"Values\";\r\nstring valuesCalcItemExpression =\r\n    String.Format(\r\n        @\"IF(\r\n            ISINSCOPE( {0} ),\r\n            SELECTEDMEASURE()\r\n        )\", column.DaxObjectFullName);\r\nCalculationItem valuesCalcItem =\r\n    calcGroup.AddCalculationItem(\r\n        name: valuesCalcItemName,\r\n        expression: valuesCalcItemExpression);\r\nvaluesCalcItem.FormatDax();\r\nvaluesCalcItem.Description = \"This calculation item is to show the breakdown by \" + column.Name;\r\nvaluesCalcItem.Ordinal = 0;\r\nstring totalCalcItemName = \"Total\";\r\nstring totalCalcItemExpression =\r\n    String.Format(\r\n        @\"IF(\r\n            NOT ISINSCOPE( {0} ),\r\n            SELECTEDMEASURE()\r\n        )\", column.DaxObjectFullName);\r\nCalculationItem totalCalcItem =\r\n    calcGroup.AddCalculationItem(\r\n        name: totalCalcItemName,\r\n        expression: totalCalcItemExpression);\r\ntotalCalcItem.FormatDax();\r\ntotalCalcItem.Description = \"This calculation item is to show the regular total as a calculation item along with different totals that will be added to this calculation group\";\r\ntotalCalcItem.Ordinal = 1; \r\nstring calcGroupTypeLabel = \"CalcGroupType\";\r\nstring calcGroupTypeValue = \"MultiTotal\";\r\ncalcGroup.SetAnnotation(\r\n    calcGroupTypeLabel,\r\n    calcGroupTypeValue);\r\nstring calcGroupValuesFieldLabel = \"ValuesField\";\r\nstring calcGroupValuesFieldValue = column.DaxObjectFullName;\r\ncalcGroup.SetAnnotation(\r\n    calcGroupValuesFieldLabel,\r\n    calcGroupValuesFieldValue);\r\n",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 77,
      "Name": "8. Bernats Repo\\6. Format\\NUMBER FORMAT",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing System.Windows.Forms;\r\n\r\nusing Microsoft.VisualBasic;\r\nstring cgAnnotationLabel = \"MadeWith\";\r\nstring cgAnnotationValue = \"NumberFormatCalcGroup\";\r\nif (Selected.Measures.Count == 0)\r\n{\r\n    Error(\"Select one or more measures and try again\");\r\n    return;\r\n};\r\nstring measureList = string.Join(\",\", Selected.Measures.Select(x => x.DaxObjectFullName));\r\nstring measureListName = string.Join(\",\", Selected.Measures.Select(x => x.Name));\r\nCalculationGroupTable cg = null as CalculationGroupTable;\r\nif (Model.Tables.Any(t => t.GetAnnotation(cgAnnotationLabel) == cgAnnotationValue)) \r\n{ \r\n    cg = (CalculationGroupTable) Model.Tables.Where(t => t.GetAnnotation(cgAnnotationLabel) == cgAnnotationValue).First();\r\n} \r\nelse\r\n{\r\n    string calcGroupName = Fx.GetNameFromUser(\"Choose name for the number format Calculation Group\", \"Atention\", \"Number Format\");\r\n    if (calcGroupName == \"\") return; // in case user cancelled\r\n    cg = Model.AddCalculationGroup(name: calcGroupName);\r\n    cg.Columns[0].Name = cg.Name;\r\n    cg.SetAnnotation(cgAnnotationLabel, cgAnnotationValue);\r\n}\r\nList<string> formatList = new List<string>();\r\nformatList.Add(\"in milions\");\r\nformatList.Add(\"in thousands\");\r\nstring selectedFormat = Fx.ChooseString(formatList);\r\nif (selectedFormat == null) return;\r\nstring formatString = \"\";\r\nswitch (selectedFormat)\r\n{\r\n    case \"in milions\":\r\n        // code block\r\n        formatString = @\"\"\"#,##0,,.0\"\"\";\r\n        break;\r\n    case \"in thousands\":\r\n        // code block\r\n        formatString = @\"\"\"#,##0,.0\"\"\";\r\n        break;\r\n    default:\r\n        // code block\r\n        break;\r\n}\r\nstring ciValueExpression = \"SELECTEDMEASURE()\";\r\nstring ciFormatStringExpression =\r\n    string.Format(\r\n        @\"IF(\r\n            ISSELECTEDMEASURE({0}),\r\n            {1},\r\n            SELECTEDMEASUREFORMATSTRING()\r\n        )\",\r\n        measureList,\r\n        formatString\r\n    );\r\nstring ciName = string.Format(\"{1} ({0})\", measureListName, selectedFormat);\r\nCalculationItem ci = cg.AddCalculationItem(name:ciName ,expression:ciValueExpression);\r\nci.FormatStringExpression = ciFormatStringExpression;\r\nci.FormatDax();\r\n\r\npublic static class Fx\r\n{\r\n    public static Table CreateCalcTable(Model model, string tableName, string tableExpression)\r\n    {\r\n        if(!model.Tables.Any(t => t.Name == tableName))\r\n        {\r\n            return model.AddCalculatedTable(tableName, tableExpression);\r\n        }\r\n        else\r\n        {\r\n            return model.Tables.Where(t => t.Name == tableName).First();\r\n        }\r\n    }\r\n    public static string GetNameFromUser(string Prompt, string Title, string DefaultResponse)\r\n    {    \r\n        string response = Interaction.InputBox(Prompt, Title, DefaultResponse, 740, 400);\r\n        return response;\r\n    }\r\n    public static string ChooseString(IList<string> OptionList)\r\n    {\r\n        Func<IList<string>, string, string> SelectString = (IList<string> options, string title) =>\r\n        {\r\n            var form = new Form();\r\n            form.Text = title;\r\n            var buttonPanel = new Panel();\r\n            buttonPanel.Dock = DockStyle.Bottom;\r\n            buttonPanel.Height = 30;\r\n            var okButton = new Button() { DialogResult = DialogResult.OK, Text = \"OK\" };\r\n            var cancelButton = new Button() { DialogResult = DialogResult.Cancel, Text = \"Cancel\", Left = 80 };\r\n            var listbox = new ListBox();\r\n            listbox.Dock = DockStyle.Fill;\r\n            listbox.Items.AddRange(options.ToArray());\r\n            listbox.SelectedItem = options[0];\r\n            form.Controls.Add(listbox);\r\n            form.Controls.Add(buttonPanel);\r\n            buttonPanel.Controls.Add(okButton);\r\n            buttonPanel.Controls.Add(cancelButton);\r\n            var result = form.ShowDialog();\r\n            if (result == DialogResult.Cancel) return null;\r\n            return listbox.SelectedItem.ToString();\r\n        };\r\n        //let the user select the name of the macro to copy\r\n        String select = SelectString(OptionList, \"Choose a macro\");\r\n        //check that indeed one macro was selected\r\n        if (select == null)\r\n        {\r\n            Info(\"You cancelled!\");\r\n        }\r\n        return select;\r\n    }\r\n}",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 78,
      "Name": "8. Bernats Repo\\4. Check\\Referential integrity",
      "Enabled": "true",
      "Execute": "//Select the desired table to store all data quality measures\r\n\r\n\r\nstring overallCounterExpression = \"\";\r\nstring overallCounterName = \"Total Unmapped Items\";\r\n\r\nstring overallDetailExpression = \"\\\"\\\"\";\r\nstring overallDetailName = \"Data Problems\";\r\n\r\nTable tableToStoreMeasures = Selected.Tables.First();\r\n\r\nforeach (var r in Model.Relationships)\r\n{\r\n\r\n\r\n    bool isOneToMany =\r\n        r.FromCardinality == RelationshipEndCardinality.One\r\n        & r.ToCardinality == RelationshipEndCardinality.Many;\r\n\r\n    bool isManyToOne =\r\n        r.FromCardinality == RelationshipEndCardinality.Many\r\n        & r.ToCardinality == RelationshipEndCardinality.One;\r\n\r\n    Column manyColumn = null as Column;\r\n    Column oneColumn = null as Column;\r\n    bool isOneToManyOrManyToOne = true;\r\n    if (isOneToMany)\r\n    {\r\n        manyColumn = r.ToColumn;\r\n        oneColumn = r.FromColumn;\r\n\r\n    }\r\n    else if (isManyToOne)\r\n    {\r\n        manyColumn = r.FromColumn;\r\n        oneColumn = r.ToColumn;\r\n    }\r\n    else\r\n    {\r\n        isOneToManyOrManyToOne = false;\r\n    }\r\n\r\n    if (isOneToManyOrManyToOne)\r\n    {\r\n\r\n        string orphanCountExpression =\r\n            \"CALCULATE(\"\r\n                + \"SUMX(VALUES(\" + manyColumn.DaxObjectFullName + \"),1),\"\r\n                + oneColumn.DaxObjectFullName + \" = BLANK()\"\r\n            + \")\";\r\n        string orphanMeasureName =\r\n            manyColumn.Name + \" not mapped in \" + manyColumn.Table.Name;\r\n\r\n        Measure newCounter = tableToStoreMeasures.AddMeasure(name: orphanMeasureName, expression: orphanCountExpression,displayFolder:\"_Data quality Measures\");\r\n        newCounter.FormatDax(); \r\n\r\n        string orphanTableTitleMeasureExpression = newCounter.DaxObjectFullName + \" & \\\" \" + newCounter.Name + \"\\\"\";\r\n        string orphanTableTitleMeasureName = newCounter.Name + \" Title\";\r\n\r\n        Measure newTitle = tableToStoreMeasures.AddMeasure(name: orphanTableTitleMeasureName, expression: orphanTableTitleMeasureExpression, displayFolder: \"_Data quality Titles\");\r\n        newTitle.FormatDax();\r\n\r\n        overallCounterExpression = overallCounterExpression + \"+\" + newCounter.DaxObjectFullName;\r\n        overallDetailExpression = overallDetailExpression\r\n                + \" & IF(\" + newCounter.DaxObjectFullName + \"> 0,\"\r\n                            + newTitle.DaxObjectFullName + \" & UNICHAR(10))\";\r\n\r\n    };\r\n\r\n};\r\n\r\nMeasure counter = tableToStoreMeasures.AddMeasure(name: overallCounterName, expression: overallCounterExpression);\r\ncounter.FormatDax();\r\n\r\n\r\nMeasure descr = tableToStoreMeasures.AddMeasure(name: overallDetailName, expression: overallDetailExpression);\r\ndescr.FormatDax();",
      "Tooltip": "",
      "ValidContexts": "Table"
    },
    {
      "Id": 79,
      "Name": "8. Bernats Repo\\4. Check\\Referential Integrity Cambra",
      "Enabled": "true",
      "Execute": "//Select the desired table to store all data quality measures\r\n//See https://www.esbrina-ba.com/easy-management-of-referential-integrity/\r\n// 2023-02-15 / B.Agulló / Added useRelationship in the expression to check also inactive relationships\r\n// 2023-12-22 / B.Agulló / Added suggestions by Ed Hansberry \r\nstring overallCounterExpression = \"\";\r\nstring overallCounterName = \"Total Unmapped Items\";\r\nstring overallDetailExpression = \"\\\"\\\"\";\r\nstring overallDetailName = \"Data Problems\";\r\nTable tableToStoreMeasures = Selected.Tables.First();\r\nforeach (var r in Model.Relationships)\r\n{\r\n    bool isOneToMany =\r\n        r.FromCardinality == RelationshipEndCardinality.One\r\n        && r.ToCardinality == RelationshipEndCardinality.Many;\r\n    bool isManyToOne =\r\n        r.FromCardinality == RelationshipEndCardinality.Many\r\n        && r.ToCardinality == RelationshipEndCardinality.One;\r\n    Column manyColumn = null as Column;\r\n    Column oneColumn = null as Column;\r\n    bool isOneToManyOrManyToOne = true;\r\n    if (isOneToMany)\r\n    {\r\n        manyColumn = r.ToColumn;\r\n        oneColumn = r.FromColumn;\r\n    }\r\n    else if (isManyToOne)\r\n    {\r\n        manyColumn = r.FromColumn;\r\n        oneColumn = r.ToColumn;\r\n    }\r\n    else\r\n    {\r\n        isOneToManyOrManyToOne = false;\r\n    }\r\n    if (isOneToManyOrManyToOne)\r\n    {\r\n        string orphanCountExpression =\r\n            \"CALCULATE(\"\r\n                + \"SUMX(VALUES(\" + manyColumn.DaxObjectFullName + \"),1),\"\r\n                + \"ISBLANK(\" + oneColumn.DaxObjectFullName + \"),\"\r\n                + \"USERELATIONSHIP(\" + manyColumn.DaxObjectFullName + \",\" + oneColumn.DaxObjectFullName + \"),\"\r\n                + \"ALLEXCEPT(\" + manyColumn.Table.DaxObjectFullName + \",\" + manyColumn.DaxObjectFullName + \")\"\r\n            + \")\";\r\n        string orphanMeasureName =\r\n            manyColumn.Name + \" not mapped in \" + manyColumn.Table.Name;\r\n        Measure newCounter = tableToStoreMeasures.AddMeasure(name: orphanMeasureName, expression: orphanCountExpression, displayFolder: \"_Data quality Measures\");\r\n        newCounter.FormatString = \"#,##0\";\r\n        newCounter.FormatDax();\r\n        string orphanTableTitleMeasureExpression = \"FORMAT(\" + newCounter.DaxObjectFullName +\",\\\"\" + newCounter.FormatString + \"\\\") & \\\" \" + newCounter.Name + \"\\\"\";\r\n        string orphanTableTitleMeasureName = newCounter.Name + \" Title\";\r\n        Measure newTitle = tableToStoreMeasures.AddMeasure(name: orphanTableTitleMeasureName, expression: orphanTableTitleMeasureExpression, displayFolder: \"_Data quality Titles\");\r\n        newTitle.FormatDax();\r\n        overallCounterExpression = overallCounterExpression + \"+\" + newCounter.DaxObjectFullName;\r\n        overallDetailExpression = overallDetailExpression\r\n                + \" & IF(\" + newCounter.DaxObjectFullName + \"> 0,\"\r\n                            + newTitle.DaxObjectFullName + \" & UNICHAR(10))\";\r\n    };\r\n};\r\nMeasure counter = tableToStoreMeasures.AddMeasure(name: overallCounterName, expression: overallCounterExpression);\r\ncounter.FormatString = \"#,##0\";\r\ncounter.FormatDax();\r\nMeasure descr = tableToStoreMeasures.AddMeasure(name: overallDetailName, expression: overallDetailExpression);\r\ndescr.FormatDax();",
      "Tooltip": "",
      "ValidContexts": "Table"
    },
    {
      "Id": 80,
      "Name": "8. Bernats Repo\\1. Measure\\SUM",
      "Enabled": "true",
      "Execute": "/*\r\n * Title: Auto-generate SUM measures from columns\r\n * \r\n * Author: Daniel Otykier, twitter.com/DOtykier\r\n * \r\n * This script, when executed, will loop through the currently selected columns,\r\n * creating one SUM measure for each column and also hiding the column itself.\r\n */\r\n \r\n// Loop through all currently selected columns:\r\nforeach(var c in Selected.Columns)\r\n{\r\n    var newMeasure = c.Table.AddMeasure(\r\n        \"Sum of \" + c.Name,                    // Name\r\n        \"SUM(\" + c.DaxObjectFullName + \")\",    // DAX expression\r\n        c.DisplayFolder                        // Display Folder\r\n    );\r\n    \r\n    // Set the format string on the new measure:\r\n    newMeasure.FormatString = \"0.00\";\r\n\r\n    // Provide some documentation:\r\n    newMeasure.Description = \"This measure is the sum of column \" + c.DaxObjectFullName;\r\n\r\n    // Hide the base column:\r\n    c.IsHidden = true;\r\n}",
      "Tooltip": "creates sum measures for selected columns",
      "ValidContexts": "Column"
    },
    {
      "Id": 81,
      "Name": "8. Bernats Repo\\3. Calc Group\\Time Intelligence",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n                //\r\n// CHANGELOG:\r\n// '2021-05-01 / B.Agullo / \r\n// '2021-05-17 / B.Agullo / added affected measure table\r\n// '2021-06-19 / B.Agullo / data label measures\r\n// '2021-07-10 / B.Agullo / added flag expression to avoid breaking already special format strings\r\n// '2021-09-23 / B.Agullo / added code to prompt for parameters (code credit to Daniel Otykier) \r\n// '2021-09-27 / B.Agullo / added code for general name \r\n// '2022-10-11 / B.Agullo / added MMT and MWT calc item groups\r\n// '2023-01-24 / B.Agullo / added Date Range Measure and completed dynamic label for existing items\r\n//\r\n// by Bernat Agulló\r\n// twitter: @AgulloBernat\r\n// www.esbrina-ba.com/blog\r\n//\r\n// REFERENCE: \r\n// Check out https://www.esbrina-ba.com/time-intelligence-the-smart-way/ where this script is introduced\r\n// \r\n// FEATURED: \r\n// this script featured in GuyInACube https://youtu.be/_j0iTUo2HT0\r\n//\r\n// THANKS:\r\n// shout out to Johnny Winter for the base script and SQLBI for daxpatterns.com\r\n\r\n//select the measures that you want to be affected by the calculation group\r\n//before running the script. \r\n//measure names can also be included in the following array (no need to select them) \r\nstring[] preSelectedMeasures = { }; //include measure names in double quotes, like: {\"Profit\",\"Total Cost\"};\r\n\r\n//AT LEAST ONE MEASURE HAS TO BE AFFECTED!, \r\n//either by selecting it or typing its name in the preSelectedMeasures Variable\r\n\r\n\r\n\r\n//\r\n// ----- do not modify script below this line -----\r\n//\r\n\r\n\r\nstring affectedMeasures = \"{\";\r\n\r\nint i = 0;\r\n\r\nfor (i = 0; i < preSelectedMeasures.GetLength(0); i++)\r\n{\r\n\r\n    if (affectedMeasures == \"{\")\r\n    {\r\n        affectedMeasures = affectedMeasures + \"\\\"\" + preSelectedMeasures[i] + \"\\\"\";\r\n    }\r\n    else\r\n    {\r\n        affectedMeasures = affectedMeasures + \",\\\"\" + preSelectedMeasures[i] + \"\\\"\";\r\n    };\r\n\r\n};\r\n\r\n\r\nif (Selected.Measures.Count != 0)\r\n{\r\n\r\n    foreach (var m in Selected.Measures)\r\n    {\r\n        if (affectedMeasures == \"{\")\r\n        {\r\n            affectedMeasures = affectedMeasures + \"\\\"\" + m.Name + \"\\\"\";\r\n        }\r\n        else\r\n        {\r\n            affectedMeasures = affectedMeasures + \",\\\"\" + m.Name + \"\\\"\";\r\n        };\r\n    };\r\n};\r\n\r\n//check that by either method at least one measure is affected\r\nif (affectedMeasures == \"{\")\r\n{\r\n    Error(\"No measures affected by calc group\");\r\n    return;\r\n};\r\n\r\nstring calcGroupName = String.Empty;\r\nstring columnName = String.Empty;\r\n\r\nif (Model.CalculationGroups.Any(cg => cg.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Calc Group\"))\r\n{\r\n    calcGroupName = Model.CalculationGroups.Where(cg => cg.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Calc Group\").First().Name;\r\n\r\n}\r\nelse\r\n{\r\n    calcGroupName = Interaction.InputBox(\"Provide a name for your Calc Group\", \"Calc Group Name\", \"Time Intelligence\", 740, 400);\r\n};\r\n\r\nif (calcGroupName == String.Empty) return;\r\n\r\n\r\nif (Model.CalculationGroups.Any(cg => cg.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Calc Group\"))\r\n{\r\n    columnName = Model.Tables.Where(cg => cg.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Calc Group\").First().Columns.First().Name;\r\n\r\n}\r\nelse\r\n{\r\n    columnName = Interaction.InputBox(\"Provide a name for your Calc Group Column\", \"Calc Group Column Name\", calcGroupName, 740, 400);\r\n};\r\n\r\nif (columnName == String.Empty) return;\r\n\r\nstring affectedMeasuresTableName = String.Empty;\r\n\r\nif (Model.Tables.Any(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\"))\r\n{\r\n    affectedMeasuresTableName = Model.Tables.Where(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\").First().Name;\r\n\r\n}\r\nelse\r\n{\r\n    affectedMeasuresTableName = Interaction.InputBox(\"Provide a name for affected measures table\", \"Affected Measures Table Name\", calcGroupName + \" Affected Measures\", 740, 400);\r\n\r\n};\r\n\r\nif (affectedMeasuresTableName ==String.Empty) return;\r\n\r\n\r\nstring affectedMeasuresColumnName = String.Empty;\r\n\r\nif (Model.Tables.Any(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\"))\r\n{\r\n    affectedMeasuresColumnName = Model.Tables.Where(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\").First().Columns.First().Name;\r\n\r\n}\r\nelse\r\n{\r\n    affectedMeasuresColumnName = Interaction.InputBox(\"Provide a name for affected measures column\", \"Affected Measures Table Column Name\", \"Measure\", 740, 400);\r\n\r\n};\r\n\r\nif (affectedMeasuresColumnName == String.Empty) return;\r\n//string affectedMeasuresColumnName = \"Measure\"; \r\n\r\nstring labelAsValueMeasureName = \"Label as Value Measure\";\r\nstring labelAsFormatStringMeasureName = \"Label as format string\";\r\n\r\n\r\n// '2021-09-24 / B.Agullo / model object selection prompts! \r\nvar factTable = SelectTable(label: \"Select your fact table\");\r\nif (factTable == null) return;\r\n\r\nvar factTableDateColumn = SelectColumn(factTable.Columns, label: \"Select the main date column\");\r\nif (factTableDateColumn == null) return;\r\n\r\nTable dateTableCandidate = null;\r\n\r\nif (Model.Tables.Any\r\n    (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table\"\r\n        || x.Name == \"Date\"\r\n        || x.Name == \"Calendar\"))\r\n{\r\n    dateTableCandidate = Model.Tables.Where\r\n        (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table\"\r\n            || x.Name == \"Date\"\r\n            || x.Name == \"Calendar\").First();\r\n\r\n};\r\n\r\nvar dateTable =\r\n    SelectTable(\r\n        label: \"Select your date table\",\r\n        preselect: dateTableCandidate);\r\n\r\nif (dateTable == null)\r\n{\r\n    Error(\"You just aborted the script\");\r\n    return;\r\n}\r\nelse\r\n{\r\n    dateTable.SetAnnotation(\"@AgulloBernat\", \"Time Intel Date Table\");\r\n};\r\n\r\n\r\nColumn dateTableDateColumnCandidate = null;\r\n\r\nif (dateTable.Columns.Any\r\n            (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table Date Column\" || x.Name == \"Date\"))\r\n{\r\n    dateTableDateColumnCandidate = dateTable.Columns.Where\r\n        (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table Date Column\" || x.Name == \"Date\").First();\r\n};\r\n\r\nvar dateTableDateColumn =\r\n    SelectColumn(\r\n        dateTable.Columns,\r\n        label: \"Select the date column\",\r\n        preselect: dateTableDateColumnCandidate);\r\n\r\nif (dateTableDateColumn == null)\r\n{\r\n    Error(\"You just aborted the script\");\r\n    return;\r\n}\r\nelse\r\n{\r\n    dateTableDateColumn.SetAnnotation(\"@AgulloBernat\", \"Time Intel Date Table Date Column\");\r\n};\r\n\r\nColumn dateTableYearColumnCandidate = null;\r\nif (dateTable.Columns.Any(x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table Year Column\" || x.Name == \"Year\"))\r\n{\r\n    dateTable.Columns.Where\r\n        (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table Year Column\" || x.Name == \"Year\").First();\r\n};\r\n\r\nvar dateTableYearColumn =\r\n    SelectColumn(\r\n        dateTable.Columns,\r\n        label: \"Select the year column\",\r\n        preselect: dateTableYearColumnCandidate);\r\n\r\nif (dateTableYearColumn == null)\r\n{\r\n    Error(\"You just abourted the script\");\r\n    return;\r\n}\r\nelse\r\n{\r\n    dateTableYearColumn.SetAnnotation(\"@AgulloBernat\", \"Time Intel Date Table Year Column\");\r\n};\r\n\r\n\r\n//these names are for internal use only, so no need to be super-fancy, better stick to datpatterns.com model\r\nstring ShowValueForDatesMeasureName = \"ShowValueForDates\";\r\nstring dateWithSalesColumnName = \"DateWith\" + factTable.Name;\r\n\r\n// '2021-09-24 / B.Agullo / I put the names back to variables so I don't have to tough the script\r\nstring factTableName = factTable.Name;\r\nstring factTableDateColumnName = factTableDateColumn.Name;\r\nstring dateTableName = dateTable.Name;\r\nstring dateTableDateColumnName = dateTableDateColumn.Name;\r\nstring dateTableYearColumnName = dateTableYearColumn.Name;\r\n\r\n// '2021-09-24 / B.Agullo / this is for internal use only so better leave it as is \r\nstring flagExpression = \"UNICHAR( 8204 )\";\r\n\r\nstring calcItemProtection = \"<CODE>\"; //default value if user has selected no measures\r\nstring calcItemFormatProtection = \"<CODE>\"; //default value if user has selected no measures\r\n\r\n// check if there's already an affected measure table\r\nif (Model.Tables.Any(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\"))\r\n{\r\n    //modifying an existing calculated table is not risk-free\r\n    Info(\"Make sure to include measure names to the table \" + affectedMeasuresTableName);\r\n}\r\nelse\r\n{\r\n    // create calculated table containing all names of affected measures\r\n    // this is why you need to enable \r\n    if (affectedMeasures != \"{\")\r\n    {\r\n\r\n        affectedMeasures = affectedMeasures + \"}\";\r\n\r\n        string affectedMeasureTableExpression =\r\n            \"SELECTCOLUMNS(\" + affectedMeasures + \",\\\"\" + affectedMeasuresColumnName + \"\\\",[Value])\";\r\n\r\n        var affectedMeasureTable =\r\n            Model.AddCalculatedTable(affectedMeasuresTableName, affectedMeasureTableExpression);\r\n\r\n        affectedMeasureTable.FormatDax();\r\n        affectedMeasureTable.Description =\r\n            \"Measures affected by \" + calcGroupName + \" calculation group.\";\r\n\r\n        affectedMeasureTable.SetAnnotation(\"@AgulloBernat\", \"Time Intel Affected Measures Table\");\r\n\r\n        // this causes error\r\n        // affectedMeasureTable.Columns[affectedMeasuresColumnName].SetAnnotation(\"@AgulloBernat\",\"Time Intel Affected Measures Table Column\");\r\n\r\n        affectedMeasureTable.IsHidden = true;\r\n\r\n    };\r\n};\r\n\r\n//if there where selected or preselected measures, prepare protection code for expresion and formatstring\r\nstring affectedMeasuresValues = \"VALUES('\" + affectedMeasuresTableName + \"'[\" + affectedMeasuresColumnName + \"])\";\r\n\r\ncalcItemProtection =\r\n    \"SWITCH(\" +\r\n    \"   TRUE(),\" +\r\n    \"   SELECTEDMEASURENAME() IN \" + affectedMeasuresValues + \",\" +\r\n    \"   <CODE> ,\" +\r\n    \"   ISSELECTEDMEASURE([\" + labelAsValueMeasureName + \"]),\" +\r\n    \"   <LABELCODE> ,\" +\r\n    \"   SELECTEDMEASURE() \" +\r\n    \")\";\r\n\r\n\r\ncalcItemFormatProtection =\r\n    \"SWITCH(\" +\r\n    \"   TRUE() ,\" +\r\n    \"   SELECTEDMEASURENAME() IN \" + affectedMeasuresValues + \",\" +\r\n    \"   <CODE> ,\" +\r\n    \"   ISSELECTEDMEASURE([\" + labelAsFormatStringMeasureName + \"]),\" +\r\n    \"   <LABELCODEFORMATSTRING> ,\" +\r\n    \"   SELECTEDMEASUREFORMATSTRING() \" +\r\n    \")\";\r\n\r\n\r\nstring dateColumnWithTable = \"'\" + dateTableName + \"'[\" + dateTableDateColumnName + \"]\";\r\nstring yearColumnWithTable = \"'\" + dateTableName + \"'[\" + dateTableYearColumnName + \"]\";\r\nstring factDateColumnWithTable = \"'\" + factTableName + \"'[\" + factTableDateColumnName + \"]\";\r\nstring dateWithSalesWithTable = \"'\" + dateTableName + \"'[\" + dateWithSalesColumnName + \"]\";\r\nstring calcGroupColumnWithTable = \"'\" + calcGroupName + \"'[\" + columnName + \"]\";\r\n\r\n//check to see if a table with this name already exists\r\n//if it doesnt exist, create a calculation group with this name\r\nif (!Model.Tables.Contains(calcGroupName))\r\n{\r\n    var cg = Model.AddCalculationGroup(calcGroupName);\r\n    cg.Description = \"Calculation group for time intelligence. Availability of data is taken from \" + factTableName + \".\";\r\n    cg.SetAnnotation(\"@AgulloBernat\", \"Time Intel Calc Group\");\r\n};\r\n\r\n//set variable for the calc group\r\nTable calcGroup = Model.Tables[calcGroupName];\r\n\r\n//if table already exists, make sure it is a Calculation Group type\r\nif (calcGroup.SourceType.ToString() != \"CalculationGroup\")\r\n{\r\n    Error(\"Table exists in Model but is not a Calculation Group. Rename the existing table or choose an alternative name for your Calculation Group.\");\r\n    return;\r\n};\r\n\r\n//adds the two measures that will be used for label as value, label as format string \r\nvar labelAsValueMeasure = calcGroup.AddMeasure(labelAsValueMeasureName, \"\");\r\nlabelAsValueMeasure.Description = \"Use this measure to show the year evaluated in tables\";\r\n\r\nvar labelAsFormatStringMeasure = calcGroup.AddMeasure(labelAsFormatStringMeasureName, \"0\");\r\nlabelAsFormatStringMeasure.Description = \"Use this measure to show the year evaluated in charts\";\r\n\r\nMeasure dateRangeMeasure = calcGroup.AddMeasure(\"Date Range\", expression: @\"FORMAT( MIN( 'Date'[Date] ), \"\"d-MMM-yy\"\", \"\"en-US\"\" ) & \"\" to \"\"\r\n        & FORMAT( MAX( 'Date'[Date] ), \"\"d-MMM-yy\"\", \"\"en-US\"\" )\");\r\n\r\ndateRangeMeasure.Description = \"This measure is used to display the dynamic label of Moving total calc items. Do not delete.\";\r\n\r\n\r\n//by default the calc group has a column called Name. If this column is still called Name change this in line with specfied variable\r\nif (calcGroup.Columns.Contains(\"Name\"))\r\n{\r\n    calcGroup.Columns[\"Name\"].Name = columnName;\r\n\r\n};\r\n\r\ncalcGroup.Columns[columnName].Description = \"Select value(s) from this column to apply time intelligence calculations.\";\r\ncalcGroup.Columns[columnName].SetAnnotation(\"@AgulloBernat\", \"Time Intel Calc Group Column\");\r\n\r\n\r\n//Only create them if not in place yet (reruns)\r\nif (!Model.Tables[dateTableName].Columns.Any(C => C.GetAnnotation(\"@AgulloBernat\") == \"Date with Data Column\"))\r\n{\r\n    string DateWithSalesCalculatedColumnExpression =\r\n        dateColumnWithTable + \" <= MAX ( \" + factDateColumnWithTable + \")\";\r\n\r\n    Column dateWithDataColumn = dateTable.AddCalculatedColumn(dateWithSalesColumnName, DateWithSalesCalculatedColumnExpression);\r\n    dateWithDataColumn.SetAnnotation(\"@AgulloBernat\", \"Date with Data Column\");\r\n};\r\n\r\nif (!Model.Tables[dateTableName].Measures.Any(M => M.Name == ShowValueForDatesMeasureName))\r\n{\r\n    string ShowValueForDatesMeasureExpression =\r\n        \"VAR LastDateWithData = \" +\r\n        \"    CALCULATE ( \" +\r\n        \"        MAX (  \" + factDateColumnWithTable + \" ), \" +\r\n        \"        REMOVEFILTERS () \" +\r\n        \"    )\" +\r\n        \"VAR FirstDateVisible = \" +\r\n        \"    MIN ( \" + dateColumnWithTable + \" ) \" +\r\n        \"VAR Result = \" +\r\n        \"    FirstDateVisible <= LastDateWithData \" +\r\n        \"RETURN \" +\r\n        \"    Result \";\r\n\r\n    var ShowValueForDatesMeasure = dateTable.AddMeasure(ShowValueForDatesMeasureName, ShowValueForDatesMeasureExpression);\r\n\r\n    ShowValueForDatesMeasure.FormatDax();\r\n};\r\n\r\n\r\n\r\n//defining expressions and formatstring for each calc item\r\nstring CY =\r\n    \"/*CY*/ \" +\r\n    \"SELECTEDMEASURE()\";\r\n\r\nstring CYlabel =\r\n    \"SELECTEDVALUE(\" + yearColumnWithTable + \")\";\r\n\r\n\r\nstring PY =\r\n    \"/*PY*/ \" +\r\n    \"IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n    \"    CALCULATE ( \" +\r\n    \"        \" + CY + \", \" +\r\n    \"        CALCULATETABLE ( \" +\r\n    \"            DATEADD ( \" + dateColumnWithTable + \" , -1, YEAR ), \" +\r\n    \"            \" + dateWithSalesWithTable + \" = TRUE \" +\r\n    \"        ) \" +\r\n    \"    ) \" +\r\n    \") \";\r\n\r\n\r\nstring PYlabel =\r\n    \"/*PY*/ \" +\r\n    \"IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n    \"    CALCULATE ( \" +\r\n    \"        \" + CYlabel + \", \" +\r\n    \"        CALCULATETABLE ( \" +\r\n    \"            DATEADD ( \" + dateColumnWithTable + \" , -1, YEAR ), \" +\r\n    \"            \" + dateWithSalesWithTable + \" = TRUE \" +\r\n    \"        ) \" +\r\n    \"    ) \" +\r\n    \") \";\r\n\r\n\r\nstring YOY =\r\n    \"/*YOY*/ \" +\r\n    \"VAR ValueCurrentPeriod = \" + CY + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PY + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod - ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"   Result \";\r\n\r\nstring YOYlabel =\r\n    \"/*YOY*/ \" +\r\n    \"VAR ValueCurrentPeriod = \" + CYlabel + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYlabel + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod & \\\" vs \\\" & ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"   Result \";\r\n\r\nstring YOYpct =\r\n    \"/*YOY%*/ \" +\r\n   \"VAR ValueCurrentPeriod = \" + CY + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PY + \" \" +\r\n    \"VAR CurrentMinusPreviousPeriod = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod - ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"VAR Result = \" +\r\n    \"DIVIDE ( \" +\r\n    \"    CurrentMinusPreviousPeriod,\" +\r\n    \"    ValuePreviousPeriod\" +\r\n    \") \" +\r\n    \"RETURN \" +\r\n    \"  Result\";\r\n\r\nstring YOYpctLabel =\r\n    \"/*YOY%*/ \" +\r\n   \"VAR ValueCurrentPeriod = \" + CYlabel + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYlabel + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod & \\\" vs \\\" & ValuePreviousPeriod & \\\" (%)\\\"\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"  Result\";\r\n\r\nstring YTD =\r\n    \"/*YTD*/\" +\r\n    \"IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"],\" +\r\n    \"    CALCULATE (\" +\r\n    \"        \" + CY + \",\" +\r\n    \"        DATESYTD (\" + dateColumnWithTable + \" )\" +\r\n    \"   )\" +\r\n    \") \";\r\n\r\n\r\nstring YTDlabel = CYlabel + \"& \\\" YTD\\\"\";\r\n\r\n\r\nstring PYTD =\r\n    \"/*PYTD*/\" +\r\n    \"IF ( \" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n    \"   CALCULATE ( \" +\r\n    \"       \" + YTD + \",\" +\r\n    \"    CALCULATETABLE ( \" +\r\n    \"        DATEADD ( \" + dateColumnWithTable + \", -1, YEAR ), \" +\r\n    \"       \" + dateWithSalesWithTable + \" = TRUE \" +\r\n    \"       )\" +\r\n    \"   )\" +\r\n    \") \";\r\n\r\nstring PYTDlabel = PYlabel + \"& \\\" YTD\\\"\";\r\n\r\n\r\nstring YOYTD =\r\n    \"/*YOYTD*/\" +\r\n    \"VAR ValueCurrentPeriod = \" + YTD + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYTD + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod - ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"   Result \";\r\n\r\n\r\nstring YOYTDlabel =\r\n    \"/*YOYTD*/\" +\r\n    \"VAR ValueCurrentPeriod = \" + YTDlabel + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYTDlabel + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod & \\\" vs \\\" & ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"   Result \";\r\n\r\n\r\n\r\nstring YOYTDpct =\r\n    \"/*YOYTD%*/\" +\r\n    \"VAR ValueCurrentPeriod = \" + YTD + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYTD + \" \" +\r\n    \"VAR CurrentMinusPreviousPeriod = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod - ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"VAR Result = \" +\r\n    \"DIVIDE ( \" +\r\n    \"    CurrentMinusPreviousPeriod,\" +\r\n    \"    ValuePreviousPeriod\" +\r\n    \") \" +\r\n    \"RETURN \" +\r\n    \"  Result\";\r\n\r\n\r\nstring YOYTDpctLabel =\r\n    \"/*YOY%*/ \" +\r\n   \"VAR ValueCurrentPeriod = \" + YTDlabel + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYTDlabel + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod & \\\" vs \\\" & ValuePreviousPeriod & \\\" (%)\\\"\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"  Result\";\r\n\r\n\r\nstring MAT =\r\n \"        /*TAM*/\" +\r\n \"        IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n \"            CALCULATE (\" +\r\n \"                SELECTEDMEASURE(),\" +\r\n \"                DATESINPERIOD (\" +\r\n \"                    \" + dateColumnWithTable + \" ,\" +\r\n \"                    MAX ( \" + dateColumnWithTable + \"  ),\" +\r\n \"                    -1,\" +\r\n \"                    YEAR\" +\r\n \"                )\" +\r\n \"                \" +\r\n \"            )\" +\r\n \"        )\";\r\n\r\n\r\nstring MATlabel =\r\n    \"        /*TAM*/\" +\r\n \"        IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n \"            CALCULATE (\" +\r\n \"                \" + dateRangeMeasure.DaxObjectFullName + \",\" +\r\n \"                DATESINPERIOD (\" +\r\n \"                    \" + dateColumnWithTable + \" ,\" +\r\n \"                    MAX ( \" + dateColumnWithTable + \"  ),\" +\r\n \"                    -1,\" +\r\n \"                    YEAR\" +\r\n \"                )\" +\r\n \"                \" +\r\n \"            )\" +\r\n \"        )\";\r\n\r\nstring MATminus1 =\r\n \"        /*TAM*/\" +\r\n \"        IF (\" +\r\n \"            [\" + ShowValueForDatesMeasureName + \"], \" +\r\n \"            CALCULATE (\" +\r\n \"                SELECTEDMEASURE(),\" +\r\n \"                DATESINPERIOD (\" +\r\n \"                    \" + dateColumnWithTable + \",\" +\r\n \"                    LASTDATE( DATEADD( \" + dateColumnWithTable + \", - 1, YEAR ) ),\" +\r\n \"                    -1,\" +\r\n \"                    YEAR\" +\r\n \"                )\" +\r\n \"            )\" +\r\n \"        )\";\r\n\r\nstring MATminus1label = \r\n    \"/*MAT-1*/\" +\r\n \"        IF (\" +\r\n \"            [\" + ShowValueForDatesMeasureName + \"], \" +\r\n \"            CALCULATE (\" +\r\n \"                \" + dateRangeMeasure.DaxObjectFullName + \",\" +\r\n \"                DATESINPERIOD (\" +\r\n \"                    \" + dateColumnWithTable + \",\" +\r\n \"                    LASTDATE( DATEADD( \" + dateColumnWithTable + \", - 1, YEAR ) ),\" +\r\n \"                    -1,\" +\r\n \"                    YEAR\" +\r\n \"                )\" +\r\n \"            )\" +\r\n \"        )\";\r\n;\r\n\r\nstring MATvsMATminus1 =\r\n \"        /*MAT vs MAT-1*/\\r\\n\" +\r\n \"        VAR MAT = \" + MAT + \"\\r\\n\" +\r\n \"        VAR MAT_1 =\" + MATminus1 + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MAT ) || ISBLANK( MAT_1 ), BLANK(), MAT - MAT_1 )\";\r\n\r\nstring MATvsMATminus1label = \"/*MAT vs MAT-1*/\" +\r\n    \r\n \"        VAR MAT = \" + MATlabel + \"\\r\\n\" +\r\n \"        VAR MAT_1 =\" + MATminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MAT ) || ISBLANK( MAT_1 ), BLANK(), MAT & \\\" vs \\\" & MAT_1 )\";\r\n\r\nstring MATvsMATminus1pct =\r\n \"        /*MAT vs MAT-1(%)*/\" +\r\n \"        VAR MAT = \" + MAT + \"\\r\\n\" +\r\n \"        VAR MAT_1 =\" + MATminus1 + \"\\r\\n\" +\r\n \"        RETURN\" +\r\n \"            IF(\" +\r\n \"                ISBLANK( MAT ) || ISBLANK( MAT_1 ),\" +\r\n \"                BLANK(),\" +\r\n \"                DIVIDE( MAT - MAT_1, MAT_1 )\" +\r\n \"            )\";\r\n\r\nstring MATvsMATminus1pctlabel = \"/*MAT vs MAT-1 (%)*/\" +\r\n                 \"        VAR MAT = \" + MATlabel + \"\\r\\n\" +\r\n \"        VAR MAT_1 =\" + MATminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MAT ) || ISBLANK( MAT_1 ), BLANK(), MAT & \\\" vs \\\" & MAT_1 & \\\" (%)\\\" )\"; \r\n\r\nstring MMT = String.Format(\r\n        @\"/*MMT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( SELECTEDMEASURE( ), DATESINPERIOD( {1}, MAX( {1} ), -1, MONTH ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable);\r\n\r\nstring MMTlabel = String.Format(\r\n        @\"/*MMT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( {2}, DATESINPERIOD( {1}, MAX( {1} ), -1, MONTH ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable, dateRangeMeasure.DaxObjectFullName);\r\n\r\nstring MMTminus1 = String.Format(\r\n        @\"/*MMT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( SELECTEDMEASURE( ), DATESINPERIOD( {1}, LASTDATE( DATEADD( {1}, -1, MONTH ) ), -1, MONTH ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable);\r\n\r\nstring MMTminus1label = \"/*MMT-1*/\" +\r\n    String.Format(\r\n        @\"/*MMT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( {2}, DATESINPERIOD( {1}, LASTDATE( DATEADD( {1}, -1, MONTH ) ), -1, MONTH ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable, dateRangeMeasure.DaxObjectFullName);\r\n\r\nstring MMTvsMMTminus1 =\r\n \"        /*MMT vs MMT-1*/\\r\\n\" +\r\n \"        VAR MMT = \" + MMT + \"\\r\\n\" +\r\n \"        VAR MMT_1 =\" + MMTminus1 + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MMT ) || ISBLANK( MMT_1 ), BLANK(), MMT - MMT_1 )\";\r\n\r\nstring MMTvsMMTminus1label =\r\n    \"        /*MMT vs MMT-1*/\\r\\n\" +\r\n \"        VAR MMT = \" + MMTlabel + \"\\r\\n\" +\r\n \"        VAR MMT_1 =\" + MMTminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MMT ) || ISBLANK( MMT_1 ), BLANK(), MMT & \\\" vs \\\" & MMT_1 )\"; \r\n\r\nstring MMTvsMMTminus1pct =\r\n \"        /*MMT vs MMT-1(%)*/\" +\r\n \"        VAR MMT = \" + MMT + \"\\r\\n\" +\r\n \"        VAR MMT_1 =\" + MMTminus1 + \"\\r\\n\" +\r\n \"        RETURN\" +\r\n \"            IF(\" +\r\n \"                ISBLANK( MMT ) || ISBLANK( MMT_1 ),\" +\r\n \"                BLANK(),\" +\r\n \"                DIVIDE( MMT - MMT_1, MMT_1 )\" +\r\n \"            )\";\r\n\r\nstring MMTvsMMTminus1pctlabel =\r\n    \"        /*MMT vs MMT-1(%)*/\" +\r\n \"        VAR MMT = \" + MMTlabel + \"\\r\\n\" +\r\n \"        VAR MMT_1 =\" + MMTminus1label + \"\\r\\n\" +\r\n \"        RETURN\" +\r\n \"            IF( ISBLANK( MMT ) || ISBLANK( MMT_1 ), BLANK(), MMT & \\\" vs \\\" & MMT_1  & \\\" (%)\\\")\";\r\n\r\n\r\n\r\nstring MWT = String.Format(\r\n        @\"/*MWT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( SELECTEDMEASURE( ), DATESINPERIOD( {1}, MAX( {1} ), -7, DAY ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable);\r\n\r\nstring MWTlabel = \"/*MWT*/\" +\r\n    \r\n    String.Format(\r\n        @\"/*MWT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( {2}, DATESINPERIOD( {1}, MAX( {1} ), -7, DAY ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable,dateRangeMeasure.DaxObjectFullName); ;\r\n\r\nstring MWTminus1 = String.Format(\r\n        @\"/*MWT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( SELECTEDMEASURE( ), DATESINPERIOD( {1}, LASTDATE( DATEADD( {1}, -7, DAY ) ), -7, DAY ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable);\r\n\r\nstring MWTminus1label = \"/*MWT-1*/\" +\r\n    String.Format(\r\n        @\"/*MWT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( {2}, DATESINPERIOD( {1}, LASTDATE( DATEADD( {1}, -7, DAY ) ), -7, DAY ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable, dateRangeMeasure.DaxObjectFullName);\r\n\r\nstring MWTvsMWTminus1 =\r\n \"        /*MWT vs MWT-1*/\\r\\n\" +\r\n \"        VAR MWT = \" + MWT + \"\\r\\n\" +\r\n \"        VAR MWT_1 =\" + MWTminus1 + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MWT ) || ISBLANK( MWT_1 ), BLANK(), MWT - MWT_1 )\";\r\n\r\nstring MWTvsMWTminus1label = \r\n    \"        /*MWT vs MWT-1*/\\r\\n\" +\r\n \"        VAR MWT = \" + MWTlabel + \"\\r\\n\" +\r\n \"        VAR MWT_1 =\" + MWTminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MWT ) || ISBLANK( MWT_1 ), BLANK(), MWT & \\\" vs \\\" & MWT_1 )\"; \r\n\r\nstring MWTvsMWTminus1pct =\r\n \"        /*MWT vs MWT-1(%)*/\" +\r\n \"        VAR MWT = \" + MWT + \"\\r\\n\" +\r\n \"        VAR MWT_1 =\" + MWTminus1 + \"\\r\\n\" +\r\n \"        RETURN\" +\r\n \"            IF(\" +\r\n \"                ISBLANK( MWT ) || ISBLANK( MWT_1 ),\" +\r\n \"                BLANK(),\" +\r\n \"                DIVIDE( MWT - MWT_1, MWT_1 )\" +\r\n \"            )\";\r\n\r\nstring MWTvsMWTminus1pctlabel = \r\n    \"/*MWT vs MWT-1 (%)*/\" +\r\n \"        VAR MWT = \" + MWTlabel + \"\\r\\n\" +\r\n \"        VAR MWT_1 =\" + MWTminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MWT ) || ISBLANK( MWT_1 ), BLANK(), MWT & \\\" vs \\\" & MWT_1 & \\\" (%)\\\")\";\r\n\r\n\r\n\r\nstring defFormatString = \"SELECTEDMEASUREFORMATSTRING()\";\r\n\r\n//if the flag expression is already present in the format string, do not change it, otherwise apply % format. \r\nstring pctFormatString =\r\n\"IF(\" +\r\n\"\\n FIND( \" + flagExpression + \", SELECTEDMEASUREFORMATSTRING(), 1, - 1 ) <> -1,\" +\r\n\"\\n SELECTEDMEASUREFORMATSTRING(),\" +\r\n\"\\n \\\"#,##0.# %\\\"\" +\r\n\"\\n)\";\r\n\r\n\r\n//the order in the array also determines the ordinal position of the item    \r\nstring[,] calcItems =\r\n    {\r\n{\"CY\",      CY,         defFormatString,    \"Current year\",             CYlabel},\r\n{\"PY\",      PY,         defFormatString,    \"Previous year\",            PYlabel},\r\n{\"YOY\",     YOY,        defFormatString,    \"Year-over-year\",           YOYlabel},\r\n{\"YOY%\",    YOYpct,     pctFormatString,    \"Year-over-year%\",          YOYpctLabel},\r\n{\"YTD\",     YTD,        defFormatString,    \"Year-to-date\",             YTDlabel},\r\n{\"PYTD\",    PYTD,       defFormatString,    \"Previous year-to-date\",    PYTDlabel},\r\n{\"YOYTD\",   YOYTD,      defFormatString,    \"Year-over-year-to-date\",   YOYTDlabel},\r\n{\"YOYTD%\",  YOYTDpct,   pctFormatString,    \"Year-over-year-to-date%\",  YOYTDpctLabel},\r\n{\"MAT\",     MAT,        defFormatString,    \"Moving Anual Total\",       MATlabel},\r\n{\"MAT-1\",   MATminus1,  defFormatString,    \"Moving Anual Total -1 year\", MATminus1label},\r\n{\"MAT vs MAT-1\", MATvsMATminus1, defFormatString, \"Moving Anual Total vs Moving Anual Total -1 year\", MATvsMATminus1label},\r\n{\"MAT vs MAT-1(%)\", MATvsMATminus1pct, pctFormatString, \"Moving Anual Total vs Moving Anual Total -1 year (%)\", MATvsMATminus1pctlabel},\r\n{\"MMT\",     MMT,        defFormatString,    \"Moving Monthly Total\",       MMTlabel},\r\n{\"MMT-1\",   MMTminus1,  defFormatString,    \"Moving Monthly Total -1 month\", MMTminus1label},\r\n{\"MMT vs MMT-1\", MMTvsMMTminus1, defFormatString, \"Moving Monthly Total vs Moving Monthly Total -1 month\", MMTvsMMTminus1label},\r\n{\"MMT vs MMT-1(%)\", MMTvsMMTminus1pct, pctFormatString, \"Moving Monthly Total vs Moving Monthly Total -1 month (%)\", MMTvsMMTminus1pctlabel},\r\n{\"MWT\",     MWT,        defFormatString,    \"Moving Weekly Total\",       MWTlabel},\r\n{\"MWT-1\",   MWTminus1,  defFormatString,    \"Moving Weekly Total -1 week\", MWTminus1label},\r\n{\"MWT vs MWT-1\", MWTvsMWTminus1, defFormatString, \"Moving Weekly Total vs Moving Weekly Total -1 week\", MWTvsMWTminus1label},\r\n{\"MWT vs MWT-1(%)\", MWTvsMWTminus1pct, pctFormatString, \"Moving Weekly Total vs Moving Weekly Total -1 week (%)\", MWTvsMWTminus1pctlabel}\r\n};\r\n\r\n\r\nint j = 0;\r\n\r\n\r\n//create calculation items for each calculation with formatstring and description\r\nforeach (var cg in Model.CalculationGroups)\r\n{\r\n    if (cg.Name == calcGroupName)\r\n    {\r\n        for (j = 0; j < calcItems.GetLength(0); j++)\r\n        {\r\n\r\n            string itemName = calcItems[j, 0];\r\n\r\n            string itemExpression = calcItemProtection.Replace(\"<CODE>\", calcItems[j, 1]);\r\n            itemExpression = itemExpression.Replace(\"<LABELCODE>\", calcItems[j, 4]);\r\n\r\n            string itemFormatExpression = calcItemFormatProtection.Replace(\"<CODE>\", calcItems[j, 2]);\r\n            itemFormatExpression = itemFormatExpression.Replace(\"<LABELCODEFORMATSTRING>\", \"\\\"\\\"\\\"\\\" & \" + calcItems[j, 4] + \" & \\\"\\\"\\\"\\\"\");\r\n\r\n            //if(calcItems[j,2] != defFormatString) {\r\n            //    itemFormatExpression = calcItemFormatProtection.Replace(\"<CODE>\",calcItems[j,2]);\r\n            //};\r\n\r\n            string itemDescription = calcItems[j, 3];\r\n\r\n            if (!cg.CalculationItems.Contains(itemName))\r\n            {\r\n                var nCalcItem = cg.AddCalculationItem(itemName, itemExpression);\r\n                nCalcItem.FormatStringExpression = itemFormatExpression;\r\n                nCalcItem.FormatDax();\r\n                nCalcItem.Ordinal = j;\r\n                nCalcItem.Description = itemDescription;\r\n\r\n            };\r\n\r\n\r\n\r\n\r\n        };\r\n\r\n\r\n    };\r\n};",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 82,
      "Name": "8. Bernats Repo\\3. Calc Group\\Time Intelligence Cambra",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\r\nusing Microsoft.VisualBasic;\r\n                //\r\n// CHANGELOG:\r\n// '2021-05-01 / B.Agullo / \r\n// '2021-05-17 / B.Agullo / added affected measure table\r\n// '2021-06-19 / B.Agullo / data label measures\r\n// '2021-07-10 / B.Agullo / added flag expression to avoid breaking already special format strings\r\n// '2021-09-23 / B.Agullo / added code to prompt for parameters (code credit to Daniel Otykier) \r\n// '2021-09-27 / B.Agullo / added code for general name \r\n// '2022-10-11 / B.Agullo / added MMT and MWT calc item groups\r\n// '2023-01-24 / B.Agullo / added Date Range Measure and completed dynamic label for existing items\r\n//\r\n// by Bernat Agulló\r\n// twitter: @AgulloBernat\r\n// www.esbrina-ba.com/blog\r\n//\r\n// REFERENCE: \r\n// Check out https://www.esbrina-ba.com/time-intelligence-the-smart-way/ where this script is introduced\r\n// \r\n// FEATURED: \r\n// this script featured in GuyInACube https://youtu.be/_j0iTUo2HT0\r\n//\r\n// THANKS:\r\n// shout out to Johnny Winter for the base script and SQLBI for daxpatterns.com\r\n\r\n//select the measures that you want to be affected by the calculation group\r\n//before running the script. \r\n//measure names can also be included in the following array (no need to select them) \r\nstring[] preSelectedMeasures = { }; //include measure names in double quotes, like: {\"Profit\",\"Total Cost\"};\r\n\r\n//AT LEAST ONE MEASURE HAS TO BE AFFECTED!, \r\n//either by selecting it or typing its name in the preSelectedMeasures Variable\r\n\r\n\r\n\r\n//\r\n// ----- do not modify script below this line -----\r\n//\r\n\r\n\r\nstring affectedMeasures = \"{\";\r\n\r\nint i = 0;\r\n\r\nfor (i = 0; i < preSelectedMeasures.GetLength(0); i++)\r\n{\r\n\r\n    if (affectedMeasures == \"{\")\r\n    {\r\n        affectedMeasures = affectedMeasures + \"\\\"\" + preSelectedMeasures[i] + \"\\\"\";\r\n    }\r\n    else\r\n    {\r\n        affectedMeasures = affectedMeasures + \",\\\"\" + preSelectedMeasures[i] + \"\\\"\";\r\n    };\r\n\r\n};\r\n\r\n\r\nif (Selected.Measures.Count != 0)\r\n{\r\n\r\n    foreach (var m in Selected.Measures)\r\n    {\r\n        if (affectedMeasures == \"{\")\r\n        {\r\n            affectedMeasures = affectedMeasures + \"\\\"\" + m.Name + \"\\\"\";\r\n        }\r\n        else\r\n        {\r\n            affectedMeasures = affectedMeasures + \",\\\"\" + m.Name + \"\\\"\";\r\n        };\r\n    };\r\n};\r\n\r\n//check that by either method at least one measure is affected\r\nif (affectedMeasures == \"{\")\r\n{\r\n    Error(\"No measures affected by calc group\");\r\n    return;\r\n};\r\n\r\nstring calcGroupName = String.Empty;\r\nstring columnName = String.Empty;\r\n\r\nif (Model.CalculationGroups.Any(cg => cg.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Calc Group\"))\r\n{\r\n    calcGroupName = Model.CalculationGroups.Where(cg => cg.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Calc Group\").First().Name;\r\n\r\n}\r\nelse\r\n{\r\n    calcGroupName = Interaction.InputBox(\"Provide a name for your Calc Group\", \"Calc Group Name\", \"Time Intelligence\", 740, 400);\r\n};\r\n\r\nif (calcGroupName == String.Empty) return;\r\n\r\n\r\nif (Model.CalculationGroups.Any(cg => cg.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Calc Group\"))\r\n{\r\n    columnName = Model.Tables.Where(cg => cg.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Calc Group\").First().Columns.First().Name;\r\n\r\n}\r\nelse\r\n{\r\n    columnName = Interaction.InputBox(\"Provide a name for your Calc Group Column\", \"Calc Group Column Name\", calcGroupName, 740, 400);\r\n};\r\n\r\nif (columnName == String.Empty) return;\r\n\r\nstring affectedMeasuresTableName = String.Empty;\r\n\r\nif (Model.Tables.Any(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\"))\r\n{\r\n    affectedMeasuresTableName = Model.Tables.Where(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\").First().Name;\r\n\r\n}\r\nelse\r\n{\r\n    affectedMeasuresTableName = Interaction.InputBox(\"Provide a name for affected measures table\", \"Affected Measures Table Name\", calcGroupName + \" Affected Measures\", 740, 400);\r\n\r\n};\r\n\r\nif (affectedMeasuresTableName ==String.Empty) return;\r\n\r\n\r\nstring affectedMeasuresColumnName = String.Empty;\r\n\r\nif (Model.Tables.Any(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\"))\r\n{\r\n    affectedMeasuresColumnName = Model.Tables.Where(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\").First().Columns.First().Name;\r\n\r\n}\r\nelse\r\n{\r\n    affectedMeasuresColumnName = Interaction.InputBox(\"Provide a name for affected measures column\", \"Affected Measures Table Column Name\", \"Measure\", 740, 400);\r\n\r\n};\r\n\r\nif (affectedMeasuresColumnName == String.Empty) return;\r\n//string affectedMeasuresColumnName = \"Measure\"; \r\n\r\nstring labelAsValueMeasureName = \"Label as Value Measure\";\r\nstring labelAsFormatStringMeasureName = \"Label as format string\";\r\n\r\n\r\n// '2021-09-24 / B.Agullo / model object selection prompts! \r\nvar factTable = SelectTable(label: \"Select your fact table\");\r\nif (factTable == null) return;\r\n\r\nvar factTableDateColumn = SelectColumn(factTable.Columns, label: \"Select the main date column\");\r\nif (factTableDateColumn == null) return;\r\n\r\nTable dateTableCandidate = null;\r\n\r\nif (Model.Tables.Any\r\n    (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table\"\r\n        || x.Name == \"Date\"\r\n        || x.Name == \"Calendar\"))\r\n{\r\n    dateTableCandidate = Model.Tables.Where\r\n        (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table\"\r\n            || x.Name == \"Date\"\r\n            || x.Name == \"Calendar\").First();\r\n\r\n};\r\n\r\nvar dateTable =\r\n    SelectTable(\r\n        label: \"Select your date table\",\r\n        preselect: dateTableCandidate);\r\n\r\nif (dateTable == null)\r\n{\r\n    Error(\"You just aborted the script\");\r\n    return;\r\n}\r\nelse\r\n{\r\n    dateTable.SetAnnotation(\"@AgulloBernat\", \"Time Intel Date Table\");\r\n};\r\n\r\n\r\nColumn dateTableDateColumnCandidate = null;\r\n\r\nif (dateTable.Columns.Any\r\n            (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table Date Column\" || x.Name == \"Date\"))\r\n{\r\n    dateTableDateColumnCandidate = dateTable.Columns.Where\r\n        (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table Date Column\" || x.Name == \"Date\").First();\r\n};\r\n\r\nvar dateTableDateColumn =\r\n    SelectColumn(\r\n        dateTable.Columns,\r\n        label: \"Select the date column\",\r\n        preselect: dateTableDateColumnCandidate);\r\n\r\nif (dateTableDateColumn == null)\r\n{\r\n    Error(\"You just aborted the script\");\r\n    return;\r\n}\r\nelse\r\n{\r\n    dateTableDateColumn.SetAnnotation(\"@AgulloBernat\", \"Time Intel Date Table Date Column\");\r\n};\r\n\r\nColumn dateTableYearColumnCandidate = null;\r\nif (dateTable.Columns.Any(x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table Year Column\" || x.Name == \"Year\"))\r\n{\r\n    dateTable.Columns.Where\r\n        (x => x.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Date Table Year Column\" || x.Name == \"Year\").First();\r\n};\r\n\r\nvar dateTableYearColumn =\r\n    SelectColumn(\r\n        dateTable.Columns,\r\n        label: \"Select the year column\",\r\n        preselect: dateTableYearColumnCandidate);\r\n\r\nif (dateTableYearColumn == null)\r\n{\r\n    Error(\"You just abourted the script\");\r\n    return;\r\n}\r\nelse\r\n{\r\n    dateTableYearColumn.SetAnnotation(\"@AgulloBernat\", \"Time Intel Date Table Year Column\");\r\n};\r\n\r\n\r\n//these names are for internal use only, so no need to be super-fancy, better stick to datpatterns.com model\r\nstring ShowValueForDatesMeasureName = \"ShowValueForDates\";\r\nstring dateWithSalesColumnName = \"DateWith\" + factTable.Name;\r\n\r\n// '2021-09-24 / B.Agullo / I put the names back to variables so I don't have to tough the script\r\nstring factTableName = factTable.Name;\r\nstring factTableDateColumnName = factTableDateColumn.Name;\r\nstring dateTableName = dateTable.Name;\r\nstring dateTableDateColumnName = dateTableDateColumn.Name;\r\nstring dateTableYearColumnName = dateTableYearColumn.Name;\r\n\r\n// '2021-09-24 / B.Agullo / this is for internal use only so better leave it as is \r\nstring flagExpression = \"UNICHAR( 8204 )\";\r\n\r\nstring calcItemProtection = \"<CODE>\"; //default value if user has selected no measures\r\nstring calcItemFormatProtection = \"<CODE>\"; //default value if user has selected no measures\r\n\r\n// check if there's already an affected measure table\r\nif (Model.Tables.Any(t => t.GetAnnotation(\"@AgulloBernat\") == \"Time Intel Affected Measures Table\"))\r\n{\r\n    //modifying an existing calculated table is not risk-free\r\n    Info(\"Make sure to include measure names to the table \" + affectedMeasuresTableName);\r\n}\r\nelse\r\n{\r\n    // create calculated table containing all names of affected measures\r\n    // this is why you need to enable \r\n    if (affectedMeasures != \"{\")\r\n    {\r\n\r\n        affectedMeasures = affectedMeasures + \"}\";\r\n\r\n        string affectedMeasureTableExpression =\r\n            \"SELECTCOLUMNS(\" + affectedMeasures + \",\\\"\" + affectedMeasuresColumnName + \"\\\",[Value])\";\r\n\r\n        var affectedMeasureTable =\r\n            Model.AddCalculatedTable(affectedMeasuresTableName, affectedMeasureTableExpression);\r\n\r\n        affectedMeasureTable.FormatDax();\r\n        affectedMeasureTable.Description =\r\n            \"Measures affected by \" + calcGroupName + \" calculation group.\";\r\n\r\n        affectedMeasureTable.SetAnnotation(\"@AgulloBernat\", \"Time Intel Affected Measures Table\");\r\n\r\n        // this causes error\r\n        // affectedMeasureTable.Columns[affectedMeasuresColumnName].SetAnnotation(\"@AgulloBernat\",\"Time Intel Affected Measures Table Column\");\r\n\r\n        affectedMeasureTable.IsHidden = true;\r\n\r\n    };\r\n};\r\n\r\n//if there where selected or preselected measures, prepare protection code for expresion and formatstring\r\nstring affectedMeasuresValues = \"VALUES('\" + affectedMeasuresTableName + \"'[\" + affectedMeasuresColumnName + \"])\";\r\n\r\ncalcItemProtection =\r\n    \"SWITCH(\" +\r\n    \"   TRUE(),\" +\r\n    \"   SELECTEDMEASURENAME() IN \" + affectedMeasuresValues + \",\" +\r\n    \"   <CODE> ,\" +\r\n    \"   ISSELECTEDMEASURE([\" + labelAsValueMeasureName + \"]),\" +\r\n    \"   <LABELCODE> ,\" +\r\n    \"   SELECTEDMEASURE() \" +\r\n    \")\";\r\n\r\n\r\ncalcItemFormatProtection =\r\n    \"SWITCH(\" +\r\n    \"   TRUE() ,\" +\r\n    \"   SELECTEDMEASURENAME() IN \" + affectedMeasuresValues + \",\" +\r\n    \"   <CODE> ,\" +\r\n    \"   ISSELECTEDMEASURE([\" + labelAsFormatStringMeasureName + \"]),\" +\r\n    \"   <LABELCODEFORMATSTRING> ,\" +\r\n    \"   SELECTEDMEASUREFORMATSTRING() \" +\r\n    \")\";\r\n\r\n\r\nstring dateColumnWithTable = \"'\" + dateTableName + \"'[\" + dateTableDateColumnName + \"]\";\r\nstring yearColumnWithTable = \"'\" + dateTableName + \"'[\" + dateTableYearColumnName + \"]\";\r\nstring factDateColumnWithTable = \"'\" + factTableName + \"'[\" + factTableDateColumnName + \"]\";\r\nstring dateWithSalesWithTable = \"'\" + dateTableName + \"'[\" + dateWithSalesColumnName + \"]\";\r\nstring calcGroupColumnWithTable = \"'\" + calcGroupName + \"'[\" + columnName + \"]\";\r\n\r\n//check to see if a table with this name already exists\r\n//if it doesnt exist, create a calculation group with this name\r\nif (!Model.Tables.Contains(calcGroupName))\r\n{\r\n    var cg = Model.AddCalculationGroup(calcGroupName);\r\n    cg.Description = \"Calculation group for time intelligence. Availability of data is taken from \" + factTableName + \".\";\r\n    cg.SetAnnotation(\"@AgulloBernat\", \"Time Intel Calc Group\");\r\n};\r\n\r\n//set variable for the calc group\r\nTable calcGroup = Model.Tables[calcGroupName];\r\n\r\n//if table already exists, make sure it is a Calculation Group type\r\nif (calcGroup.SourceType.ToString() != \"CalculationGroup\")\r\n{\r\n    Error(\"Table exists in Model but is not a Calculation Group. Rename the existing table or choose an alternative name for your Calculation Group.\");\r\n    return;\r\n};\r\n\r\n//adds the two measures that will be used for label as value, label as format string \r\nvar labelAsValueMeasure = calcGroup.AddMeasure(labelAsValueMeasureName, \"\");\r\nlabelAsValueMeasure.Description = \"Use this measure to show the year evaluated in tables\";\r\n\r\nvar labelAsFormatStringMeasure = calcGroup.AddMeasure(labelAsFormatStringMeasureName, \"0\");\r\nlabelAsFormatStringMeasure.Description = \"Use this measure to show the year evaluated in charts\";\r\n\r\nMeasure dateRangeMeasure = calcGroup.AddMeasure(\"Date Range\", expression: @\"FORMAT( MIN( 'Date'[Date] ), \"\"d-MMM-yy\"\", \"\"en-US\"\" ) & \"\" to \"\"\r\n        & FORMAT( MAX( 'Date'[Date] ), \"\"d-MMM-yy\"\", \"\"en-US\"\" )\");\r\n\r\ndateRangeMeasure.Description = \"This measure is used to display the dynamic label of Moving total calc items. Do not delete.\";\r\n\r\n\r\n//by default the calc group has a column called Name. If this column is still called Name change this in line with specfied variable\r\nif (calcGroup.Columns.Contains(\"Name\"))\r\n{\r\n    calcGroup.Columns[\"Name\"].Name = columnName;\r\n\r\n};\r\n\r\ncalcGroup.Columns[columnName].Description = \"Select value(s) from this column to apply time intelligence calculations.\";\r\ncalcGroup.Columns[columnName].SetAnnotation(\"@AgulloBernat\", \"Time Intel Calc Group Column\");\r\n\r\n\r\n//Only create them if not in place yet (reruns)\r\nif (!Model.Tables[dateTableName].Columns.Any(C => C.GetAnnotation(\"@AgulloBernat\") == \"Date with Data Column\"))\r\n{\r\n    string DateWithSalesCalculatedColumnExpression =\r\n        dateColumnWithTable + \" <= MAX ( \" + factDateColumnWithTable + \")\";\r\n\r\n    Column dateWithDataColumn = dateTable.AddCalculatedColumn(dateWithSalesColumnName, DateWithSalesCalculatedColumnExpression);\r\n    dateWithDataColumn.SetAnnotation(\"@AgulloBernat\", \"Date with Data Column\");\r\n};\r\n\r\nif (!Model.Tables[dateTableName].Measures.Any(M => M.Name == ShowValueForDatesMeasureName))\r\n{\r\n    string ShowValueForDatesMeasureExpression =\r\n        \"VAR LastDateWithData = \" +\r\n        \"    CALCULATE ( \" +\r\n        \"        MAX (  \" + factDateColumnWithTable + \" ), \" +\r\n        \"        REMOVEFILTERS () \" +\r\n        \"    )\" +\r\n        \"VAR FirstDateVisible = \" +\r\n        \"    MIN ( \" + dateColumnWithTable + \" ) \" +\r\n        \"VAR Result = \" +\r\n        \"    FirstDateVisible <= LastDateWithData \" +\r\n        \"RETURN \" +\r\n        \"    Result \";\r\n\r\n    var ShowValueForDatesMeasure = dateTable.AddMeasure(ShowValueForDatesMeasureName, ShowValueForDatesMeasureExpression);\r\n\r\n    ShowValueForDatesMeasure.FormatDax();\r\n};\r\n\r\n\r\n\r\n//defining expressions and formatstring for each calc item\r\nstring CY =\r\n    \"/*CY*/ \" +\r\n    \"SELECTEDMEASURE()\";\r\n\r\nstring CYlabel =\r\n    \"SELECTEDVALUE(\" + yearColumnWithTable + \")\";\r\n\r\n\r\nstring PY =\r\n    \"/*PY*/ \" +\r\n    \"IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n    \"    CALCULATE ( \" +\r\n    \"        \" + CY + \", \" +\r\n    \"        CALCULATETABLE ( \" +\r\n    \"            DATEADD ( \" + dateColumnWithTable + \" , -1, YEAR ), \" +\r\n    \"            \" + dateWithSalesWithTable + \" = TRUE \" +\r\n    \"        ) \" +\r\n    \"    ) \" +\r\n    \") \";\r\n\r\n\r\nstring PYlabel =\r\n    \"/*PY*/ \" +\r\n    \"IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n    \"    CALCULATE ( \" +\r\n    \"        \" + CYlabel + \", \" +\r\n    \"        CALCULATETABLE ( \" +\r\n    \"            DATEADD ( \" + dateColumnWithTable + \" , -1, YEAR ), \" +\r\n    \"            \" + dateWithSalesWithTable + \" = TRUE \" +\r\n    \"        ) \" +\r\n    \"    ) \" +\r\n    \") \";\r\n\r\n\r\nstring YOY =\r\n    \"/*YOY*/ \" +\r\n    \"VAR ValueCurrentPeriod = \" + CY + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PY + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod - ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"   Result \";\r\n\r\nstring YOYlabel =\r\n    \"/*YOY*/ \" +\r\n    \"VAR ValueCurrentPeriod = \" + CYlabel + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYlabel + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod & \\\" vs \\\" & ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"   Result \";\r\n\r\nstring YOYpct =\r\n    \"/*YOY%*/ \" +\r\n   \"VAR ValueCurrentPeriod = \" + CY + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PY + \" \" +\r\n    \"VAR CurrentMinusPreviousPeriod = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod - ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"VAR Result = \" +\r\n    \"DIVIDE ( \" +\r\n    \"    CurrentMinusPreviousPeriod,\" +\r\n    \"    ValuePreviousPeriod\" +\r\n    \") \" +\r\n    \"RETURN \" +\r\n    \"  Result\";\r\n\r\nstring YOYpctLabel =\r\n    \"/*YOY%*/ \" +\r\n   \"VAR ValueCurrentPeriod = \" + CYlabel + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYlabel + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod & \\\" vs \\\" & ValuePreviousPeriod & \\\" (%)\\\"\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"  Result\";\r\n\r\nstring YTD =\r\n    \"/*YTD*/\" +\r\n    \"IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"],\" +\r\n    \"    CALCULATE (\" +\r\n    \"        \" + CY + \",\" +\r\n    \"        DATESYTD (\" + dateColumnWithTable + \" )\" +\r\n    \"   )\" +\r\n    \") \";\r\n\r\n\r\nstring YTDlabel = CYlabel + \"& \\\" YTD\\\"\";\r\n\r\n\r\nstring PYTD =\r\n    \"/*PYTD*/\" +\r\n    \"IF ( \" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n    \"   CALCULATE ( \" +\r\n    \"       \" + YTD + \",\" +\r\n    \"    CALCULATETABLE ( \" +\r\n    \"        DATEADD ( \" + dateColumnWithTable + \", -1, YEAR ), \" +\r\n    \"       \" + dateWithSalesWithTable + \" = TRUE \" +\r\n    \"       )\" +\r\n    \"   )\" +\r\n    \") \";\r\n\r\nstring PYTDlabel = PYlabel + \"& \\\" YTD\\\"\";\r\n\r\n\r\nstring YOYTD =\r\n    \"/*YOYTD*/\" +\r\n    \"VAR ValueCurrentPeriod = \" + YTD + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYTD + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod - ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"   Result \";\r\n\r\n\r\nstring YOYTDlabel =\r\n    \"/*YOYTD*/\" +\r\n    \"VAR ValueCurrentPeriod = \" + YTDlabel + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYTDlabel + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod & \\\" vs \\\" & ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"   Result \";\r\n\r\n\r\n\r\nstring YOYTDpct =\r\n    \"/*YOYTD%*/\" +\r\n    \"VAR ValueCurrentPeriod = \" + YTD + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYTD + \" \" +\r\n    \"VAR CurrentMinusPreviousPeriod = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod - ValuePreviousPeriod\" +\r\n    \" ) \" +\r\n    \"VAR Result = \" +\r\n    \"DIVIDE ( \" +\r\n    \"    CurrentMinusPreviousPeriod,\" +\r\n    \"    ValuePreviousPeriod\" +\r\n    \") \" +\r\n    \"RETURN \" +\r\n    \"  Result\";\r\n\r\n\r\nstring YOYTDpctLabel =\r\n    \"/*YOY%*/ \" +\r\n   \"VAR ValueCurrentPeriod = \" + YTDlabel + \" \" +\r\n    \"VAR ValuePreviousPeriod = \" + PYTDlabel + \" \" +\r\n    \"VAR Result = \" +\r\n    \"IF ( \" +\r\n    \"    NOT ISBLANK ( ValueCurrentPeriod ) && NOT ISBLANK ( ValuePreviousPeriod ), \" +\r\n    \"     ValueCurrentPeriod & \\\" vs \\\" & ValuePreviousPeriod & \\\" (%)\\\"\" +\r\n    \" ) \" +\r\n    \"RETURN \" +\r\n    \"  Result\";\r\n\r\n\r\nstring MAT =\r\n \"        /*TAM*/\" +\r\n \"        IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n \"            CALCULATE (\" +\r\n \"                SELECTEDMEASURE(),\" +\r\n \"                DATESINPERIOD (\" +\r\n \"                    \" + dateColumnWithTable + \" ,\" +\r\n \"                    MAX ( \" + dateColumnWithTable + \"  ),\" +\r\n \"                    -1,\" +\r\n \"                    YEAR\" +\r\n \"                )\" +\r\n \"                \" +\r\n \"            )\" +\r\n \"        )\";\r\n\r\n\r\nstring MATlabel =\r\n    \"        /*TAM*/\" +\r\n \"        IF (\" +\r\n    \"    [\" + ShowValueForDatesMeasureName + \"], \" +\r\n \"            CALCULATE (\" +\r\n \"                \" + dateRangeMeasure.DaxObjectFullName + \",\" +\r\n \"                DATESINPERIOD (\" +\r\n \"                    \" + dateColumnWithTable + \" ,\" +\r\n \"                    MAX ( \" + dateColumnWithTable + \"  ),\" +\r\n \"                    -1,\" +\r\n \"                    YEAR\" +\r\n \"                )\" +\r\n \"                \" +\r\n \"            )\" +\r\n \"        )\";\r\n\r\nstring MATminus1 =\r\n \"        /*TAM*/\" +\r\n \"        IF (\" +\r\n \"            [\" + ShowValueForDatesMeasureName + \"], \" +\r\n \"            CALCULATE (\" +\r\n \"                SELECTEDMEASURE(),\" +\r\n \"                DATESINPERIOD (\" +\r\n \"                    \" + dateColumnWithTable + \",\" +\r\n \"                    LASTDATE( DATEADD( \" + dateColumnWithTable + \", - 1, YEAR ) ),\" +\r\n \"                    -1,\" +\r\n \"                    YEAR\" +\r\n \"                )\" +\r\n \"            )\" +\r\n \"        )\";\r\n\r\nstring MATminus1label = \r\n    \"/*MAT-1*/\" +\r\n \"        IF (\" +\r\n \"            [\" + ShowValueForDatesMeasureName + \"], \" +\r\n \"            CALCULATE (\" +\r\n \"                \" + dateRangeMeasure.DaxObjectFullName + \",\" +\r\n \"                DATESINPERIOD (\" +\r\n \"                    \" + dateColumnWithTable + \",\" +\r\n \"                    LASTDATE( DATEADD( \" + dateColumnWithTable + \", - 1, YEAR ) ),\" +\r\n \"                    -1,\" +\r\n \"                    YEAR\" +\r\n \"                )\" +\r\n \"            )\" +\r\n \"        )\";\r\n;\r\n\r\nstring MATvsMATminus1 =\r\n \"        /*MAT vs MAT-1*/\\r\\n\" +\r\n \"        VAR MAT = \" + MAT + \"\\r\\n\" +\r\n \"        VAR MAT_1 =\" + MATminus1 + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MAT ) || ISBLANK( MAT_1 ), BLANK(), MAT - MAT_1 )\";\r\n\r\nstring MATvsMATminus1label = \"/*MAT vs MAT-1*/\" +\r\n    \r\n \"        VAR MAT = \" + MATlabel + \"\\r\\n\" +\r\n \"        VAR MAT_1 =\" + MATminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MAT ) || ISBLANK( MAT_1 ), BLANK(), MAT & \\\" vs \\\" & MAT_1 )\";\r\n\r\nstring MATvsMATminus1pct =\r\n \"        /*MAT vs MAT-1(%)*/\" +\r\n \"        VAR MAT = \" + MAT + \"\\r\\n\" +\r\n \"        VAR MAT_1 =\" + MATminus1 + \"\\r\\n\" +\r\n \"        RETURN\" +\r\n \"            IF(\" +\r\n \"                ISBLANK( MAT ) || ISBLANK( MAT_1 ),\" +\r\n \"                BLANK(),\" +\r\n \"                DIVIDE( MAT - MAT_1, MAT_1 )\" +\r\n \"            )\";\r\n\r\nstring MATvsMATminus1pctlabel = \"/*MAT vs MAT-1 (%)*/\" +\r\n                 \"        VAR MAT = \" + MATlabel + \"\\r\\n\" +\r\n \"        VAR MAT_1 =\" + MATminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MAT ) || ISBLANK( MAT_1 ), BLANK(), MAT & \\\" vs \\\" & MAT_1 & \\\" (%)\\\" )\"; \r\n\r\nstring MMT = String.Format(\r\n        @\"/*MMT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( SELECTEDMEASURE( ), DATESINPERIOD( {1}, MAX( {1} ), -1, MONTH ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable);\r\n\r\nstring MMTlabel = String.Format(\r\n        @\"/*MMT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( {2}, DATESINPERIOD( {1}, MAX( {1} ), -1, MONTH ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable, dateRangeMeasure.DaxObjectFullName);\r\n\r\nstring MMTminus1 = String.Format(\r\n        @\"/*MMT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( SELECTEDMEASURE( ), DATESINPERIOD( {1}, LASTDATE( DATEADD( {1}, -1, MONTH ) ), -1, MONTH ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable);\r\n\r\nstring MMTminus1label = \"/*MMT-1*/\" +\r\n    String.Format(\r\n        @\"/*MMT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( {2}, DATESINPERIOD( {1}, LASTDATE( DATEADD( {1}, -1, MONTH ) ), -1, MONTH ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable, dateRangeMeasure.DaxObjectFullName);\r\n\r\nstring MMTvsMMTminus1 =\r\n \"        /*MMT vs MMT-1*/\\r\\n\" +\r\n \"        VAR MMT = \" + MMT + \"\\r\\n\" +\r\n \"        VAR MMT_1 =\" + MMTminus1 + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MMT ) || ISBLANK( MMT_1 ), BLANK(), MMT - MMT_1 )\";\r\n\r\nstring MMTvsMMTminus1label =\r\n    \"        /*MMT vs MMT-1*/\\r\\n\" +\r\n \"        VAR MMT = \" + MMTlabel + \"\\r\\n\" +\r\n \"        VAR MMT_1 =\" + MMTminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MMT ) || ISBLANK( MMT_1 ), BLANK(), MMT & \\\" vs \\\" & MMT_1 )\"; \r\n\r\nstring MMTvsMMTminus1pct =\r\n \"        /*MMT vs MMT-1(%)*/\" +\r\n \"        VAR MMT = \" + MMT + \"\\r\\n\" +\r\n \"        VAR MMT_1 =\" + MMTminus1 + \"\\r\\n\" +\r\n \"        RETURN\" +\r\n \"            IF(\" +\r\n \"                ISBLANK( MMT ) || ISBLANK( MMT_1 ),\" +\r\n \"                BLANK(),\" +\r\n \"                DIVIDE( MMT - MMT_1, MMT_1 )\" +\r\n \"            )\";\r\n\r\nstring MMTvsMMTminus1pctlabel =\r\n    \"        /*MMT vs MMT-1(%)*/\" +\r\n \"        VAR MMT = \" + MMTlabel + \"\\r\\n\" +\r\n \"        VAR MMT_1 =\" + MMTminus1label + \"\\r\\n\" +\r\n \"        RETURN\" +\r\n \"            IF( ISBLANK( MMT ) || ISBLANK( MMT_1 ), BLANK(), MMT & \\\" vs \\\" & MMT_1  & \\\" (%)\\\")\";\r\n\r\n\r\n\r\nstring MWT = String.Format(\r\n        @\"/*MWT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( SELECTEDMEASURE( ), DATESINPERIOD( {1}, MAX( {1} ), -7, DAY ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable);\r\n\r\nstring MWTlabel = \"/*MWT*/\" +\r\n    \r\n    String.Format(\r\n        @\"/*MWT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( {2}, DATESINPERIOD( {1}, MAX( {1} ), -7, DAY ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable,dateRangeMeasure.DaxObjectFullName); ;\r\n\r\nstring MWTminus1 = String.Format(\r\n        @\"/*MWT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( SELECTEDMEASURE( ), DATESINPERIOD( {1}, LASTDATE( DATEADD( {1}, -7, DAY ) ), -7, DAY ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable);\r\n\r\nstring MWTminus1label = \"/*MWT-1*/\" +\r\n    String.Format(\r\n        @\"/*MWT*/\r\nIF(\r\n[{0}],\r\nCALCULATE( {2}, DATESINPERIOD( {1}, LASTDATE( DATEADD( {1}, -7, DAY ) ), -7, DAY ) )\r\n)\", ShowValueForDatesMeasureName, dateColumnWithTable, dateRangeMeasure.DaxObjectFullName);\r\n\r\nstring MWTvsMWTminus1 =\r\n \"        /*MWT vs MWT-1*/\\r\\n\" +\r\n \"        VAR MWT = \" + MWT + \"\\r\\n\" +\r\n \"        VAR MWT_1 =\" + MWTminus1 + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MWT ) || ISBLANK( MWT_1 ), BLANK(), MWT - MWT_1 )\";\r\n\r\nstring MWTvsMWTminus1label = \r\n    \"        /*MWT vs MWT-1*/\\r\\n\" +\r\n \"        VAR MWT = \" + MWTlabel + \"\\r\\n\" +\r\n \"        VAR MWT_1 =\" + MWTminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MWT ) || ISBLANK( MWT_1 ), BLANK(), MWT & \\\" vs \\\" & MWT_1 )\"; \r\n\r\nstring MWTvsMWTminus1pct =\r\n \"        /*MWT vs MWT-1(%)*/\" +\r\n \"        VAR MWT = \" + MWT + \"\\r\\n\" +\r\n \"        VAR MWT_1 =\" + MWTminus1 + \"\\r\\n\" +\r\n \"        RETURN\" +\r\n \"            IF(\" +\r\n \"                ISBLANK( MWT ) || ISBLANK( MWT_1 ),\" +\r\n \"                BLANK(),\" +\r\n \"                DIVIDE( MWT - MWT_1, MWT_1 )\" +\r\n \"            )\";\r\n\r\nstring MWTvsMWTminus1pctlabel = \r\n    \"/*MWT vs MWT-1 (%)*/\" +\r\n \"        VAR MWT = \" + MWTlabel + \"\\r\\n\" +\r\n \"        VAR MWT_1 =\" + MWTminus1label + \"\\r\\n\" +\r\n \"        RETURN \\r\\n\" +\r\n \"            IF( ISBLANK( MWT ) || ISBLANK( MWT_1 ), BLANK(), MWT & \\\" vs \\\" & MWT_1 & \\\" (%)\\\")\";\r\n\r\n\r\n\r\nstring defFormatString = \"SELECTEDMEASUREFORMATSTRING()\";\r\n\r\n//if the flag expression is already present in the format string, do not change it, otherwise apply % format. \r\nstring pctFormatString =\r\n\"IF(\" +\r\n\"\\n FIND( \" + flagExpression + \", SELECTEDMEASUREFORMATSTRING(), 1, - 1 ) <> -1,\" +\r\n\"\\n SELECTEDMEASUREFORMATSTRING(),\" +\r\n\"\\n \\\"#,##0.# %\\\"\" +\r\n\"\\n)\";\r\n\r\n\r\n//the order in the array also determines the ordinal position of the item    \r\nstring[,] calcItems =\r\n    {\r\n{\"CY\",      CY,         defFormatString,    \"Current year\",             CYlabel},\r\n{\"PY\",      PY,         defFormatString,    \"Previous year\",            PYlabel},\r\n{\"YOY\",     YOY,        defFormatString,    \"Year-over-year\",           YOYlabel},\r\n{\"YOY%\",    YOYpct,     pctFormatString,    \"Year-over-year%\",          YOYpctLabel},\r\n{\"YTD\",     YTD,        defFormatString,    \"Year-to-date\",             YTDlabel},\r\n{\"PYTD\",    PYTD,       defFormatString,    \"Previous year-to-date\",    PYTDlabel},\r\n{\"YOYTD\",   YOYTD,      defFormatString,    \"Year-over-year-to-date\",   YOYTDlabel},\r\n{\"YOYTD%\",  YOYTDpct,   pctFormatString,    \"Year-over-year-to-date%\",  YOYTDpctLabel},\r\n{\"MAT\",     MAT,        defFormatString,    \"Moving Anual Total\",       MATlabel},\r\n{\"MAT-1\",   MATminus1,  defFormatString,    \"Moving Anual Total -1 year\", MATminus1label},\r\n{\"MAT vs MAT-1\", MATvsMATminus1, defFormatString, \"Moving Anual Total vs Moving Anual Total -1 year\", MATvsMATminus1label},\r\n{\"MAT vs MAT-1(%)\", MATvsMATminus1pct, pctFormatString, \"Moving Anual Total vs Moving Anual Total -1 year (%)\", MATvsMATminus1pctlabel},\r\n{\"MMT\",     MMT,        defFormatString,    \"Moving Monthly Total\",       MMTlabel},\r\n{\"MMT-1\",   MMTminus1,  defFormatString,    \"Moving Monthly Total -1 month\", MMTminus1label},\r\n{\"MMT vs MMT-1\", MMTvsMMTminus1, defFormatString, \"Moving Monthly Total vs Moving Monthly Total -1 month\", MMTvsMMTminus1label},\r\n{\"MMT vs MMT-1(%)\", MMTvsMMTminus1pct, pctFormatString, \"Moving Monthly Total vs Moving Monthly Total -1 month (%)\", MMTvsMMTminus1pctlabel},\r\n{\"MWT\",     MWT,        defFormatString,    \"Moving Weekly Total\",       MWTlabel},\r\n{\"MWT-1\",   MWTminus1,  defFormatString,    \"Moving Weekly Total -1 week\", MWTminus1label},\r\n{\"MWT vs MWT-1\", MWTvsMWTminus1, defFormatString, \"Moving Weekly Total vs Moving Weekly Total -1 week\", MWTvsMWTminus1label},\r\n{\"MWT vs MWT-1(%)\", MWTvsMWTminus1pct, pctFormatString, \"Moving Weekly Total vs Moving Weekly Total -1 week (%)\", MWTvsMWTminus1pctlabel}\r\n};\r\n\r\n\r\nint j = 0;\r\n\r\n\r\n//create calculation items for each calculation with formatstring and description\r\nforeach (var cg in Model.CalculationGroups)\r\n{\r\n    if (cg.Name == calcGroupName)\r\n    {\r\n        for (j = 0; j < calcItems.GetLength(0); j++)\r\n        {\r\n\r\n            string itemName = calcItems[j, 0];\r\n\r\n            string itemExpression = calcItemProtection.Replace(\"<CODE>\", calcItems[j, 1]);\r\n            itemExpression = itemExpression.Replace(\"<LABELCODE>\", calcItems[j, 4]);\r\n\r\n            string itemFormatExpression = calcItemFormatProtection.Replace(\"<CODE>\", calcItems[j, 2]);\r\n            itemFormatExpression = itemFormatExpression.Replace(\"<LABELCODEFORMATSTRING>\", \"\\\"\\\"\\\"\\\" & \" + calcItems[j, 4] + \" & \\\"\\\"\\\"\\\"\");\r\n\r\n            //if(calcItems[j,2] != defFormatString) {\r\n            //    itemFormatExpression = calcItemFormatProtection.Replace(\"<CODE>\",calcItems[j,2]);\r\n            //};\r\n\r\n            string itemDescription = calcItems[j, 3];\r\n\r\n            if (!cg.CalculationItems.Contains(itemName))\r\n            {\r\n                var nCalcItem = cg.AddCalculationItem(itemName, itemExpression);\r\n                nCalcItem.FormatStringExpression = itemFormatExpression;\r\n                nCalcItem.FormatDax();\r\n                nCalcItem.Ordinal = j;\r\n                nCalcItem.Description = itemDescription;\r\n\r\n            };\r\n\r\n\r\n\r\n\r\n        };\r\n\r\n\r\n    };\r\n};",
      "Tooltip": "creates sum measures for selected columns",
      "ValidContexts": "Measure"
    },
    {
      "Id": 1,
      "Name": "1. Measure Create\\1. Add From Column\\1. All columns ending with key or ID: Set Summarize By to None",
      "Enabled": "true",
      "Execute": "// Change SummarizeBy to None for All ID and Key columns ***********************************************************\n\n    foreach (var table in Model.Tables)\n    {\n        foreach (var column in table.Columns)\n        {\n            if (column.Name.EndsWith(\"Key\") || column.Name.EndsWith(\"ID\"))\n            {\n                column.SummarizeBy = AggregateFunction.None;\n            }\n        }\n    }\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 2,
      "Name": "1. Measure Create\\1. Add From Column\\2. Selected Measures based on Summarize By Property",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\n// Ask the user if they want to add the new measure to the current table\nDialogResult dialogResult = MessageBox.Show(\"Do you want to add the new measure to the current table? (Click 'No' to add it to a custom table)\", \"Select Target Table\", MessageBoxButtons.YesNo);\n\nstring measuresTableName = Selected.Columns.First().Table.Name;\nif (dialogResult == DialogResult.No)\n{\n    // Ask for the name of the measure table if the user selects \"No\"\n    measuresTableName = Interaction.InputBox(\"Provide the name of the measure table\", \"Name of Measure Table\", \"Measure\");\n\n    // Check if the provided table exists\n    if (Model.Tables.FirstOrDefault(table => table.Name == measuresTableName) == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\n// Create a SUM measure for every currently selected column and hide the column\nforeach(var c in Selected.Columns)\n{\n    if (c.SummarizeBy.ToString().Equals(\"None\", StringComparison.OrdinalIgnoreCase))\n    {\n        continue;\n    }\n\n    // Use the target table determined by user selection or default \"Measure\" table\n    var measuresTable = Model.Tables[measuresTableName];\n    var newMeasure = measuresTable.AddMeasure(\n        /*\"Sum_\" +*/ c.Name,                            // Name\n        /*\"SUM(\"*/ c.SummarizeBy.ToString().ToUpper() + \"(\"+ c.DaxObjectFullName + \")\",         // DAX expression\n        c.Table.Name                                // Display Folder\n    );\n    \n    // Set the format string on the new measure:\n    newMeasure.FormatString = \"0.0\";\n\n    // Provide some documentation:\n    newMeasure.Description = \"This measure is the sum of column \" + c.DaxObjectFullName;\n\n    // Hide the base column:\n    c.IsHidden = true;\n}\n",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 3,
      "Name": "1. Measure Create\\1. Add From Column\\3. Add Explicit Measure Auto-Create ALL Columns",
      "Enabled": "true",
      "Execute": "// Title: Auto-create explicit measures from all columns in all tables that have qualifying aggregation functions assigned \r\n//  \r\n// Author: Tom Martens, twitter.com/tommartens68\r\n// \r\n// This script, when executed, will loop through all the tables and creates explicit measure for all the columns with qualifying\r\n// aggregation functions.\r\n// The qualifying aggregation functions are SUM, COUNT, MIN, MAX, AVERAGE.\r\n// This script can create a lot of measures, as by default the aggregation function for columns with a numeric data type is SUM.\r\n// So, it is a good idea to check all columns for the proper aggregation type, e.g. the aggregation type of id columns \r\n// should be set to None, as it does not make any sense to aggregate id columns.\r\n// An annotation:CreatedThrough is created with a value:CreateExplicitMeasures this will help to identify the measures created\r\n// using this script.\r\n// What is missing, the list below shows what might be coming in subsequent iterations of the script:\r\n// - the base column property hidden is not set to true\r\n// - no black list is used to prevent the creation of unwanted measures\r\n\r\n// ***************************************************************************************************************\r\n//the following variables are allowing controling the script\r\nvar overwriteExistingMeasures = 0; // 1 overwrites existing measures, 0 preserves existing measures\r\n\r\nvar measureNameTemplate = \"{0} ({1}) \";\r\n//\"{0} ({1}) - {2}\"; // String.Format is used to create the measure name. \r\n//{0} will be replaced with the columnname (c.Name), {1} will be replaced with the aggregation function, and last but not least\r\n//{2} will be replaced with the tablename (t.Name). Using t.Name is necessary to create a distinction between measure names if\r\n//columns with the same name exist in different tables.\r\n//Assuming the column name inside the table \"Fact Sale\" is \"Sales revenue\" and the aggregation function is SUM \r\n//the measure name will be: \"Sales revenue (Sum) - Fact Sale\"\r\n\r\n//store aggregation function that qualify for measure creation to the hashset aggFunctions\r\nvar aggFunctions = new HashSet<AggregateFunction>{\r\n    AggregateFunction.Default, //remove this line, if you do not want to mess up your measures list by automatically created measures for all the columns that have the Default AggregateFunction assigned\r\n    AggregateFunction.Sum,\r\n    AggregateFunction.Count,\r\n    AggregateFunction.Min,\r\n    AggregateFunction.Max,\r\n    AggregateFunction.Average\r\n};\r\n\r\n//You have to be aware that by default this script will just create measures using the aggregate functions \"Sum\" or \"Count\" if\r\n//the column has the aggregate function AggregateFunction.Default assigned, this is checked further down below.\r\n//Also, if a column has the Default AggregateFunction assigned and is of the DataType\r\n//DataType.Automatic, DataType.Unknown, or DataType.Variant, no measure is created automatically, this is checked further down below.\r\n//dictDataTypeAggregateFunction = new Dictionary<DataType, string>();\r\n//see this article for all the available data types: https://docs.microsoft.com/en-us/dotnet/api/microsoft.analysisservices.tabular.datatype?view=analysisservices-dotnet\r\n//Of course you can change the aggregation function that will be used for different data types,\r\n//as long as you are using \"Sum\" and \"Count\"\r\n//Please be careful, if you change the aggregation function you might end up with multiplemeasures\r\nvar dictDataTypeAggregateFunction = new Dictionary<DataType, AggregateFunction>();\r\ndictDataTypeAggregateFunction.Add( DataType.Binary , AggregateFunction.Count ); //adding a key/value pair(s) to the dictionary using the Add() method\r\ndictDataTypeAggregateFunction.Add( DataType.Boolean , AggregateFunction.Count );\r\ndictDataTypeAggregateFunction.Add( DataType.DateTime , AggregateFunction.Count );\r\ndictDataTypeAggregateFunction.Add( DataType.Decimal , AggregateFunction.Sum );\r\ndictDataTypeAggregateFunction.Add( DataType.Double , AggregateFunction.Sum );\r\ndictDataTypeAggregateFunction.Add( DataType.Int64 , AggregateFunction.Sum );\r\ndictDataTypeAggregateFunction.Add( DataType.String , AggregateFunction.Count );\r\n\r\n// ***************************************************************************************************************\r\n//all the stuff below this line should not be altered \r\n//of course this is not valid if you have to fix my errors, make the code more efficient, \r\n//or you have a thorough understanding of what you are doing\r\n\r\n//store all the existing measures to the list listOfMeasures\r\nvar listOfMeasures = new List<string>();\r\nforeach( var m in Model.AllMeasures ) {\r\n    listOfMeasures.Add( m.Name );\r\n}\r\n\r\n//loop across all tables\r\nforeach( var t in Model.Tables ) {\r\n    \r\n    //loop across all columns of the current table t\r\n    foreach( var c in t.Columns ) {\r\n        \r\n        var currAggFunction = c.SummarizeBy; //cache the aggregation function of the current column c\r\n        var useAggFunction = AggregateFunction.Sum;\r\n        var theMeasureName = \"\"; // Name of the new Measure\r\n        var posInListOfMeasures = 0; //check if the new measure already exists <> -1\r\n        \r\n        if( aggFunctions.Contains(currAggFunction) ) //check if the current aggregation function qualifies for measure aggregation\r\n        {\r\n            //check if the current aggregation function is Default\r\n            if( currAggFunction == AggregateFunction.Default )\r\n            {\r\n                // check if the datatype of the column is considered for measure creation\r\n                if( dictDataTypeAggregateFunction.ContainsKey( c.DataType ) )\r\n                {\r\n                    \r\n                    //some kind of sanity check\r\n                    if( c.DataType == DataType.Automatic || c.DataType == DataType.Unknown || c.DataType == DataType.Variant )\r\n                    {\r\n                        Output(\"No measure will be created for columns with the data type: \" + c.DataType.ToString() + \" (\" + c.DaxObjectFullName + \")\");\r\n                        continue; //moves to the next item in the foreach loop, the next colum in the current table\r\n                    }\r\n                  \r\n                    //cache the aggregation function from the dictDataTypeAggregateFunction\r\n                    useAggFunction = dictDataTypeAggregateFunction[ c.DataType ];\r\n                    \r\n                    //some kind of sanity check\r\n                    if( useAggFunction != AggregateFunction.Count && useAggFunction != AggregateFunction.Sum ) \r\n                    {    \r\n                        Output(\"No measure will be created for the column: \" + c.DaxObjectFullName);\r\n                        continue; //moves to the next item in the foreach loop, the next colum in the current table\r\n                    }\r\n                    theMeasureName = String.Format( measureNameTemplate , c.Name , useAggFunction.ToString() , t.Name ); // Name of the new Measure\r\n                    posInListOfMeasures = listOfMeasures.IndexOf( theMeasureName ); //check if the new measure already exists <> -1\r\n                    \r\n                } else {\r\n                   \r\n                    continue; //moves to the next item in the foreach loop, the next colum in the current table\r\n                }\r\n                        \r\n            } else {\r\n                \r\n                useAggFunction = currAggFunction;    \r\n                theMeasureName = String.Format( measureNameTemplate , c.Name , useAggFunction.ToString() , t.Name ); // Name of the new Measure\r\n                posInListOfMeasures = listOfMeasures.IndexOf( theMeasureName ); //check if the new measure already exists <> -1\r\n                \r\n            }\r\n            \r\n            //sanity check\r\n            if(theMeasureName == \"\")\r\n            {\r\n                continue; //moves to the next item in the foreach loop, the next colum in the current table\r\n            }\r\n            \r\n            // create the measure\r\n            if( ( posInListOfMeasures == -1 || overwriteExistingMeasures == 1 )) \r\n            {    \r\n                if( overwriteExistingMeasures == 1 ) \r\n                {\r\n                    foreach( var m in Model.AllMeasures.Where( m => m.Name == theMeasureName ).ToList() ) \r\n                    {\r\n                        m.Delete();\r\n                    }\r\n                }\r\n                \r\n                var newMeasure = t.AddMeasure\r\n                (\r\n                    theMeasureName                                                                      // Name of the new Measure\r\n                    , \"\" + useAggFunction.ToString().ToUpper() + \"(\" + c.DaxObjectFullName + \")\"        // DAX expression\r\n                );\r\n                \r\n                newMeasure.SetAnnotation( \"CreatedThrough\" , \"CreateExplicitMeasures\" ); // flag the measures created through this script\r\n                \r\n            }\r\n        }    \r\n    }        \r\n}",
      "Tooltip": "This adds for selected Tables all explicit sum measures",
      "ValidContexts": "Model, Table"
    },
    {
      "Id": 4,
      "Name": "1. Measure Create\\2. Time: PY\\1. Y-1",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\nvar newMeasures = new List<Measure>();\n\n// Find the table with the data category \"Time\"\nvar CalendarTable = Model.Tables.FirstOrDefault(table => table.DataCategory == \"Time\");\n\nif (CalendarTable == null)\n{\n    string tableName = Interaction.InputBox(\"Provide the name of the date dimension table\", \"Table Name\", \"Calendar\");\n    CalendarTable = Model.Tables.FirstOrDefault(table => table.Name == tableName);\n\n    if (CalendarTable == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\n\n// Checking for Date Column otherwise prompt for user input\nstring DateColumn = null;\n// Check if there is a column in the CalendarTable with IsKey = true\nvar keyColumn = CalendarTable.Columns.FirstOrDefault(col => col.IsKey == true);\nif (keyColumn != null)\n{\n    DateColumn = keyColumn.Name;\n}\nelse\n{\n    // If no key column found, prompt the user for input\n    DateColumn = Interaction.InputBox(\"Provide the name of the date column name\", \"Column Name\", \"Date\");\n}\n\n\n\n\n// Ask the user if they want to add the new measure to the current table\nDialogResult dialogResult = MessageBox.Show(\"Do you want to add the new measure to the current table? (Click 'No' to add it to a custom table)\", \"Select Target Table\", MessageBoxButtons.YesNo);\n\nstring measuresTableName = null;\nif (dialogResult == DialogResult.No)\n{\n    // Ask for the name of the measure table if the user selects \"No\"\n    measuresTableName = Interaction.InputBox(\"Provide the name of the measure table\", \"Name of Measure Table\", \"Measure\");\n\n    // Check if the provided table exists\n    if (Model.Tables.FirstOrDefault(table => table.Name == measuresTableName) == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\nforeach (var selectedMeasure in Selected.Measures)\n{\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" PY\";\n    \n    string newExpression1 = \n        \"CALCULATE(\" +\n        \"[\"+selectedMeasure.Name+\"]\" + \", \" \n        +\"SAMEPERIODLASTYEAR(\"+CalendarTable.Name +\"[\"+DateColumn+\"]))\";\n\n    // Add the new measure based on the user's choice\n    Measure newMeasure1;\n    if (dialogResult == DialogResult.Yes)\n    {\n        // Add measure to the current table (selectedMeasure.Table)\n        newMeasure1 = selectedMeasure.Table.AddMeasure(newMeasureName1, newExpression1);\n    }\n    else\n    {\n        // Add measure to the user-specified table\n        var measuresTable = Model.Tables.FirstOrDefault(table => table.Name == measuresTableName);\n        newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n    }\n\n    // Set the format and add to the list\n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    // Set the DisplayFolder to the current DisplayFolder + \"PY\"\n    newMeasure1.DisplayFolder = string.IsNullOrEmpty(selectedMeasure.DisplayFolder) ? \"PY\" : selectedMeasure.DisplayFolder + @\"\\PY\";\n\n    newMeasures.Add(newMeasure1);\n    // Format the DAX of the new measure\n    FormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);\n\n}\n\n\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 5,
      "Name": "1. Measure Create\\2. Time: PY\\2. Δ Y-1",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\nvar newMeasures = new List<Measure>();\n\n// Find the table with the data category \"Time\"\nvar CalendarTable = Model.Tables.FirstOrDefault(table => table.DataCategory == \"Time\");\n\nif (CalendarTable == null)\n{\n    string tableName = Interaction.InputBox(\"Provide the name of the date dimension table\", \"Table Name\", \"Calendar\");\n    CalendarTable = Model.Tables.FirstOrDefault(table => table.Name == tableName);\n\n    if (CalendarTable == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\n// Checking for Date Column otherwise prompt for user input\nstring DateColumn = null;\n// Check if there is a column in the CalendarTable with IsKey = true\nvar keyColumn = CalendarTable.Columns.FirstOrDefault(col => col.IsKey == true);\nif (keyColumn != null)\n{\n    DateColumn = keyColumn.Name;\n}\nelse\n{\n    // If no key column found, prompt the user for input\n    DateColumn = Interaction.InputBox(\"Provide the name of the date column name\", \"Column Name\", \"Date\");\n}\n\n\n// Ask the user if they want to add the new measure to the current table\nDialogResult dialogResult = MessageBox.Show(\"Do you want to add the new measure to the current table? (Click 'No' to add it to a custom table)\", \"Select Target Table\", MessageBoxButtons.YesNo);\n\nstring measuresTableName = null;\nif (dialogResult == DialogResult.No)\n{\n    // Ask for the name of the measure table if the user selects \"No\"\n    measuresTableName = Interaction.InputBox(\"Provide the name of the measure table\", \"Name of Measure Table\", \"Measure\");\n\n    // Check if the provided table exists\n    if (Model.Tables.FirstOrDefault(table => table.Name == measuresTableName) == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\nforeach (var selectedMeasure in Selected.Measures)\n{\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" Δ PY\";\n    \n    string newExpression1 = \n        \"[\"+selectedMeasure.Name+\"] - \" + \"[\"+selectedMeasure.Name+\" PY]\";\n\n    // Add the new measure based on the user's choice\n    Measure newMeasure1;\n    if (dialogResult == DialogResult.Yes)\n    {\n        // Add measure to the current table (selectedMeasure.Table)\n        newMeasure1 = selectedMeasure.Table.AddMeasure(newMeasureName1, newExpression1);\n    }\n    else\n    {\n        // Add measure to the user-specified table\n        var measuresTable = Model.Tables.FirstOrDefault(table => table.Name == measuresTableName);\n        newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n    }\n\n    // Set the format and add to the list\n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasure1.DisplayFolder = string.IsNullOrEmpty(selectedMeasure.DisplayFolder) ? \"PY\" : selectedMeasure.DisplayFolder + @\"\\PY\";\n    newMeasures.Add(newMeasure1);\n    // Format the DAX of the new measure\n    FormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);\n\n}\n\n\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 6,
      "Name": "1. Measure Create\\2. Time: PY\\3. Δ Y-1%",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\nvar newMeasures = new List<Measure>();\n\n// Find the table with the data category \"Time\"\nvar CalendarTable = Model.Tables.FirstOrDefault(table => table.DataCategory == \"Time\");\n\nif (CalendarTable == null)\n{\n    string tableName = Interaction.InputBox(\"Provide the name of the date dimension table\", \"Table Name\", \"Calendar\");\n    CalendarTable = Model.Tables.FirstOrDefault(table => table.Name == tableName);\n\n    if (CalendarTable == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\n// Checking for Date Column otherwise prompt for user input\nstring DateColumn = null;\n// Check if there is a column in the CalendarTable with IsKey = true\nvar keyColumn = CalendarTable.Columns.FirstOrDefault(col => col.IsKey == true);\nif (keyColumn != null)\n{\n    DateColumn = keyColumn.Name;\n}\nelse\n{\n    // If no key column found, prompt the user for input\n    DateColumn = Interaction.InputBox(\"Provide the name of the date column name\", \"Column Name\", \"Date\");\n}\n\n\n// Ask the user if they want to add the new measure to the current table\nDialogResult dialogResult = MessageBox.Show(\"Do you want to add the new measure to the current table? (Click 'No' to add it to a custom table)\", \"Select Target Table\", MessageBoxButtons.YesNo);\n\nstring measuresTableName = null;\nif (dialogResult == DialogResult.No)\n{\n    // Ask for the name of the measure table if the user selects \"No\"\n    measuresTableName = Interaction.InputBox(\"Provide the name of the measure table\", \"Name of Measure Table\", \"Measure\");\n\n    // Check if the provided table exists\n    if (Model.Tables.FirstOrDefault(table => table.Name == measuresTableName) == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\nforeach (var selectedMeasure in Selected.Measures)\n{\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" Δ PY %\";\n    \n    string newExpression1 = \n        \"DIVIDE([\"+selectedMeasure.Name+\"] - \" + \"[\"+selectedMeasure.Name+\" PY], [\"+selectedMeasure.Name+\"])\";\n\n    // Add the new measure based on the user's choice\n    Measure newMeasure1;\n    if (dialogResult == DialogResult.Yes)\n    {\n        // Add measure to the current table (selectedMeasure.Table)\n        newMeasure1 = selectedMeasure.Table.AddMeasure(newMeasureName1, newExpression1);\n    }\n    else\n    {\n        // Add measure to the user-specified table\n        var measuresTable = Model.Tables.FirstOrDefault(table => table.Name == measuresTableName);\n        newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n    }\n\n    // Set the format and add to the list\n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasure1.DisplayFolder = string.IsNullOrEmpty(selectedMeasure.DisplayFolder) ? \"PY\" : selectedMeasure.DisplayFolder + @\"\\PY\";\n    newMeasures.Add(newMeasure1);\n    // Format the DAX of the new measure\n    FormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);\n\n}\n\n\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 7,
      "Name": "1. Measure Create\\2. Time: PY\\4. ALL Y-1",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\nvar newMeasures = new List<Measure>();\n\n// Find the table with the data category \"Time\"\nvar CalendarTable = Model.Tables.FirstOrDefault(table => table.DataCategory == \"Time\");\n\nif (CalendarTable == null)\n{\n    string tableName = Interaction.InputBox(\"Provide the name of the date dimension table\", \"Table Name\", \"Calendar\");\n    CalendarTable = Model.Tables.FirstOrDefault(table => table.Name == tableName);\n\n    if (CalendarTable == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\n// Checking for Date Column otherwise prompt for user input\nstring DateColumn = null;\n// Check if there is a column in the CalendarTable with IsKey = true\nvar keyColumn = CalendarTable.Columns.FirstOrDefault(col => col.IsKey == true);\nif (keyColumn != null)\n{\n    DateColumn = keyColumn.Name;\n}\nelse\n{\n    // If no key column found, prompt the user for input\n    DateColumn = Interaction.InputBox(\"Provide the name of the date column name\", \"Column Name\", \"Date\");\n}\n\n\n// Ask the user if they want to add the new measure to the current table\nDialogResult dialogResult = MessageBox.Show(\"Do you want to add the new measure to the current table? (Click 'No' to add it to a custom table)\", \"Select Target Table\", MessageBoxButtons.YesNo);\n\nstring measuresTableName = null;\nif (dialogResult == DialogResult.No)\n{\n    // Ask for the name of the measure table if the user selects \"No\"\n    measuresTableName = Interaction.InputBox(\"Provide the name of the measure table\", \"Name of Measure Table\", \"Measure\");\n\n    // Check if the provided table exists\n    if (Model.Tables.FirstOrDefault(table => table.Name == measuresTableName) == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\nforeach (var selectedMeasure in Selected.Measures)\n{\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" PY\";\n    string newExpression1 = \n        \"CALCULATE(\" +\n        \"[\"+selectedMeasure.Name+\"]\" + \", \" \n        +\"SAMEPERIODLASTYEAR(\"+CalendarTable.Name +\"[\"+DateColumn+\"]))\";\n\n    string newMeasureName2 = selectedMeasure.Name + \" Δ PY\";\n    string newExpression2 = \n        \"[\"+selectedMeasure.Name+\"] - \" + \"[\"+selectedMeasure.Name+\" PY]\";\n\n    string newMeasureName3 = selectedMeasure.Name + \" Δ PY %\";\n    string newExpression3 = \n        \"DIVIDE([\"+selectedMeasure.Name+\"] - \" + \"[\"+selectedMeasure.Name+\" PY], [\"+selectedMeasure.Name+\"])\";\n\n    // Add the new measure based on the user's choice\n    Measure newMeasure1;\n    Measure newMeasure2;\n    Measure newMeasure3;\n    if (dialogResult == DialogResult.Yes)\n    {\n        // Add measure to the current table (selectedMeasure.Table)\n        newMeasure1 = selectedMeasure.Table.AddMeasure(newMeasureName1, newExpression1);\n        newMeasure2 = selectedMeasure.Table.AddMeasure(newMeasureName2, newExpression2);\n        newMeasure3 = selectedMeasure.Table.AddMeasure(newMeasureName3, newExpression3);\n    }\n    else\n    {\n        // Add measure to the user-specified table\n        var measuresTable = Model.Tables.FirstOrDefault(table => table.Name == measuresTableName);\n        newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n        newMeasure2 = measuresTable.AddMeasure(newMeasureName2, newExpression2);\n        newMeasure3 = measuresTable.AddMeasure(newMeasureName3, newExpression3);\n    }\n\n    // Set the format and add to the list\n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasure1.DisplayFolder = string.IsNullOrEmpty(selectedMeasure.DisplayFolder) ? \"PY\" : selectedMeasure.DisplayFolder + @\"\\PY\";\n    newMeasure2.FormatString = selectedMeasure.FormatString;\n    newMeasure2.DisplayFolder = string.IsNullOrEmpty(selectedMeasure.DisplayFolder) ? \"PY\" : selectedMeasure.DisplayFolder + @\"\\PY\";\n    newMeasure3.FormatString = selectedMeasure.FormatString;\n    newMeasure3.DisplayFolder = string.IsNullOrEmpty(selectedMeasure.DisplayFolder) ? \"PY\" : selectedMeasure.DisplayFolder + @\"\\PY\";\n\n    newMeasures.Add(newMeasure1);\n    newMeasures.Add(newMeasure2);\n    newMeasures.Add(newMeasure3);\n\n    // Format the DAX of the new measure\n    FormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);\n\n}\n\n\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 8,
      "Name": "1. Measure Create\\3. Time: Other\\M-1",
      "Enabled": "true",
      "Execute": "var newMeasures = new List<Measure>();\n    \nforeach (var selectedMeasure in Selected.Measures)\n    {\n    // Get the selected measure\n    var measuresTable = Model.Tables[\"Measure\"];\n    var Kalendartable = \"Calendar\";\n    var MonthColumn = \"Month (MMM)\";\n    var RelativMonth = \"Relative Month\";\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" M-1\";\n    \n    string newExpression1 = \n        \"IF(DISTINCTCOUNT(\"+Kalendartable+\"[\"+MonthColumn+\"])=1,[\"+selectedMeasure.Name+\"]\"\n        +\",CALCULATE(\" +\n        \"[\"+selectedMeasure.Name+\"]\" + \", \" \n        +Kalendartable+\"[\"+RelativMonth+\"]=-1))\";\n\n    // Create the new measure in the same table as the selected measure\n    var newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n\n    // Set the display folder for the new measure\n    //newMeasure1.DisplayFolder = \"Just Created \" + selectedMeasure.Name;\n    \n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasures.Add(newMeasure1);\n    \n}\n\nFormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 9,
      "Name": "1. Measure Create\\3. Time: Other\\Measure: YTD",
      "Enabled": "true",
      "Execute": "var newMeasures = new List<Measure>();\n   \n foreach (var selectedMeasure in Selected.Measures)\n    {\n    // Variables to use and getting the measure table\n    var measuresTable = Model.Tables[\"Measure\"];\n    var Kalendartable = \"Calendar\";\n    var MonthColumn = \"Month (MMM)\";\n    var RelativMonth = \"Relative Month\";\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" YTD\";\n    \n    string newExpression1 = \n            \"CALCULATE([\"+selectedMeasure.Name+\"],ALL('\"+Kalendartable+\"'),'\"+Kalendartable+\"'[\"+RelativMonth+\"]<0,'\"+Kalendartable+\"'[\"+RelativMonth+\"]>-13)\";\n        \n    // Create the new measure in the same table as the selected measure\n    var newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n\n    // Set the display folder for the new measure\n    //newMeasure1.DisplayFolder =  Get.selectedMeasure.DisplayFolder;\n    \n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasures.Add(newMeasure1);\n\n}\n\nFormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);\n//FormatDax(Model.AllMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 10,
      "Name": "1. Measure Create\\4. Replace Text in Measure",
      "Enabled": "true",
      "Execute": "// Iterate over each measure in the selected measures to replace occurrences of a specific text\r\nforeach (var measure in Selected.Measures)\r\n{\r\n    const string textToReplace = \"Text_To_Replace\";\r\n    const string replacementText = \"Text_Instead\";\r\n\r\n    // Replace all occurrences of the text in the measure's name\r\n    string updatedName = measure.Name.Replace(textToReplace, replacementText);\r\n\r\n    // Update the measure's name\r\n    measure.Name = updatedName;\r\n}\r\n\r\n// Optionally, apply other updates or process further\r\n",
      "Tooltip": "This adds for selected Tables all explicit sum measures",
      "ValidContexts": "Model, Table, Measure"
    },
    {
      "Id": 11,
      "Name": "1. Measure Create\\5. Add Explicit Measures: Card",
      "Enabled": "true",
      "Execute": "    foreach (var selectedMeasure in Selected.Measures)\r\n    {\r\n    // Get the selected measure\r\n    var measuresTable = Model.Tables[\"Measure\"];\r\n\r\n    // Define the new measure name and expression\r\n    string newMeasureName1 = selectedMeasure.Name + \" M-1\";\r\n    string newMeasureName2 = selectedMeasure.Name + \" M-2\";\r\n    string newMeasureName3 = selectedMeasure.Name + \" M-13\";\r\n    string newMeasureName4 = selectedMeasure.Name + \" Δ Delta M-2\";\r\n    string newMeasureName5 = selectedMeasure.Name + \" Δ Delta M-2 %\";\r\n    string newMeasureName6 = selectedMeasure.Name + \" Δ Delta M-13\";\r\n    string newMeasureName7 = selectedMeasure.Name + \" Δ Delta M-13 %\";\r\n    string newMeasureName8 = selectedMeasure.Name + \" Reference 1 Δ Vormonat\";\r\n    string newMeasureName9 = selectedMeasure.Name + \" Reference 2 Δ Vorjahr\";\r\n    string newMeasureName10 = selectedMeasure.Name + \" Sparkline SVG\";\r\n    string newMeasureName11 = selectedMeasure.Name + \" Color Δ PM\";\r\n    string newMeasureName12 = selectedMeasure.Name + \" Color Δ LY\";\r\n    \r\n    string newExpression1 = \r\n        \"IF(ISFILTERED(Kalender[Monat (MMM)]),[\"+selectedMeasure.Name+\"]\"\r\n        +\",CALCULATE(\" +\r\n        \"[\"+selectedMeasure.Name+\"]\" + \", \" +\r\n        \"Kalender[Relativer Monat #]=-1))\";\r\n    string newExpression2 = \r\n        \"CALCULATE(\" +\r\n        \"[\"+selectedMeasure.Name+\"]\" + \", \" +\r\n        \"Kalender[Relativer Monat #]=-2)\";\r\n    string newExpression3 = \r\n        \"CALCULATE(\" +\r\n        \"[\"+selectedMeasure.Name+\"]\" + \", \" +\r\n        \"Kalender[Relativer Monat #]=-13)\";\r\n    \r\n    string newExpression4 = \r\n        \"IF( ISFILTERED(Kalender[Monat (MMM)])\"+\r\n        \",[\"+selectedMeasure.Name+\"]\"\r\n        +\"-CALCULATE(\"+\"[\"+selectedMeasure.Name+\"]\"+\",PREVIOUSMONTH(Kalender[Datum]))\"+\r\n        \",[\"+newMeasureName1+\"]-[\"+newMeasureName2+\"])\";\r\n    string newExpression5 = \r\n        \"IF( ISFILTERED(Kalender[Monat (MMM)])\"+\r\n        \",[\"+newMeasureName4+\"]/CALCULATE(\"+\"[\"+selectedMeasure.Name+\"]\"+\",PREVIOUSMONTH(Kalender[Datum]))\"+\r\n        \",[\"+newMeasureName4+\"]/[\"+newMeasureName1+\"])\";\r\n\r\n    //string newExpression6 =  \"[\"+newMeasureName1+\"]-[\"+newMeasureName3+\"]\";\r\n    //string newExpression7 =  \"[\"+newMeasureName6+\"]/[\"+newMeasureName1+\"]\";\r\n    \r\n    string newExpression6 = \r\n        \"IF( ISFILTERED(Kalender[Monat (MMM)])\"+\r\n        \",\"+\"[\"+selectedMeasure.Name+\"]\"\r\n        +\"-CALCULATE(\"+\"[\"+selectedMeasure.Name+\"]\"+\",SAMEPERIODLASTYEAR(Kalender[Datum]))\"+\r\n        \",[\"+newMeasureName1+\"]-[\"+newMeasureName3+\"])\";\r\n    string newExpression7 = \r\n        \"IF( ISFILTERED(Kalender[Monat (MMM)])\"+\r\n        \",[\"+newMeasureName6+\"]/CALCULATE(\"+\"[\"+selectedMeasure.Name+\"]\"+\",SAMEPERIODLASTYEAR(Kalender[Datum]))\"+\r\n        \",[\"+newMeasureName6+\"]/[\"+newMeasureName1+\"])\";\r\n    \r\n    string newExpression8 = \"var _sign_icon = IF([\" + newMeasureName4 + \"] > 0, \\\"▲ +\\\", \\\"▼ -\\\" & UNICHAR(127))\\n\" +\r\n                            \"var _sign_plusminus = IF([\" + newMeasureName4 + \"] > 0, \\\" | +\\\", \\\" | - \\\")\\n\" +\r\n                            \"var _valprct = ABS([\" + newMeasureName5 + \"])\\n\" +\r\n                            \"var _valdiff = ABS([\" + newMeasureName4 + \"])\\n\" +\r\n                            \"RETURN _sign_icon & FORMAT(_valprct, \\\"#.0%\\\") & _sign_plusminus & FORMAT(_valdiff, \\\"#,0\\\")\";\r\n    string newExpression9 = \"var _sign_icon = IF([\" + newMeasureName6 + \"] > 0, \\\"▲ +\\\", \\\"▼ -\\\" & UNICHAR(127))\\n\" +\r\n                            \"var _sign_plusminus = IF([\" + newMeasureName6 + \"] > 0, \\\" | +\\\", \\\" | - \\\")\\n\" +\r\n                            \"var _valprct = ABS([\" + newMeasureName7 + \"])\\n\" +\r\n                            \"var _valdiff = ABS([\" + newMeasureName6 + \"])\\n\" +\r\n                            \"RETURN _sign_icon & FORMAT(_valprct, \\\"#.0%\\\") & _sign_plusminus & FORMAT(_valdiff, \\\"#,0\\\")\";\r\n    \r\n    string newExpression10 =\r\n    \"VAR LineColour = \\\"%23808080\\\"\\n\" +\r\n    \"VAR PointColour = \\\"white\\\"\\n\" +\r\n    \"VAR Defs = \" +\r\n        \"\\\"<defs><linearGradient id='grad' x1='0' y1='25' x2='0' y2='50' gradientUnits='userSpaceOnUse'>\" +\r\n        \"<stop stop-color='%23808080' offset='0' />\" +\r\n        \"<stop stop-color='%23808080' offset='0.3' />\" +\r\n        \"<stop stop-color='white' offset='1' />\" +\r\n        \"</linearGradient></defs>\\\"\\n\" +\r\n    \"VAR XMinDate = MIN('Kalender'[MonatKey #])\\n\" +\r\n    \"VAR XMaxDate = MAX('Kalender'[MonatKey #])\\n\" +\r\n    \"VAR YMinValue = MINX(Values(Kalender[MonatKey #]),[\"+selectedMeasure.Name+\"])\\n\" +\r\n    \"VAR YMaxValue = MAXX(Values(Kalender[MonatKey #]),[\"+selectedMeasure.Name+\"])\\n\" +\r\n    \"VAR SparklineTable = ADDCOLUMNS(\\n\" +\r\n    \"    SUMMARIZE('Kalender',Kalender[MonatKey #]),\\n\" +\r\n    \"        \\\"X\\\",INT(150 * DIVIDE(Kalender[MonatKey #] - XMinDate, XMaxDate - XMinDate)),\\n\" +\r\n    \"        \\\"Y\\\",INT(50 * DIVIDE([\"+selectedMeasure.Name+\"] - YMinValue,YMaxValue - YMinValue)))\\n\" +\r\n    \"VAR Lines = CONCATENATEX(SparklineTable,[X] & \\\",\\\" & 50-[Y],\\\" \\\", Kalender[MonatKey #])\\n\" +\r\n    \"VAR LastSparkYValue = MAXX( FILTER(SparklineTable, Kalender[MonatKey #] = XMaxDate), [Y])\\n\" +\r\n    \"VAR LastSparkXValue = MAXX( FILTER(SparklineTable, Kalender[MonatKey #] = XMaxDate), [X])\\n\" +\r\n    \"VAR SVGImageURL = \\n\" +\r\n    \"    \\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' x='0px' y='0px' viewBox='-7 -7 164 64'>\\\" & Defs & \\n\" +\r\n    \"     \\\"<polyline fill='url(#grad)' fill-opacity='0.3' stroke='transparent' stroke-width='0' points=' 0 50 \\\" & Lines & \\n\" +\r\n    \"      \\\" 150 150 Z '/>\\\" &\\n\" +\r\n    \"    \\\"<polyline fill='transparent' stroke='\\\" & LineColour & \\\"' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' points=' \\\" & Lines & \\n\" +\r\n    \"      \\\" '/>\\\" &\\n\" +\r\n    \"    \\\"<circle cx='\\\"& LastSparkXValue & \\\"' cy='\\\" & 50 - LastSparkYValue & \\\"' r='4' stroke='\\\" & LineColour & \\\"' stroke-width='3' fill='\\\" & PointColour & \\\"' />\\\" &\\n\" +\r\n    \"    \\\"</svg>\\\"\\n\" +\r\n    \"RETURN SVGImageURL\";\r\n\r\n    string newExpression11 = \r\n    \"VAR MeasureToUse = [\" + newMeasureName4 + \"]\\n\" +\r\n    \"RETURN\\n\" +\r\n    \"IF (\\n\" +\r\n    \"    MeasureToUse < 0,\\n\" +\r\n    \"    \\\"#FF0000\\\",\\n\" +\r\n    \"    IF (\\n\" +\r\n    \"        MeasureToUse > 0,\\n\" +\r\n    \"        \\\"#92D050\\\"\\n\" +\r\n    \"    )\\n\" +\r\n    \")\";\r\n\r\n    string newExpression12 = \r\n    \"VAR MeasureToUse = [\" + newMeasureName6 + \"]\\n\" +\r\n    \"RETURN\\n\" +\r\n    \"IF (\\n\" +\r\n    \"    MeasureToUse < 0,\\n\" +\r\n    \"    \\\"#FF0000\\\",\\n\" +\r\n    \"    IF (\\n\" +\r\n    \"        MeasureToUse > 0,\\n\" +\r\n    \"        \\\"#92D050\\\"\\n\" +\r\n    \"    )\\n\" +\r\n    \")\";\r\n    \r\n    // Create the new measure in the same table as the selected measure\r\n    var newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\r\n    var newMeasure2 = measuresTable.AddMeasure(newMeasureName2, newExpression2);\r\n    var newMeasure3 = measuresTable.AddMeasure(newMeasureName3, newExpression3);\r\n    var newMeasure4 = measuresTable.AddMeasure(newMeasureName4, newExpression4);\r\n    var newMeasure5 = measuresTable.AddMeasure(newMeasureName5, newExpression5);\r\n    var newMeasure6 = measuresTable.AddMeasure(newMeasureName6, newExpression6);\r\n    var newMeasure7 = measuresTable.AddMeasure(newMeasureName7, newExpression7);\r\n    var newMeasure8 = measuresTable.AddMeasure(newMeasureName8, newExpression8);\r\n    var newMeasure9 = measuresTable.AddMeasure(newMeasureName9, newExpression9);\r\n    var newMeasure10 = measuresTable.AddMeasure(newMeasureName10, newExpression10);\r\n    var newMeasure11 = measuresTable.AddMeasure(newMeasureName11, newExpression11);\r\n    var newMeasure12 = measuresTable.AddMeasure(newMeasureName12, newExpression12);\r\n    \r\n    // Set the display folder for the new measure\r\n    newMeasure1.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure2.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure3.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure4.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure5.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure6.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure7.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure8.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure9.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure10.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure11.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    newMeasure12.DisplayFolder = \"Card \" + selectedMeasure.Name;\r\n    \r\n    newMeasure1.FormatString = selectedMeasure.FormatString;\r\n    newMeasure2.FormatString = selectedMeasure.FormatString;\r\n    newMeasure3.FormatString = selectedMeasure.FormatString;\r\n    newMeasure4.FormatString = selectedMeasure.FormatString;\r\n    newMeasure5.FormatString = selectedMeasure.FormatString;\r\n    newMeasure6.FormatString = selectedMeasure.FormatString;\r\n    newMeasure7.FormatString = selectedMeasure.FormatString;\r\n    newMeasure8.FormatString = selectedMeasure.FormatString;\r\n    newMeasure9.FormatString = selectedMeasure.FormatString;\r\n    newMeasure10.FormatString = selectedMeasure.FormatString;\r\n    newMeasure11.FormatString = selectedMeasure.FormatString;\r\n    newMeasure12.FormatString = selectedMeasure.FormatString;\r\n    \r\n}",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 12,
      "Name": "1. Measure Create\\6. Update Selected Measure",
      "Enabled": "true",
      "Execute": "var updatedMeasures = new List<Measure>();\n\nforeach (var selectedMeasure in Selected.Measures)\n{\n    // Get the selected measure\n    var measuresTable = Model.Tables[\"Measure\"];\n\n    // Retrieve the previous DAX expression of the selected measure\n    var previousExpression = selectedMeasure.Expression;\n\n    // Define the new DAX expression by appending the new condition\n    string newExpression = \"(\"+previousExpression+ \")*( 0.3 + RAND())\";\n\n    // Update the existing measure with the new expression\n    selectedMeasure.Expression = newExpression;\n    updatedMeasures.Add(selectedMeasure);\n}\n\nFormatDax(updatedMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 13,
      "Name": "2. Measure Modify\\1. Format String Unit",
      "Enabled": "true",
      "Execute": "var updatedMeasures = new List<Measure>();\n    \nforeach (var selectedMeasure in Selected.Measures)\n    {\n    // Get the selected measure\n    var measuresTable = Model.Tables[\"Measure\"];\n    var UnitTable = \"Einheit\";\n    var UnitColumn = \"Einheit\";\n    var UnitThousand = \"Tausend\";\n    var UnitMillion = \"Millionen\";\n\n    // Define the dynamic format string expression\n    string dynamicFormatString = \n        \"SWITCH(\" +\n        \"SELECTEDVALUE( \"+UnitTable+\"[\"+UnitColumn+\"] ), \" +\n        \"\\\"\"+UnitThousand+\"\\\", \\\"0,#\\\", \" +\n        \"\\\"\"+UnitMillion+\"\\\", \\\"#,0.#\\\", \" +\n        \"\\\"#,#\\\")\";\n\n    // Update the format string for the selected measure\n    selectedMeasure.FormatStringExpression = dynamicFormatString;\n    updatedMeasures.Add(selectedMeasure);\n    \n}\n\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 14,
      "Name": "2. Measure Modify\\2. Add Last Refresh Measure",
      "Enabled": "true",
      "Execute": "string tableNameEmptyMeasure = \"Measure\";\r\nstring tableNameLastRefresh = \"Last Refresh\";\r\nstring LastRefreshMeasureName = \"Last Refresh Measure\";\r\nstring columnNameLastRefresh = \"Last Refreshes\";\r\nstring measureDax = \"\\\"Last Refresh: \\\" & MAX('\" + tableNameLastRefresh + \"'[\" + columnNameLastRefresh + \"])\";\r\n\r\nvar table2 = Model.Tables[tableNameEmptyMeasure];\r\nvar measurelastrefresh = table2.AddMeasure(LastRefreshMeasureName, measureDax, \"Meta\");\r\n",
      "Tooltip": "",
      "ValidContexts": "Model, Table"
    },
    {
      "Id": 15,
      "Name": "2. Measure Modify\\3. Unit Dynamic FormatStringExpression",
      "Enabled": "true",
      "Execute": "var updatedMeasures = new List<Measure>();\n    \nforeach (var selectedMeasure in Selected.Measures)\n    {\n    // Get the selected measure\n    var measuresTable = Model.Tables[\"Measure\"];\n    var UnitTable = \"Einheit\";\n    var UnitColumn = \"Einheit\";\n    var UnitThousand = \"Tausend\";\n    var UnitMillion = \"Millionen\";\n\n    // Define the dynamic format string expression\n    string dynamicFormatString = \n        \"SWITCH(\" +\n        \"SELECTEDVALUE( \"+UnitTable+\"[\"+UnitColumn+\"] ), \" +\n        \"\\\"\"+UnitThousand+\"\\\", \\\"0,#\\\", \" +\n        \"\\\"\"+UnitMillion+\"\\\", \\\"#,0.#\\\", \" +\n        \"\\\"#,#\\\")\";\n\n    // Update the format string for the selected measure\n    selectedMeasure.FormatStringExpression = dynamicFormatString;\n    updatedMeasures.Add(selectedMeasure);\n    \n}\n\n",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 16,
      "Name": "2. Measure Modify\\4. Format All Measures",
      "Enabled": "true",
      "Execute": "// Formats DAX of all Calculation Items of Calculation Groups\nFormatDax(Model.AllCalculationItems);\n\n// Formats DAX of all Measures\nFormatDax(Model.AllMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);",
      "Tooltip": "",
      "ValidContexts": "Model, Measure"
    },
    {
      "Id": 17,
      "Name": "2. Measure Modify\\5. All columns ending with ID or Key: Set IsAvailableInMDX to False",
      "Enabled": "true",
      "Execute": "\n\n// Set IsAvailableInMDX to false; ***********************************************************\n    foreach (var table in Model.Tables)\n    {\n        foreach (var column in table.Columns)\n        {\n            if (column.Name.EndsWith(\"Key\") || column.Name.EndsWith(\"ID\"))\n            {\n                column.IsAvailableInMDX = false;\n            }\n        }\n    }\n\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 18,
      "Name": "3. Calc Table\\1. Create Calc Calendar Table (TE3)",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\nstring calctableCalendar = Interaction.InputBox(\"Provide the name of the date dimension table\", \"Table Name\", \"CalendarCalcTable\");\n\n\n\n    // Define the DAX expression for the calculated table\n    string tableExpression = @\"\nVAR all_dates = CALENDARAUTO()\nRETURN\n    ADDCOLUMNS(\n        all_dates,\n        \"\"DateKey\"\", VALUE(FORMAT([Date], \"\"YYYYMMDD\"\")),\n        \"\"Year\"\", YEAR([Date]),\n        \"\"Quarter\"\", QUARTER([Date]),\n        \"\"Month\"\", MONTH([Date]),\n        \"\"End of Month\"\", EOMONTH([Date], 0),\n        \"\"Week of Year\"\", WEEKNUM([Date]),\n        \"\"Weekday\"\", WEEKDAY([Date])\n    )\n\";\n\n    // Add the calculated table to the model\n    var table = Model.AddCalculatedTable(calctableCalendar, tableExpression);\n        table.DataCategory = \"Time\";\n\n    // Modify the existing \"Date\" column\n    var dateColumn = table.Columns[\"Date\"];\n    dateColumn.DataType = DataType.DateTime;\n    dateColumn.IsKey = true; // Ensure this is the key column",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 19,
      "Name": "3. Calc Table\\2. Create Empty Measure Table",
      "Enabled": "true",
      "Execute": "// ATTENTION FOR TE2 Users: Script needs modification AND needs to be run in 2 steps\n\n// First Step: Add Table\nvar table = Model.AddCalculatedTable(\"Measure\", \"{0}\"); \n\n// Second Step: JUST FOR TE2 Save Data Model Changes\n\n// Third Step: Hides the column, uncomment the next line and execute it separately\n//var table = Model.Tables[\"Measure\"]; //uncomment this line for TE2\ntable.Columns[0].IsHidden = true;",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 20,
      "Name": "4. Calc Group\\1. Units",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\n// Creates Calculation Group for Units *******************************************************************************\n// only sticked with k and mio because billion is not internationally usable. The German \"Billion\" is not the same as the English \"billion\"\n\nif (!Model.DiscourageImplicitMeasures)\n{\n    // Show message box\n    DialogResult dialogResult14 = MessageBox.Show(\n        text: \"We saw that discourageImplicitMeasures is not yet set to true.\\n\\nIf you proceed this will automaticaly disable implicit measures. Disabling implicit measures is generally recommended. \\n\\nWould you like to proceed?\",\n        caption: \"Discourage Implicit Measures\",\n        buttons: MessageBoxButtons.YesNo);\n\n    // If user clicks Yes, set DiscourageImplicitMeasures to true\n    if (dialogResult14 == DialogResult.No)\n    {\n        return;\n    }\n}\n\n    // Add a new Units Calculation Group \n    try\n    {\n        var calcGroup = Model.AddCalculationGroup();\n        calcGroup.Name = Interaction.InputBox(\"Provide a name of the Units calculation group table and column Name\", \"Units Calc Group Names\", \"Unit\"); \n        calcGroup.Columns[\"Name\"].Name = calcGroup.Name;\n        // Define calculation item data\n        var calculationItemData = new[]\n        {\n    new { Name = \"Thousand\", Expression = string.Format(\"IF(ISNUMBER(SELECTEDMEASURE()),IF(NOT(CONTAINSSTRING(SELECTEDMEASURENAME(), \\\"%\\\") ||CONTAINSSTRING(SELECTEDMEASURENAME(), \\\"ratio\\\")),DIVIDE(SELECTEDMEASURE(), 1000),SELECTEDMEASURE()),SELECTEDMEASURE())\") },\n    new { Name = \"Million\", Expression = string.Format(\"IF(ISNUMBER(SELECTEDMEASURE()),IF(NOT(CONTAINSSTRING(SELECTEDMEASURENAME(), \\\"%\\\") ||CONTAINSSTRING(SELECTEDMEASURENAME(), \\\"ratio\\\")),DIVIDE(SELECTEDMEASURE(), 1000000),SELECTEDMEASURE()),SELECTEDMEASURE())\") }\n}.Where(item => item != null).ToArray();\n\n        // Add calculation items to the Calculation Group\n        foreach (var itemData in calculationItemData)\n        {\n            var item = calcGroup.AddCalculationItem();\n            item.Name = itemData.Name;\n            item.Expression = itemData.Expression;\n        }\n    }\n    catch (Exception ex)\n    {\n        MessageBox.Show(\"Adding the calc group units was not fully successful, but the rest of the script was completed\\n\\nReason: \" + ex.Message);\n    }\n\n\n// Formats the DAX of all calculation items in calc groups. Those are not measures ************************************************************\n    FormatDax(Model.AllCalculationItems);\n\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 21,
      "Name": "4. Calc Group\\2. Time Intelligence",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\nif (!Model.DiscourageImplicitMeasures)\n{\n    // Show message box\n    DialogResult dialogResult14 = MessageBox.Show(\n        text: \"We saw that discourageImplicitMeasures is not yet set to true.\\n\\nIf you proceed this will automaticaly disable implicit measures. Disabling implicit measures is generally recommended. \\n\\nWould you like to proceed?\",\n        caption: \"Discourage Implicit Measures\",\n        buttons: MessageBoxButtons.YesNo);\n\n    // If user clicks Yes, set DiscourageImplicitMeasures to true\n    if (dialogResult14 == DialogResult.No)\n    {\n        return;\n    }\n}\n\n// Find the table with the data category \"Time\"\nvar CalendarTable = Model.Tables.FirstOrDefault(table => table.DataCategory == \"Time\");\n\nif (CalendarTable == null)\n{\n    string tableName = Interaction.InputBox(\"Provide the name of the date dimension table\", \"Table Name\", \"Calendar\");\n    CalendarTable = Model.Tables.FirstOrDefault(table => table.Name == tableName);\n\n    if (CalendarTable.Name == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\n// Checking for Date Column otherwise prompt for user input\nstring DateColumn = null;\n// Check if there is a column in the CalendarTable with IsKey = true\nvar keyColumn = CalendarTable.Columns.FirstOrDefault(col => col.IsKey == true);\nif (keyColumn != null)\n{\n    DateColumn = keyColumn.Name;\n}\nelse\n{\n    // If no key column found, prompt the user for input\n    DateColumn = Interaction.InputBox(\"Provide the name of the date column name\", \"Column Name\", \"Date\");\n}\n\n\n// Creates Calculation Group for Time Intelligence *******************************************************************************\n    var TimeIntelligenceCalculationGroupName = Interaction.InputBox(\"Provide the name of the calculation group name\",\"Time Intelligence Calc Group Name\",\"Time Intelligence\");\n\n    DialogResult dialogResult4 = MessageBox.Show(text:\"Generate YTD Calc Items?\", caption:\"Calc Group: YTD\", buttons:MessageBoxButtons.YesNo);\n    bool GenerateYTD = (dialogResult4 == DialogResult.Yes);            \n\n    // Add a new Time Intellignce Calculation Group **************************************************\n    try\n    {\n        var calcGroup = Model.AddCalculationGroup();\n        calcGroup.Name = TimeIntelligenceCalculationGroupName;\n        calcGroup.Columns[\"Name\"].Name = TimeIntelligenceCalculationGroupName;\n        // Define calculation item data\n        var calculationItemData = new[]\n        {\n        new { Name = \"AC\", Expression = \"SELECTEDMEASURE()\" },\n        new { Name = \"Y-1\", Expression = string.Format(\"CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -1, YEAR), ALL({0}))\", CalendarTable.Name, DateColumn) },\n        new { Name = \"Y-2\", Expression = string.Format(\"CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -2, YEAR), ALL({0}))\", CalendarTable.Name, DateColumn) },\n        new { Name = \"Y-3\", Expression = string.Format(\"CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -3, YEAR), ALL({0}))\", CalendarTable.Name, DateColumn) },\n        GenerateYTD ? new { Name = \"YTD\", Expression = string.Format(\"CALCULATE(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0}))\", CalendarTable.Name, DateColumn) }: null,\n        GenerateYTD ? new { Name = \"YTD-1\", Expression = string.Format(\"CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -1, YEAR), ALL({0}))\", CalendarTable.Name, DateColumn) }: null,\n        GenerateYTD ? new { Name = \"YTD-2\", Expression = string.Format(\"CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -2, YEAR), ALL({0}))\", CalendarTable.Name, DateColumn) }: null,\n        new { Name = \"abs. AC vs Y-1\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y1 = CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -1, YEAR), ALL({0})) RETURN AC - Y1\", CalendarTable.Name, DateColumn) },\n        new { Name = \"abs. AC vs Y-2\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y2 = CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -2, YEAR), ALL({0})) RETURN AC - Y2\", CalendarTable.Name, DateColumn) },\n        GenerateYTD ? new { Name = \"abs. AC vs YTD-1\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y1 = CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -1, YEAR), ALL({0})) RETURN AC - Y1\", CalendarTable.Name, DateColumn) }: null,\n        GenerateYTD ? new { Name = \"abs. AC vs YTD-2\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y2 = CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -2, YEAR), ALL({0})) RETURN AC - Y2\", CalendarTable.Name, DateColumn) }: null,\n        new { Name = \"AC vs Y-1\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y1 = CALCULATE(SELECTEDMEASURE(), SAMEPERIODLASTYEAR({0}[{1}]), ALL({0})) RETURN DIVIDE(AC - Y1, Y1)\", CalendarTable.Name, DateColumn) },\n        new { Name = \"AC vs Y-2\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y2 = CALCULATE(SELECTEDMEASURE(), DATEADD({0}[{1}], -2, YEAR), ALL({0})) RETURN DIVIDE(AC - Y2, Y2)\", CalendarTable.Name, DateColumn) },\n        GenerateYTD ? new { Name = \"AC vs YTD-1\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y1 = CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -1, YEAR), ALL({0})) RETURN DIVIDE(AC - Y1, Y1)\", CalendarTable.Name, DateColumn) }: null,\n        GenerateYTD ? new { Name = \"AC vs YTD-2\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y2 = CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -2, YEAR), ALL({0})) RETURN DIVIDE(AC - Y2, Y2)\", CalendarTable.Name, DateColumn) }: null,\n        new { Name = \"achiev. AC vs Y-1\", Expression = string.Format(\"VAR AC = SELECTEDMEASURE() VAR Y1 = CALCULATE(SELECTEDMEASURE(), SAMEPERIODLASTYEAR({0}[{1}]), ALL({0})) RETURN 1 - ( ( IFERROR( ( Y1 - AC ), 0 ) / Y1 ) )\", CalendarTable.Name, DateColumn) },\n        new { Name = \"achiev. AC vs Y-2\", Expression = string.Format(\"VAR AC = SELECTEDMEASURE() VAR Y2 = CALCULATE(SELECTEDMEASURE(), DATEADD({0}[{1}], -2, YEAR), ALL({0})) RETURN 1 - ( ( IFERROR( ( Y2 - AC ), 0 ) / Y2 ) )\", CalendarTable.Name, DateColumn) },\n        GenerateYTD ? new { Name = \"achiev. AC vs YTD-1\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y1 = CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -1, YEAR), ALL({0})) RETURN 1 - ( ( IFERROR( ( Y1 - AC ), 0 ) / Y1 ) )\", CalendarTable.Name, DateColumn) }: null,\n        GenerateYTD ? new { Name = \"achiev. AC vs YTD-2\", Expression = string.Format(\"VAR AC = TOTALYTD(SELECTEDMEASURE(), DATESYTD({0}[{1}], \\\"12/31\\\"), ALL({0})) VAR Y2 = CALCULATE(SELECTEDMEASURE(), DATEADD(DATESYTD({0}[{1}], \\\"12/31\\\"), -2, YEAR), ALL({0})) RETURN 1 - ( ( IFERROR( ( Y2 - AC ), 0 ) / Y2 ) )\", CalendarTable.Name, DateColumn) }: null\n  \n    }.Where(item => item != null).ToArray();\n        // Add calculation items to the Calculation Group\n        foreach (var itemData in calculationItemData)\n        {\n            var item = calcGroup.AddCalculationItem();\n            item.Name = itemData.Name;\n            item.Expression = itemData.Expression;\n        }\n    }\n    catch (Exception ex)\n    {\n        MessageBox.Show(\"Adding the calc group time intelligence was not fully successful, but the rest of the script was completed\\n\\nReason: \" + ex.Message);\n    }\n\n\n// Formats the DAX of all calculation items in calc groups. Those are not measures ************************************************************\nFormatDax(Model.AllCalculationItems);\n\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 23,
      "Name": "5. Power Query\\2. Create & Replace M Parameter",
      "Enabled": "true",
      "Execute": "// This script creates a new M Parameter as a 'Shared Expression'.\n// It will also find the default value in all M partitions and replace them with the parameter object name.\n//#r \"System.Drawing\"\n\nusing System.Drawing;\nusing System.Text.RegularExpressions;\nusing System.Windows.Forms;\n\n// Hide the 'Running Macro' spinbox\nScriptHelper.WaitFormVisible = false;\n\n// Initialize variables\nstring _ParameterName = \"New Parameter\";\nstring _ParameterValue = \"ParameterValue\";\n\n// WinForms prompt to get Parameter Name / Value input\nusing (Form prompt = new Form())\n{\n    Font formFont = new Font(\"Segoe UI\", 11); \n\n    // Prompt config\n    prompt.AutoSize = true;\n    prompt.MinimumSize = new Size(380, 120);\n    prompt.Text = \"Create New M Parameter\";\n    prompt.StartPosition = FormStartPosition.CenterScreen;\n\n    // Find: label\n    Label parameterNameLabel = new Label() { Text = \"Enter Name:\" };\n    parameterNameLabel.Location = new Point(20, 20);\n    parameterNameLabel.AutoSize = true;\n    parameterNameLabel.Font = formFont;\n\n    // Textbox for inputing the substring text\n    TextBox parameterNameBox = new TextBox();\n    parameterNameBox.Width = 200;\n    parameterNameBox.Location = new Point(parameterNameLabel.Location.X + parameterNameLabel.Width + 20, parameterNameLabel.Location.Y - 4);\n    parameterNameBox.SelectedText = \"New Parameter\";\n    parameterNameBox.Font = formFont;\n\n    // Replace: label\n    Label parameterValueLabel = new Label() { Text = \"Enter Value:\" };\n    parameterValueLabel.Location = new Point(parameterNameLabel.Location.X, parameterNameLabel.Location.Y + parameterNameLabel.Height + 20);\n    parameterValueLabel.AutoSize = true;\n    parameterValueLabel.Font = formFont;\n\n    // Textbox for inputting the substring text\n    TextBox parameterValueBox = new TextBox() { Left = parameterValueLabel.Right + 20, Top = parameterValueLabel.Location.Y - 4, Width = parameterNameBox.Width };\n    parameterValueBox.SelectedText = \"Parameter Value\";\n    parameterValueBox.Font = formFont;\n\n    // OK Button\n    Button okButton = new Button() { Text = \"Create\", Left = 20, Width = 75, Top = parameterValueBox.Location.Y + parameterValueBox.Height + 20 };\n    okButton.MinimumSize = new Size(75, 25);\n    okButton.AutoSize = true;\n    okButton.Font = formFont;\n\n    // Cancel Button\n    Button cancelButton = new Button() { Text = \"Cancel\", Left = okButton.Location.X + okButton.Width + 10, Top = okButton.Location.Y };\n    cancelButton.MinimumSize = new Size(75, 25);\n    cancelButton.AutoSize = true;\n    cancelButton.Font = formFont;\n\n    // Button actions\n    okButton.Click += (sender, e) => { _ParameterName = parameterNameBox.Text; _ParameterValue = parameterValueBox.Text; prompt.DialogResult = DialogResult.OK; };\n    cancelButton.Click += (sender, e) => { prompt.DialogResult = DialogResult.Cancel; };\n\n    prompt.AcceptButton = okButton;\n    prompt.CancelButton = cancelButton;\n\n    prompt.Controls.Add(parameterNameLabel);\n    prompt.Controls.Add(parameterNameBox);\n    prompt.Controls.Add(parameterValueLabel);\n    prompt.Controls.Add(parameterValueBox);\n    prompt.Controls.Add(okButton);\n    prompt.Controls.Add(cancelButton);\n\n    // The user clicked OK, so perform the find-and-replace logic\n    if (prompt.ShowDialog() == DialogResult.OK)\n    {\n\n        // Creates the parameter\n        Model.AddExpression( \n            _ParameterName, \n            @\"\n        \"\"\" + _ParameterValue +\n        @\"\"\" meta\n        [\n            IsParameterQuery = true,\n            IsParameterQueryRequired = true,\n            Type = type text\n        ]\"\n        );\n        \n        \n        // Informs the user that the parameter was successfully created\n        Info ( \n            \"Successfully created a new parameter: \" + @\"\"\"\" +\n            _ParameterName + @\"\"\"\" +\n            \"\\nDefault value: \" + @\"\"\"\" +\n            _ParameterValue + @\"\"\"\");\n        \n        \n        // Finds the parameter default value in M Partitions & replaces with the parameter name\n        string _Find = @\"\"\"\" + _ParameterValue + @\"\"\"\";\n        string _Replace = @\"#\"\"\" + _ParameterName + @\"\"\"\";\n        \n        int _NrMPartitions = 0;\n        int _NrReplacements = 0;\n        var _ReplacementsList = new List<string>();\n        \n        foreach ( var _Tables in Model.Tables )\n        {\n            foreach ( var _p in _Tables.Partitions )\n            {\n                if ( _p.SourceType == PartitionSourceType.M )\n                {\n                    if ( _p.Expression != _p.Expression.Replace( _Find, _Replace ) )\n                    {\n                        _p.Expression = _p.Expression.Replace( _Find, _Replace );\n        \n                        // Tracks which M partitions were replaced (and how many)\n                        _NrReplacements = _NrReplacements + 1;\n                        _ReplacementsList.Add( _p.Name );\n                    }\n        \n                // Counts the total # M Partitions\n                _NrMPartitions = _NrMPartitions + 1;\n                }\n            }\n        }\n        \n        \n        // Makes a bulleted list of all the M partitions that were replaced\n        string _ReplacedPartitions = \" • \" + String.Join(\"\\n • \", _ReplacementsList );\n        \n        \n        // Informs \n        //      - Whether the Find & Replace was successful\n        //      - How many M partitions were replaced\n        //      - Which M partitions had the Find & Replace done\n        Info (\n            \"Successfully replaced\\n\\n \" +\n            _Find + \n            \"\\n\\n with: \\n\\n\" + \n            _Replace + \n            \"\\n\\n in \" + \n            Convert.ToString(_NrReplacements) +\n            \" of \" +\n            Convert.ToString(_NrMPartitions) +  \n            \" M Partitions:\\n\" +\n            _ReplacedPartitions\n        );\n\n    }\n    else\n    {\n    Error ( \"Cancelled input! Ended script without changes.\");\n    }\n}\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 24,
      "Name": "6. Other\\1. Load BPA",
      "Enabled": "true",
      "Execute": "System.Net.WebClient w = new System.Net.WebClient(); \r\n\r\nstring path = System.Environment.GetFolderPath(System.Environment.SpecialFolder.LocalApplicationData);\r\nstring url = \"https://raw.githubusercontent.com/microsoft/Analysis-Services/master/BestPracticeRules/BPARules.json\";\r\nstring downloadLoc = path+@\"\\TabularEditor\\BPARules.json\";\r\nw.DownloadFile(url, downloadLoc);",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 25,
      "Name": "6. Other\\2. Check Discourage Implicit Measures",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\nif (!Model.DiscourageImplicitMeasures)\n{\n    // Show message box\n    DialogResult dialogResult14 = MessageBox.Show(\n        text: \"Set DiscourageImplicitMeasures to true?\\n\\nThis is in general recommended and needed for calculation groups.\",\n        caption: \"Discourage Implicit Measures\",\n        buttons: MessageBoxButtons.YesNo);\n\n    // If user clicks Yes, set DiscourageImplicitMeasures to true\n    if (dialogResult14 == DialogResult.Yes)\n    {\n        Model.DiscourageImplicitMeasures = true;\n    }\n}\nelse\n{\n    // Show message box indicating it is already set to true\n    MessageBox.Show(\n        text: \"DiscourageImplicitMeasures is already set to true.\",\n        caption: \"Discourage Implicit Measures\",\n        buttons: MessageBoxButtons.OK,\n        icon: MessageBoxIcon.Information);\n}",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
	{
      "Id": 27,
      "Name": "6. Other\\4. Backup All MacroAction.json Files to Desktop",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.IO;\nusing System.Windows.Forms;\n\n// Get the path to Local AppData and Desktop directories\nstring localAppDataPath = System.Environment.GetFolderPath(System.Environment.SpecialFolder.LocalApplicationData);\nstring desktopPath = System.Environment.GetFolderPath(System.Environment.SpecialFolder.Desktop);\n\n// Get the current timestamp for the backup file name\nstring timestamp = DateTime.Now.ToString(\"yyyyMMddHHmmss\");\n\n// Show a message box to ask the user for confirmation\nDialogResult result = MessageBox.Show(\"Do you want to backup the MacroActions.json files?\", \"Backup Confirmation\", MessageBoxButtons.YesNo, MessageBoxIcon.Question);\n\n// If the user confirms, proceed with the backup\nif (result == DialogResult.Yes)\n{\n    // Look for folders containing \"TabularEditor\" in LocalAppData\n    string[] folders = Directory.GetDirectories(localAppDataPath, \"*TabularEditor*\", SearchOption.TopDirectoryOnly);\n\n    int filesCopied = 0; // Counter to track how many files are copied\n\n    foreach (string folder in folders)\n    {\n        // Check if MacroActions.json exists in the folder\n        string macroActionsPath = Path.Combine(folder, \"MacroActions.json\");\n        if (File.Exists(macroActionsPath))\n        {\n            // Create a new file name with folder name and timestamp\n            string folderName = new DirectoryInfo(folder).Name;\n            string newFileName = folderName + \"_MacroActionsBackup_\" + timestamp + \".json\";\n            string newFilePath = Path.Combine(desktopPath, newFileName);\n\n            // Copy the file to the desktop with the new name\n            File.Copy(macroActionsPath, newFilePath, true);\n\n            // Count the number of successful copies\n            filesCopied++;\n        }\n    }\n\n    // Show a message box with the result of the operation\n    if (filesCopied > 0)\n    {\n        Interaction.MsgBox(filesCopied+\"MacroActions.json file(s) backed up successfully!\", MsgBoxStyle.Information, \"Backup Completed\");\n    }\n    else\n    {\n        Interaction.MsgBox(\"No MacroActions.json files found to back up.\", MsgBoxStyle.Exclamation, \"Backup Completed\");\n    }\n}\nelse\n{\n    Interaction.MsgBox(\"Backup canceled.\", MsgBoxStyle.Information, \"Operation Canceled\");\n}\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 28,
      "Name": "Archive\\1.2 Measure: Y-1 Simple With fixed Variable",
      "Enabled": "true",
      "Execute": "var newMeasures = new List<Measure>();\n    \nforeach (var selectedMeasure in Selected.Measures)\n    {\n    // Get the selected measure\n    var measuresTable = Model.Tables[\"Measure\"];\n    var Kalendartable = \"Datum\";\n    var DateColumn = \"Datum\";\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" PY\";\n    \n    string newExpression1 = \n        \"CALCULATE(\" +\n        \"[\"+selectedMeasure.Name+\"]\" + \", \" \n        +\"SAMEPERIODLASTYEAR(\"+Kalendartable+\"[\"+DateColumn+\"]))\";\n\n    // Create the new measure in the same table as the selected measure\n    var newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n\n    // Set the display folder for the new measure\n    //newMeasure1.DisplayFolder = \"Just Created \" + selectedMeasure.Name;\n    \n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasures.Add(newMeasure1);\n    \n}\n\nFormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 29,
      "Name": "Archive\\1.2 Measure: Δ Y-1 Simple  With fixed Variable",
      "Enabled": "true",
      "Execute": "var newMeasures = new List<Measure>();\n    \nforeach (var selectedMeasure in Selected.Measures)\n    {\n    // Get the selected measure\n    var measuresTable = Model.Tables[\"Measure\"];\n    var Kalendartable = \"Datum\";\n    var DateColumn = \"Datum\";\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" Δ PY\";\n    \n    string newExpression1 = \n        \"[\"+selectedMeasure.Name+\"] - \" + \"[\"+selectedMeasure.Name+\" PY]\";\n\n    // Create the new measure in the same table as the selected measure\n    var newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n\n    // Set the display folder for the new measure\n    //newMeasure1.DisplayFolder = \"Just Created \" + selectedMeasure.Name;\n    \n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasures.Add(newMeasure1);\n    \n}\n\nFormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 30,
      "Name": "Archive\\1.2 Measure: Δ Y-1% Simple  With fixed Variable",
      "Enabled": "true",
      "Execute": "var newMeasures = new List<Measure>();\n    \nforeach (var selectedMeasure in Selected.Measures)\n    {\n    // Get the selected measure\n    var measuresTable = Model.Tables[\"Measure\"];\n    var Kalendartable = \"Datum\";\n    var DateColumn = \"Datum\";\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" Δ PY %\";\n    \n    string newExpression1 = \n        \"DIVIDE([\"+selectedMeasure.Name+\"] - \" + \"[\"+selectedMeasure.Name+\" PY], [\"+selectedMeasure.Name+\"])\";\n\n    // Create the new measure in the same table as the selected measure\n    var newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n\n    // Set the display folder for the new measure\n    //newMeasure1.DisplayFolder = \"Just Created \" + selectedMeasure.Name;\n    \n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasures.Add(newMeasure1);\n    \n}\n\nFormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 31,
      "Name": "Archive\\1.1 Measure: Selected SUM Simple in Measure Table",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\n// Ask the user if they want to add the new measure to the current table\nDialogResult dialogResult = MessageBox.Show(\"Do you want to add the new measure to the current table? (Click 'No' to add it to a custom table)\", \"Select Target Table\", MessageBoxButtons.YesNo);\n\nstring measuresTableName = Selected.Columns.First().Table.Name;\nif (dialogResult == DialogResult.No)\n{\n    // Ask for the name of the measure table if the user selects \"No\"\n    measuresTableName = Interaction.InputBox(\"Provide the name of the measure table\", \"Name of Measure Table\", \"Measure\");\n\n    // Check if the provided table exists\n    if (Model.Tables.FirstOrDefault(table => table.Name == measuresTableName) == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\n// Create a SUM measure for every currently selected column and hide the column\nforeach(var c in Selected.Columns)\n{\n    // Use the target table determined by user selection or default \"Measure\" table\n    var measuresTable = Model.Tables[measuresTableName];\n    var newMeasure = measuresTable.AddMeasure(\n        /*\"Sum_\" +*/ c.Name,                            // Name\n        \"SUM(\" + c.DaxObjectFullName + \")\",         // DAX expression\n        c.Table.Name                                // Display Folder\n    );\n    \n    // Set the format string on the new measure:\n    newMeasure.FormatString = \"0.0\";\n\n    // Provide some documentation:\n    newMeasure.Description = \"This measure is the sum of column \" + c.DaxObjectFullName;\n\n    // Hide the base column:\n    c.IsHidden = true;\n}\n",
      "Tooltip": "This adds for selected Tables all explicit sum measures",
      "ValidContexts": "Measure"
    },
    {
      "Id": 32,
      "Name": "Archive\\1.1 Measure: Selected SUM Simple in Current Table",
      "Enabled": "true",
      "Execute": "// Creates a SUM measure for every currently selected column and hide the column.\nforeach(var c in Selected.Columns)\n{\n    var newMeasure = c.Table.AddMeasure(\n        \"NameToReplace\" + c.Name,                    // Name\n        \"SUM(\" + c.DaxObjectFullName + \")\",    // DAX expression\n        \"ENTERHERE_DisplayFolderName\"                        // Display Folder\n    );\n    \n    // Set the format string on the new measure:\n    newMeasure.FormatString = \"0.0\";\n\n    // Provide some documentation:\n    newMeasure.Description = \"This measure is the sum of column \" + c.DaxObjectFullName;\n\n    // Hide the base column:\n    c.IsHidden = true;\n}",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 33,
      "Name": "Archive\\1.2 Measure: All Y-1 Simple with fixed Variable",
      "Enabled": "true",
      "Execute": "var newMeasures = new List<Measure>();\n    \nforeach (var selectedMeasure in Selected.Measures)\n    {\n    // Get the selected measure\n    var measuresTable = Model.Tables[\"Measure\"];\n    var Kalendartable = \"Datum\";\n    var DateColumn = \"Datum\";\n\n    // Define the new measure name and expression\n    string newMeasureName1 = selectedMeasure.Name + \" PY\";\n    string newMeasureName2 = selectedMeasure.Name + \" Δ PY\";\n    string newMeasureName3 = selectedMeasure.Name + \" Δ PY %\";\n    \n    string newExpression1 = \n        \"CALCULATE(\" +\n        \"[\"+selectedMeasure.Name+\"]\" + \", \" \n        +\"SAMEPERIODLASTYEAR(\"+Kalendartable+\"[\"+DateColumn+\"]))\";\n    string newExpression2 = \n        \"[\"+selectedMeasure.Name+\"] - \" + \"[\"+selectedMeasure.Name+\" PY]\";\n    string newExpression3 = \n        \"DIVIDE([\"+selectedMeasure.Name+\"] - \" + \"[\"+selectedMeasure.Name+\" PY], [\"+selectedMeasure.Name+\"])\";\n\n\n    // Create the new measure in the same table as the selected measure\n    var newMeasure1 = measuresTable.AddMeasure(newMeasureName1, newExpression1);\n    var newMeasure2 = measuresTable.AddMeasure(newMeasureName2, newExpression2);\n    var newMeasure3 = measuresTable.AddMeasure(newMeasureName3, newExpression3);\n    \n    // Set the display folder for the new measure\n    //newMeasure1.DisplayFolder = \"Just Created \" + selectedMeasure.Name;\n    \n    newMeasure1.FormatString = selectedMeasure.FormatString;\n    newMeasures.Add(newMeasure1);\n    newMeasures.Add(newMeasure2);\n    newMeasures.Add(newMeasure3);\n}\n\nFormatDax(newMeasures, shortFormat: true, skipSpaceAfterFunctionName: true);",
      "Tooltip": "",
      "ValidContexts": "Measure"
    },
    {
      "Id": 34,
      "Name": "3. Calc Table\\1. Create Calc Calendar Table (TE2)\\2. Mark as Date Table",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\n// Find the table with the data category \"Time\"\nvar CalendarTable = Model.Tables.FirstOrDefault(table => table.DataCategory == \"Time\");\n\nif (CalendarTable == null)\n{\n    string tableName = Interaction.InputBox(\"Provide the name of the date dimension table\", \"Table Name\", \"Calendar\");\n    CalendarTable = Model.Tables.FirstOrDefault(table => table.Name == tableName);\n\n    if (CalendarTable == null)\n    {\n        MessageBox.Show(\"The table you provided does not exist in the model.\");\n        return;\n    }\n}\n\n// Check if a column named \"Date\" exists in the CalendarTable\nstring dateColumnName = \"Date\";\nvar dateColumn = CalendarTable.Columns.FirstOrDefault(col => col.Name == dateColumnName);\n\nif (dateColumn == null)\n{\n    // If no \"Date\" column is found, prompt the user for input\n    dateColumnName = Interaction.InputBox(\"The 'Date' column was not found. Provide the name of the date column.\", \"Column Name\", \"Date\");\n    dateColumn = CalendarTable.Columns.FirstOrDefault(col => col.Name == dateColumnName);\n\n    if (dateColumn == null)\n    {\n        MessageBox.Show(\"The column you provided does not exist in the model.\");\n        return;\n    }\n}\n\n// Modify the found column (or user-provided column)\ndateColumn.DataType = DataType.DateTime;\ndateColumn.IsKey = true; // Ensure this is the key column\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 35,
      "Name": "3. Calc Table\\1. Create Calc Calendar Table (TE2)\\1. Create Table",
      "Enabled": "true",
      "Execute": "#r \"Microsoft.VisualBasic\"\nusing Microsoft.VisualBasic;\nusing System.Windows.Forms;\n\nstring calctableCalendar = Interaction.InputBox(\"Provide the name of the date dimension table\", \"Table Name\", \"CalendarCalcTable\");\n\n\n\n    // Define the DAX expression for the calculated table\n    string tableExpression = @\"\nVAR all_dates = CALENDARAUTO()\nRETURN\n    ADDCOLUMNS(\n        all_dates,\n        \"\"DateKey\"\", VALUE(FORMAT([Date], \"\"YYYYMMDD\"\")),\n        \"\"Year\"\", YEAR([Date]),\n        \"\"Quarter\"\", QUARTER([Date]),\n        \"\"Month\"\", MONTH([Date]),\n        \"\"End of Month\"\", EOMONTH([Date], 0),\n        \"\"Week of Year\"\", WEEKNUM([Date]),\n        \"\"Weekday\"\", WEEKDAY([Date])\n    )\n\";\n\n    // Add the calculated table to the model\n    var table = Model.AddCalculatedTable(calctableCalendar, tableExpression);\n        table.DataCategory = \"Time\";\n\n",
      "Tooltip": "",
      "ValidContexts": "Model"
    },
    {
      "Id": 36,
      "Name": "7. Official TE Library\\Create Field Parameters with Selected Columns\\Measures",
      "Enabled": "true",
      "Execute": "// Before running the script, select the measures or columns that you\n// would like to use as field parameters (hold down CTRL to select multiple\n// objects). Also, you may change the name of the field parameter table\n// below. NOTE: If used against Power BI Desktop, you must enable unsupported\n// features under File > Preferences (TE2) or Tools > Preferences (TE3).\nvar name = \"Parameter\";\n\nif(Selected.Columns.Count == 0 && Selected.Measures.Count == 0) throw new Exception(\"No columns or measures selected!\");\n\n// Construct the DAX for the calculated table based on the current selection:\nvar objects = Selected.Columns.Any() ? Selected.Columns.Cast<ITabularTableObject>() : Selected.Measures;\nvar dax = \"{\\n    \" + string.Join(\",\\n    \", objects.Select((c,i) => string.Format(\"(\\\"{0}\\\", NAMEOF('{1}'[{0}]), {2})\", c.Name, c.Table.Name, i))) + \"\\n}\";\n\n// Add the calculated table to the model:\nvar table = Model.AddCalculatedTable(name, dax);\n\n// In TE2 columns are not created automatically from a DAX expression, so \n// we will have to add them manually:\nvar te2 = table.Columns.Count == 0;\nvar nameColumn = te2 ? table.AddCalculatedTableColumn(name, \"[Value1]\") : table.Columns[\"Value1\"] as CalculatedTableColumn;\nvar fieldColumn = te2 ? table.AddCalculatedTableColumn(name + \" Fields\", \"[Value2]\") : table.Columns[\"Value2\"] as CalculatedTableColumn;\nvar orderColumn = te2 ? table.AddCalculatedTableColumn(name + \" Order\", \"[Value3]\") : table.Columns[\"Value3\"] as CalculatedTableColumn;\n\nif(!te2) {\n    // Rename the columns that were added automatically in TE3:\n    nameColumn.IsNameInferred = false;\n    nameColumn.Name = name;\n    fieldColumn.IsNameInferred = false;\n    fieldColumn.Name = name + \" Fields\";\n    orderColumn.IsNameInferred = false;\n    orderColumn.Name = name + \" Order\";\n}\n// Set remaining properties for field parameters to work\n// See: https://twitter.com/markbdi/status/1526558841172893696\nnameColumn.SortByColumn = orderColumn;\nnameColumn.GroupByColumns.Add(fieldColumn);\nfieldColumn.SortByColumn = orderColumn;\nfieldColumn.SetExtendedProperty(\"ParameterMetadata\", \"{\\\"version\\\":3,\\\"kind\\\":2}\", ExtendedPropertyType.Json);\nfieldColumn.IsHidden = true;\norderColumn.IsHidden = true;\n",
      "Tooltip": "",
      "ValidContexts": "Column"
    },
    {
      "Id": 37,
      "Name": "7. Official TE Library\\Count Rows in Table",
      "Enabled": "true",
      "Execute": "// This script counts rows in a selected table and displays the result in a pop-up info box.\n// It does not write any changes to this model.\n//\n// Use this script when you want to check whether a table was loaded or how many rows it has.\n//\n// Get table name\nstring _TableName = \n    Selected.Table.DaxObjectFullName;\n\n// Count table rows\nstring _dax = \n    \"{ FORMAT( COUNTROWS (\" + _TableName + \"), \\\"#,##0\\\" ) }\";\n\n// Evaluate DAX\nstring _TableRows = \n    Convert.ToString(EvaluateDax( _dax ));\n\n// Return output in pop-up\nInfo ( \"Number of rows in \" + _TableName + \": \" + _TableRows);\n",
      "Tooltip": "If you want to see how many rows are loaded to a table, or quickly check if the table has been loaded, at all. This script requires connection to a remote model or connection via Workspace Mode.",
      "ValidContexts": "Table"
    },
    {
      "Id": 38,
      "Name": "7. Official TE Library\\Edit Hidden Partitions",
      "Enabled": "true",
      "Execute": "Selected.Table.Partitions[0].Output();\n",
      "Tooltip": "Calculated Tables, Calculation Groups and Field Parameters do not have partitions displayed in Tabular Editor. This is on purpose as these should/can not generally be edited. The partition's properties can however still be accessed and edited with bellow script snippet.",
      "ValidContexts": "Table"
    },
    {
      "Id": 39,
      "Name": "7. Official TE Library\\Create M Parameter",
      "Enabled": "true",
      "Execute": "// This script creates a new M parameter in the 'Shared Expressions' of a model.\n//\n// Create a new shared expression called \"New Parameter\"\nModel.AddExpression( \n    \"New Parameter\", \n    @\"\n\"\"Parameter Text\"\" meta\n[\n\tIsParameterQuery = true,\n\tIsParameterQueryRequired = true,\n\tType = type text\n]\"\n);\n\n// Provides an output informing how to configure and use the parameter\nInfo ( \n    \"Created a new Shared Expression called 'New Parameter', which is an M Parameter template.\" + \n    \"\\n------------------------------------------------------\\n\" + \n    \"To configure:\" +\n    \"\\n------------------------------------------------------\\n    \" + \n    \"1. Replace the text 'New Parameter' with the desired parameter value\\n    \" +\n    \"2. Set the data type appropriately\\n    \" +\n    \"3. Replace any values found in the M partitions with the parameter reference.\" );\n",
      "Tooltip": "If you want to create a new dynamic M Parameter to use in Power Query queries (M Partitions or Shared Expressions).",
      "ValidContexts": "Model"
    },
    {
      "Id": 40,
      "Name": "7. Official TE Library\\Format Numeric Measures",
      "Enabled": "true",
      "Execute": "// This script is meant to format all measures with a default formatstring\nforeach (var ms in Selected.Measures) {\n//Don't set format string on hidden measures\n\tif (ms.IsHidden) continue;\n// If the format string is empty continue. \n\tif (!string.IsNullOrWhiteSpace(ms.FormatString)) continue;\n//If the data type is int set a whole number format string\n\tif (ms.DataType == DataType.Int64) ms.FormatString = \"#,##0\";\n//If the datatype is double or decimal \n\tif (ms.DataType == DataType.Double || ms.DataType == DataType.Decimal) {\n    //and the name contains # or QTY then set the format string to a whole number\n\t\tif (ms.Name.Contains(\"#\")\n\t\t\t|| ms.Name.IndexOf(\"QTY\", StringComparison.OrdinalIgnoreCase) >= 0) ms.FormatString = \"#,##0\";\n\t\t//otherwise set it a decimal format string. \n    else ms.FormatString = \"#,##0.00\";\n\t}\n}\n",
      "Tooltip": "Allows you to quickly set default format strings on the measures selected.",
      "ValidContexts": "Measure"
    },
    {
      "Id": 42,
      "Name": "7. Official TE Library\\Distinct Column Values",
      "Enabled": "true",
      "Execute": "// Construct the DAX expression to get all distinct column values, from the selected column:\nvar dax = string.Format(\"ALL({0})\", Selected.Column.DaxObjectFullName);\n\n// Evaluate the DAX expression against the connected model:\nvar result = EvaluateDax(dax);\n\n// Output the DataTable containing the result of the DAX expression:\nOutput(result);\n",
      "Tooltip": "Display the distinct values in a column for quick data profiling and access. Save as a Macro on the column level to have it quickly available.",
      "ValidContexts": "Column"
    },

    {
      "Id": 44,
      "Name": "7. Official TE Library\\Calculated Table: Calendar",
      "Enabled": "true",
      "Execute": "// To use this C# Script:\n//\n// 1. Run the script\n// 2. Select the column that has the earliest date\n// 3. Select the column that has the latest date\n\n// List of all DateTime columns in the model\nvar _dateColumns = Model.AllColumns.Where(c => c.DataType == DataType.DateTime ).ToList();\n\n// Select the column with the earliest date in the model\ntry\n{\n    string _EarliestDate = \n        SelectColumn(\n            _dateColumns, \n            null, \n            \"Select the Column with the Earliest Date:\"\n        ).DaxObjectFullName;\n    \n    try\n    {\n        // Select the column with the latest date in the model\n        string _LatestDate = \n            SelectColumn(\n                _dateColumns, \n                null, \n                \"Select the Column with the Latest Date:\"\n            ).DaxObjectFullName;\n        \n        \n        // Create measure for reference date\n        var _RefDateMeasure = _dateColumns[0].Table.AddMeasure(\n            \"RefDate\",\n            \"CALCULATE ( MAX ( \" + _LatestDate + \" ), REMOVEFILTERS ( ) )\"\n        );\n        \n        \n        // Formatted date table DAX\n        // Based on date table from https://www.sqlbi.com/topics/date-table/\n        // To adjust, copy everything after the @\" into a DAX query window & replace\n        \n        var _DateDaxExpression = @\"-- Reference date for the latest date in the report\n        -- Until when the business wants to see data in reports\n        VAR _Refdate_Measure = [RefDate]\n        VAR _Today = TODAY ( )\n        \n        -- Replace with \"\"Today\"\" if [RefDate] evaluates blank\n        VAR _Refdate = IF ( ISBLANK ( _Refdate_Measure ), _Today, _Refdate_Measure )\n            VAR _RefYear        = YEAR ( _Refdate )\n            VAR _RefQuarter     = _RefYear * 100 + QUARTER(_Refdate)\n            VAR _RefMonth       = _RefYear * 100 + MONTH(_Refdate)\n            VAR _RefWeek_EU     = _RefYear * 100 + WEEKNUM(_Refdate, 2)\n        \n        -- Earliest date in the model scope\n        VAR _EarliestDate       = DATE ( YEAR ( MIN ( \" + _EarliestDate + @\" ) ) - 2, 1, 1 )\n        VAR _EarliestDate_Safe  = MIN ( _EarliestDate, DATE ( YEAR ( _Today ) + 1, 1, 1 ) )\n        \n        -- Latest date in the model scope\n        VAR _LatestDate_Safe    = DATE ( YEAR ( _Refdate ) + 2, 12, 1 )\n        \n        ------------------------------------------\n        -- Base calendar table\n        VAR _Base_Calendar      = CALENDAR ( _EarliestDate_Safe, _LatestDate_Safe )\n        ------------------------------------------\n        \n        \n        \n        ------------------------------------------\n        VAR _IntermediateResult = \n            ADDCOLUMNS ( _Base_Calendar,\n        \n                    ------------------------------------------\n                \"\"Calendar Year Number (ie 2021)\"\",           --|\n                    YEAR ([Date]),                          --|-- Year\n                                                            --|\n                \"\"Calendar Year (ie 2021)\"\",                  --|\n                    FORMAT ([Date], \"\"YYYY\"\"),                --|\n                    ------------------------------------------\n        \n                    ------------------------------------------\n                \"\"Calendar Quarter Year (ie Q1 2021)\"\",       --|\n                    \"\"Q\"\" &                                   --|-- Quarter\n                    CONVERT(QUARTER([Date]), STRING) &      --|\n                    \"\" \"\" &                                   --|\n                    CONVERT(YEAR([Date]), STRING),          --|\n                                                            --|\n                \"\"Calendar Year Quarter (ie 202101)\"\",        --|\n                    YEAR([Date]) * 100 + QUARTER([Date]),   --|\n                    ------------------------------------------\n        \n                    ------------------------------------------\n                \"\"Calendar Month Year (ie Jan 21)\"\",          --|\n                    FORMAT ( [Date], \"\"MMM YY\"\" ),            --|-- Month\n                                                            --|\n                \"\"Calendar Year Month (ie 202101)\"\",          --|\n                    YEAR([Date]) * 100 + MONTH([Date]),     --|\n                                                            --|\n                \"\"Calendar Month (ie Jan)\"\",                  --|\n                    FORMAT ( [Date], \"\"MMM\"\" ),               --|\n                                                            --|\n                \"\"Calendar Month # (ie 1)\"\",                  --|\n                    MONTH ( [Date] ),                       --|\n                    ------------------------------------------\n                    \n                    ------------------------------------------\n                \"\"Calendar Week EU (ie WK25)\"\",               --|\n                    \"\"WK\"\" & WEEKNUM( [Date], 2 ),            --|-- Week\n                                                            --|\n                \"\"Calendar Week Number EU (ie 25)\"\",          --|\n                    WEEKNUM( [Date], 2 ),                   --|\n                                                            --|\n                \"\"Calendar Year Week Number EU (ie 202125)\"\", --|\n                    YEAR ( [Date] ) * 100                   --|\n                    +                                       --|\n                    WEEKNUM( [Date], 2 ),                   --|\n                                                            --|\n                \"\"Calendar Week US (ie WK25)\"\",               --|\n                    \"\"WK\"\" & WEEKNUM( [Date], 1 ),            --|\n                                                            --|\n                \"\"Calendar Week Number US (ie 25)\"\",          --|\n                    WEEKNUM( [Date], 1 ),                   --|\n                                                            --|\n                \"\"Calendar Year Week Number US (ie 202125)\"\", --|\n                    YEAR ( [Date] ) * 100                   --|\n                    +                                       --|\n                    WEEKNUM( [Date], 1 ),                   --|\n                                                            --|\n                \"\"Calendar Week ISO (ie WK25)\"\",              --|\n                    \"\"WK\"\" & WEEKNUM( [Date], 21 ),           --|\n                                                            --|\n                \"\"Calendar Week Number ISO (ie 25)\"\",         --|\n                    WEEKNUM( [Date], 21 ),                  --|\n                                                            --|\n                \"\"Calendar Year Week Number ISO (ie 202125)\"\",--|\n                    YEAR ( [Date] ) * 100                   --|\n                    +                                       --|\n                    WEEKNUM( [Date], 21 ),                  --|\n                    ------------------------------------------\n        \n                    ------------------------------------------\n                \"\"Weekday Short (i.e. Mon)\"\",                 --|\n                    FORMAT ( [Date], \"\"DDD\"\" ),               --|-- Weekday\n                                                            --|\n                \"\"Weekday Name (i.e. Monday)\"\",               --|\n                    FORMAT ( [Date], \"\"DDDD\"\" ),              --|\n                                                            --|\n                \"\"Weekday Number EU (i.e. 1)\"\",               --|\n                    WEEKDAY ( [Date], 2 ),                  --|\n                    ------------------------------------------\n                    \n                    ------------------------------------------\n                \"\"Calendar Month Day (i.e. Jan 05)\"\",         --|\n                    FORMAT ( [Date], \"\"MMM DD\"\" ),            --|-- Day\n                                                            --|\n                \"\"Calendar Month Day (i.e. 0105)\"\",           --|\n                    MONTH([Date]) * 100                     --|\n                    +                                       --|\n                    DAY([Date]),                            --|\n                                                            --|\n                \"\"YYYYMMDD\"\",                                 --|\n                    YEAR ( [Date] ) * 10000                 --|\n                    +                                       --|\n                    MONTH ( [Date] ) * 100                  --|\n                    +                                       --|\n                    DAY ( [Date] ),                         --|\n                    ------------------------------------------\n        \n        \n                    ------------------------------------------\n                \"\"IsDateInScope\"\",                            --|\n                    [Date] <= _Refdate                      --|-- Boolean\n                    &&                                      --|\n                    YEAR([Date]) > YEAR(_EarliestDate),     --|\n                                                            --|\n                \"\"IsBeforeThisMonth\"\",                        --|\n                    [Date] <= EOMONTH ( _Refdate, -1 ),     --|\n                                                            --|\n                \"\"IsLastMonth\"\",                              --|\n                    [Date] <= EOMONTH ( _Refdate, 0 )       --|\n                    &&                                      --|\n                    [Date] > EOMONTH ( _Refdate, -1 ),      --|\n                                                            --|\n                \"\"IsYTD\"\",                                    --|\n                    MONTH([Date])                           --|\n                    <=                                      --|\n                    MONTH(EOMONTH ( _Refdate, 0 )),         --|\n                                                            --|\n                \"\"IsActualToday\"\",                            --|\n                    [Date] = _Today,                        --|\n                                                            --|\n                \"\"IsRefDate\"\",                                --|\n                    [Date] = _Refdate,                      --|\n                                                            --|\n                \"\"IsHoliday\"\",                                --|\n                    MONTH([Date]) * 100                     --|\n                    +                                       --|\n                    DAY([Date])                             --|\n                        IN {0101, 0501, 1111, 1225},        --|\n                                                            --|\n                \"\"IsWeekday\"\",                                --|\n                    WEEKDAY([Date], 2)                      --|\n                        IN {1, 2, 3, 4, 5})                 --|\n                    ------------------------------------------\n        \n        VAR _Result = \n            \n                    --------------------------------------------\n            ADDCOLUMNS (                                      --|\n                _IntermediateResult,                          --|-- Boolean #2\n                \"\"IsThisYear\"\",                                 --|\n                    [Calendar Year Number (ie 2021)]          --|\n                        = _RefYear,                           --|\n                                                            --|\n                \"\"IsThisMonth\"\",                                --|\n                    [Calendar Year Month (ie 202101)]         --|\n                        = _RefMonth,                          --|\n                                                            --|\n                \"\"IsThisQuarter\"\",                              --|\n                    [Calendar Year Quarter (ie 202101)]       --|\n                        = _RefQuarter,                        --|\n                                                            --|\n                \"\"IsThisWeek\"\",                                 --|\n                    [Calendar Year Week Number EU (ie 202125)]--|\n                        = _RefWeek_EU                         --|\n            )                                                 --|\n                    --------------------------------------------\n                    \n        RETURN \n            _Result\";\n        \n        // Create date table\n        var _date = Model.AddCalculatedTable(\n            \"Date\",\n            _DateDaxExpression\n        );\n        \n        //-------------------------------------------------------------------------------------------//\n        \n        // Sort by...\n        \n        // Sort Weekdays\n        (_date.Columns[\"Weekday Name (i.e. Monday)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Weekday Number EU (i.e. 1)\"] as CalculatedTableColumn);\n        (_date.Columns[\"Weekday Short (i.e. Mon)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Weekday Number EU (i.e. 1)\"] as CalculatedTableColumn);\n        \n        // Sort Weeks\n        (_date.Columns[\"Calendar Week EU (ie WK25)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Calendar Week Number EU (ie 25)\"] as CalculatedTableColumn);\n        (_date.Columns[\"Calendar Week ISO (ie WK25)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Calendar Week Number ISO (ie 25)\"] as CalculatedTableColumn);\n        (_date.Columns[\"Calendar Week US (ie WK25)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Calendar Week Number US (ie 25)\"] as CalculatedTableColumn);\n        \n        // Sort Months\n        (_date.Columns[\"Calendar Month (ie Jan)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Calendar Month # (ie 1)\"] as CalculatedTableColumn);\n        (_date.Columns[\"Calendar Month Day (i.e. Jan 05)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Calendar Month Day (i.e. 0105)\"] as CalculatedTableColumn);\n        (_date.Columns[\"Calendar Month Year (ie Jan 21)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Calendar Year Month (ie 202101)\"] as CalculatedTableColumn);\n        \n        // Sort Quarters\n        (_date.Columns[\"Calendar Quarter Year (ie Q1 2021)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Calendar Year Quarter (ie 202101)\"] as CalculatedTableColumn);\n        \n        // Sort Years\n        (_date.Columns[\"Calendar Year (ie 2021)\"] as CalculatedTableColumn).SortByColumn = (_date.Columns[\"Calendar Year Number (ie 2021)\"] as CalculatedTableColumn);\n        \n        \n        //-------------------------------------------------------------------------------------------//\n        \n        \n        // For all the columns in the date table:\n        foreach (var c in _date.Columns )\n        {\n        c.DisplayFolder = \"7. Boolean Fields\";\n        c.IsHidden = true;\n        \n        // Organize the date table into folders\n            if ( ( c.DataType == DataType.DateTime & c.Name.Contains(\"Date\") ) )\n                {\n                c.DisplayFolder = \"6. Calendar Date\";\n                c.IsHidden = false;\n                c.IsKey = true;\n                }\n        \n            if ( c.Name == \"YYMMDDDD\" )\n                {\n                c.DisplayFolder = \"6. Calendar Date\";\n                c.IsHidden = true;\n                }\n        \n            if ( c.Name.Contains(\"Year\") & c.DataType != DataType.Boolean )\n                {\n                c.DisplayFolder = \"1. Year\";\n                c.IsHidden = false;\n                }\n        \n            if ( c.Name.Contains(\"Week\") & c.DataType != DataType.Boolean )\n                {\n                c.DisplayFolder = \"4. Week\";\n                c.IsHidden = true;\n                }\n        \n            if ( c.Name.Contains(\"day\") & c.DataType != DataType.Boolean )\n                {\n                c.DisplayFolder = \"5. Weekday / Workday\\\\Weekday\";\n                c.IsHidden = false;\n                }\n        \n            if ( c.Name.Contains(\"Month\") & c.DataType != DataType.Boolean )\n                {\n                c.DisplayFolder = \"3. Month\";\n                c.IsHidden = false;\n                }\n        \n            if ( c.Name.Contains(\"Quarter\") & c.DataType != DataType.Boolean )\n                {\n                c.DisplayFolder = \"2. Quarter\";\n                c.IsHidden = false;\n                }\n        \n        }\n        \n        // Mark as date table\n        _date.DataCategory = \"Time\";\n        \n        \n        //-------------------------------------------------------------------------------------------//\n        \n        \n        // Create Workdays MTD, QTD, YTD logic \n        //      (separate into measures & calc. column to be easier to maintain)\n        //\n        // Add calculated columns for Workdays MTD, QTD, YTD\n        \n        string _WorkdaysDax = @\"VAR _Holidays =\n            CALCULATETABLE (\n                DISTINCT ('Date'[Date]),\n                'Date'[IsHoliday] <> TRUE\n            )\n        VAR _WeekdayName = CALCULATE ( SELECTEDVALUE ( 'Date'[Weekday Short (i.e. Mon)] ) )\n        VAR _WeekendDays = SWITCH (\n                _WeekdayName,\n                \"\"Sat\"\", 2,\n                \"\"Sun\"\", 3,\n                0\n            )\n        VAR _WorkdaysMTD =\n            CALCULATE (\n                NETWORKDAYS (\n                    CALCULATE (\n                        MIN ('Date'[Date]),\n                        ALLEXCEPT ('Date', 'Date'[Calendar Month Year (ie Jan 21)])\n                    ),\n                    CALCULATE (MAX ('Date'[Date]) - _WeekendDays),\n                    1,\n                    _Holidays\n                )\n            )\n                + 1\n        RETURN\n            IF (_WorkdaysMTD < 1, 1, _WorkdaysMTD)\";\n        \n        _date.AddCalculatedColumn(\n            \"Workdays MTD\",\n            _WorkdaysDax,\n            \"5. Weekday / Workday\\\\Workdays\"\n        );\n        \n        _date.AddCalculatedColumn(\n            \"Workdays QTD\",\n            _WorkdaysDax.Replace(\"'Date'[Calendar Month Year (ie Jan 21)]\", \"'Date'[Calendar Quarter Year (ie Q1 2021)]\"),\n            \"5. Weekday / Workday\\\\Workdays\"\n        );\n        \n        _date.AddCalculatedColumn(\n            \"Workdays YTD\",\n            _WorkdaysDax.Replace(\"'Date'[Calendar Month Year (ie Jan 21)]\", \"'Date'[Calendar Year (ie 2021)]\"),\n            \"5. Weekday / Workday\\\\Workdays\"\n        );\n        \n        \n        //-------------------------------------------------------------------------------------------//\n        \n        \n        // Create measures for showing how many workdays passed\n        _WorkdaysDax = @\"CALCULATE(\n            MAX( 'Date'[Workdays MTD] ),\n            'Date'[IsDateInScope] = TRUE\n        )\";\n        \n        _date.AddMeasure(\n            \"# Workdays MTD\",\n            _WorkdaysDax,\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        _date.AddMeasure(\n            \"# Workdays QTD\",\n            _WorkdaysDax.Replace(\"MTD\", \"QTD\"),\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        _date.AddMeasure(\n            \"# Workdays YTD\",\n            _WorkdaysDax.Replace(\"MTD\", \"YTD\"),\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        // Create measures showing how many workdays are in the selected period\n        \n        _WorkdaysDax = @\"IF (\n            HASONEVALUE ('Date'[Calendar Month Year (ie Jan 21)]),\n            CALCULATE (\n                MAX ('Date'[Workdays MTD]),\n                VALUES ('Date'[Calendar Month Year (ie Jan 21)])\n            )\n        )\";\n        \n        _date.AddMeasure(\n            \"# Workdays in Selected Month\",\n            _WorkdaysDax,\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        _date.AddMeasure(\n            \"# Workdays in Selected Quarter\",\n            _WorkdaysDax.Replace(\"MTD\", \"QTD\").Replace(\"'Date'[Calendar Month Year (ie Jan 21)]\", \"'Date'[Calendar Quarter Year (ie Q1 2021)]\"),\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        _date.AddMeasure(\n            \"# Workdays in Selected Year\",\n            _WorkdaysDax.Replace(\"MTD\", \"YTD\").Replace(\"'Date'[Calendar Month Year (ie Jan 21)]\", \"'Date'[Calendar Year (ie 2021)]\"),\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        \n        // Create measures showing how many workdays passed as a %\n        \n        _WorkdaysDax = @\"IF (\n            HASONEVALUE ('Date'[Calendar Month Year (ie Jan 21)]),\n            MROUND (\n                DIVIDE ([# Workdays MTD], [# Workdays in Selected Month]),\n                0.01\n            )\n        )\";\n        \n        _date.AddMeasure(\n            \"% Workdays MTD\",\n            _WorkdaysDax,\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        _date.AddMeasure(\n            \"% Workdays QTD\",\n            _WorkdaysDax.Replace(\"MTD\", \"QTD\").Replace(\"'Date'[Calendar Month Year (ie Jan 21)]\", \"'Date'[Calendar Quarter Year (ie Q1 2021)]\").Replace(\"Month\", \"Quarter\"),\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        _date.AddMeasure(\n            \"% Workdays YTD\",\n            _WorkdaysDax.Replace(\"MTD\", \"YTD\").Replace(\"'Date'[Calendar Month Year (ie Jan 21)]\", \"'Date'[Calendar Year (ie 2021)]\").Replace(\"Month\", \"Year\"),\n            \"5. Weekday / Workday\\\\Measures\\\\# Workdays\"\n        );\n        \n        \n        //-------------------------------------------------------------------------------------------//\n        \n        \n        // Move the reference measure to the newly created 'Date' table.\n        _RefDateMeasure.Delete();\n        _RefDateMeasure = Model.Tables[\"Date\"].AddMeasure(\n            \"RefDate\",\n            \"CALCULATE ( MAX ( \" + _LatestDate + \" ), REMOVEFILTERS ( ) )\",\n            \"0. Measures\"\n        );\n        \n        _RefDateMeasure.IsHidden = true;\n        \n        Info ( \"Created a new, organized 'Date' table based on the template in the C# Script.\\nThe Earliest Date is taken from \" + _EarliestDate + \"\\nThe Latest Date is taken from \" + _LatestDate );\n    \n        }\n        catch\n        {\n            Error( \"Latest column not selected! Ending script without making changes.\" );\n        }\n}\ncatch\n{\n    Error( \"Earliest column not selected! Ending script without making changes.\" );\n}\n\n",
      "Tooltip": "Create Date Table based on 1-2 selected date columns",
      "ValidContexts": "Model"
    },
    {
      "Id": 45,
      "Name": "7. Official TE Library\\TE3\\Create New M Parameter and Add it to Existing M Partitions",
      "Enabled": "true",
      "Execute": "// This script creates a new M Parameter as a 'Shared Expression'.\n// It will also find the default value in all M partitions and replace them with the parameter object name.\n//#r \"System.Drawing\"\n\nusing System.Drawing;\nusing System.Text.RegularExpressions;\nusing System.Windows.Forms;\n\n// Hide the 'Running Macro' spinbox\nScriptHelper.WaitFormVisible = false;\n\n// Initialize variables\nstring _ParameterName = \"New Parameter\";\nstring _ParameterValue = \"ParameterValue\";\n\n// WinForms prompt to get Parameter Name / Value input\nusing (Form prompt = new Form())\n{\n    Font formFont = new Font(\"Segoe UI\", 11); \n\n    // Prompt config\n    prompt.AutoSize = true;\n    prompt.MinimumSize = new Size(380, 120);\n    prompt.Text = \"Create New M Parameter\";\n    prompt.StartPosition = FormStartPosition.CenterScreen;\n\n    // Find: label\n    Label parameterNameLabel = new Label() { Text = \"Enter Name:\" };\n    parameterNameLabel.Location = new Point(20, 20);\n    parameterNameLabel.AutoSize = true;\n    parameterNameLabel.Font = formFont;\n\n    // Textbox for inputing the substring text\n    TextBox parameterNameBox = new TextBox();\n    parameterNameBox.Width = 200;\n    parameterNameBox.Location = new Point(parameterNameLabel.Location.X + parameterNameLabel.Width + 20, parameterNameLabel.Location.Y - 4);\n    parameterNameBox.SelectedText = \"New Parameter\";\n    parameterNameBox.Font = formFont;\n\n    // Replace: label\n    Label parameterValueLabel = new Label() { Text = \"Enter Value:\" };\n    parameterValueLabel.Location = new Point(parameterNameLabel.Location.X, parameterNameLabel.Location.Y + parameterNameLabel.Height + 20);\n    parameterValueLabel.AutoSize = true;\n    parameterValueLabel.Font = formFont;\n\n    // Textbox for inputting the substring text\n    TextBox parameterValueBox = new TextBox() { Left = parameterValueLabel.Right + 20, Top = parameterValueLabel.Location.Y - 4, Width = parameterNameBox.Width };\n    parameterValueBox.SelectedText = \"Parameter Value\";\n    parameterValueBox.Font = formFont;\n\n    // OK Button\n    Button okButton = new Button() { Text = \"Create\", Left = 20, Width = 75, Top = parameterValueBox.Location.Y + parameterValueBox.Height + 20 };\n    okButton.MinimumSize = new Size(75, 25);\n    okButton.AutoSize = true;\n    okButton.Font = formFont;\n\n    // Cancel Button\n    Button cancelButton = new Button() { Text = \"Cancel\", Left = okButton.Location.X + okButton.Width + 10, Top = okButton.Location.Y };\n    cancelButton.MinimumSize = new Size(75, 25);\n    cancelButton.AutoSize = true;\n    cancelButton.Font = formFont;\n\n    // Button actions\n    okButton.Click += (sender, e) => { _ParameterName = parameterNameBox.Text; _ParameterValue = parameterValueBox.Text; prompt.DialogResult = DialogResult.OK; };\n    cancelButton.Click += (sender, e) => { prompt.DialogResult = DialogResult.Cancel; };\n\n    prompt.AcceptButton = okButton;\n    prompt.CancelButton = cancelButton;\n\n    prompt.Controls.Add(parameterNameLabel);\n    prompt.Controls.Add(parameterNameBox);\n    prompt.Controls.Add(parameterValueLabel);\n    prompt.Controls.Add(parameterValueBox);\n    prompt.Controls.Add(okButton);\n    prompt.Controls.Add(cancelButton);\n\n    // The user clicked OK, so perform the find-and-replace logic\n    if (prompt.ShowDialog() == DialogResult.OK)\n    {\n\n        // Creates the parameter\n        Model.AddExpression( \n            _ParameterName, \n            @\"\n        \"\"\" + _ParameterValue +\n        @\"\"\" meta\n        [\n            IsParameterQuery = true,\n            IsParameterQueryRequired = true,\n            Type = type text\n        ]\"\n        );\n        \n        \n        // Informs the user that the parameter was successfully created\n        Info ( \n            \"Successfully created a new parameter: \" + @\"\"\"\" +\n            _ParameterName + @\"\"\"\" +\n            \"\\nDefault value: \" + @\"\"\"\" +\n            _ParameterValue + @\"\"\"\");\n        \n        \n        // Finds the parameter default value in M Partitions & replaces with the parameter name\n        string _Find = @\"\"\"\" + _ParameterValue + @\"\"\"\";\n        string _Replace = @\"#\"\"\" + _ParameterName + @\"\"\"\";\n        \n        int _NrMPartitions = 0;\n        int _NrReplacements = 0;\n        var _ReplacementsList = new List<string>();\n        \n        foreach ( var _Tables in Model.Tables )\n        {\n            foreach ( var _p in _Tables.Partitions )\n            {\n                if ( _p.SourceType == PartitionSourceType.M )\n                {\n                    if ( _p.Expression != _p.Expression.Replace( _Find, _Replace ) )\n                    {\n                        _p.Expression = _p.Expression.Replace( _Find, _Replace );\n        \n                        // Tracks which M partitions were replaced (and how many)\n                        _NrReplacements = _NrReplacements + 1;\n                        _ReplacementsList.Add( _p.Name );\n                    }\n        \n                // Counts the total # M Partitions\n                _NrMPartitions = _NrMPartitions + 1;\n                }\n            }\n        }\n        \n        \n        // Makes a bulleted list of all the M partitions that were replaced\n        string _ReplacedPartitions = \" • \" + String.Join(\"\\n • \", _ReplacementsList );\n        \n        \n        // Informs \n        //      - Whether the Find & Replace was successful\n        //      - How many M partitions were replaced\n        //      - Which M partitions had the Find & Replace done\n        Info (\n            \"Successfully replaced\\n\\n \" +\n            _Find + \n            \"\\n\\n with: \\n\\n\" + \n            _Replace + \n            \"\\n\\n in \" + \n            Convert.ToString(_NrReplacements) +\n            \" of \" +\n            Convert.ToString(_NrMPartitions) +  \n            \" M Partitions:\\n\" +\n            _ReplacedPartitions\n        );\n\n    }\n    else\n    {\n    Error ( \"Cancelled input! Ended script without changes.\");\n    }\n}\n",
      "Tooltip": "If you want to replace a string in model M Partitions (i.e. connection string, filter condition, column name, etc.) with a parameter value.",
      "ValidContexts": "Model"
    },
    {
      "Id": 48,
      "Name": "7. Official TE Library\\Find & Replace Substring in Measures",
      "Enabled": "true",
      "Execute": "#r \"System.Drawing\"\n\nusing System.Drawing;\nusing System.Text.RegularExpressions;\nusing System.Windows.Forms;\n\n// Hide the 'Running Macro' spinbox\nScriptHelper.WaitFormVisible = false;\n\n// Replace Selected.Measures with Model.AllMeasures to scan all measures\nvar _measures = Model.AllMeasures;\n    // Optional: Replace _m.Expression with _m.Name to find & replace in names.\n\n// Initialize _find and _replace string variables\nstring _find = \"Find\";\nstring _replace = \"Replace\";\n\n// WinForms prompt to get Find & Replace input\nusing (Form prompt = new Form())\n{\n    Font formFont = new Font(\"Segoe UI\", 11); \n\n    // Prompt config\n    prompt.AutoSize = true;\n    prompt.MinimumSize = new Size(350, 120);\n    prompt.Text = \"Find and Replace Dialog\";\n    prompt.StartPosition = FormStartPosition.CenterScreen;\n\n    // Set the AutoScaleMode property to Dpi\n    prompt.AutoScaleMode = AutoScaleMode.Dpi;\n\n    // Find: label\n    Label findLabel = new Label() { Text = \"Find:\" };\n    findLabel.Location = new Point(20, 20);\n    findLabel.Width = 80;\n    findLabel.Font = formFont;\n\n    // Textbox for inputing the substring text\n    TextBox findBox = new TextBox();\n    findBox.Width = 200;\n    findBox.Location = new Point(findLabel.Location.X + findLabel.Width + 20, findLabel.Location.Y - 4);\n    findBox.SelectedText = \"Find this Text\";\n    findBox.Font = formFont;\n\n    // Replace: label\n    Label replaceLabel = new Label() { Left = 20, Top = 60, Text = \"Replace:\" };\n    replaceLabel.Width = 80;\n    replaceLabel.Font = formFont;\n\n    // Textbox for inputting the substring text\n    TextBox replaceBox = new TextBox() { Left = replaceLabel.Right + 20, Top = replaceLabel.Location.Y - 4, Width = findBox.Width };\n    replaceBox.SelectedText = \"Replace with this Text\";\n    replaceBox.Font = formFont;\n\n    // OK Button\n    Button okButton = new Button() { Text = \"OK\", Left = 20, Width = 75, Top = replaceBox.Location.Y + replaceBox.Height + 20 };\n    okButton.MinimumSize = new Size(75, 25);\n    okButton.AutoSize = true;\n    okButton.Font = formFont;\n\n    // Cancel Button\n    Button cancelButton = new Button() { Text = \"Cancel\", Left = okButton.Location.X + okButton.Width + 10, Top = okButton.Location.Y };\n    cancelButton.MinimumSize = new Size(75, 25);\n    cancelButton.AutoSize = true;\n    cancelButton.Font = formFont;\n\n    // Button actions\n    okButton.Click += (sender, e) => { _find = findBox.Text; _replace = replaceBox.Text; prompt.DialogResult = DialogResult.OK; };\n    cancelButton.Click += (sender, e) => { prompt.DialogResult = DialogResult.Cancel; };\n\n    prompt.AcceptButton = okButton;\n    prompt.CancelButton = cancelButton;\n\n    prompt.Controls.Add(findLabel);\n    prompt.Controls.Add(findBox);\n    prompt.Controls.Add(replaceLabel);\n    prompt.Controls.Add(replaceBox);\n    prompt.Controls.Add(okButton);\n    prompt.Controls.Add(cancelButton);\n\n    // The user clicked OK, so perform the find-and-replace logic\n    if (prompt.ShowDialog() == DialogResult.OK)\n        {\n            \n            int _occurrences = 0;\n            var _ReplacedList = new List<string>();\n    \n            foreach (var _m in _measures)\n                {\n                    if (_m.Expression != _m.Expression.Replace(_find, _replace))\n                        {\n                            try\n                                {\n                                    // Count number of occurrences of _find substring in the string\n                                    string _pattern = Regex.Escape(_find);\n                                    _occurrences = Regex.Matches(_m.Expression, _pattern).Count;\n                                }\n                            catch\n                                {\n                                    // If it's not found there are 0 occurrences\n                                    _occurrences = 0;\n                                }\n            \n                            // Perform the Find/Replace\n                            _m.Expression = _m.Expression.Replace(_find, _replace);\n                            _ReplacedList.Add(_m.DaxObjectName);\n                        }\n                }\n    \n            // Create a list of all the measures replaced\n            string _Replaced = _ReplacedList.Count > 0\n                ? \"\\n\\nMeasures with Replacements:\\n • \" + string.Join(\"\\n • \", _ReplacedList)\n                : \"\";\n    \n            // Return a success Info box pop-up\n            Info(\n                \"Replaced \" + \n                _occurrences + \n                \" occurrences of '\" + \n                _find + \n                \"' with '\" + \n                _replace + \n                \"'\" + \n                _Replaced);\n        }\n    else\n        {\n            Error(\"Find/Replace cancelled!\");\n        }\n}\n\n",
      "Tooltip": "Will find & replace a substring in the model's measures DAX expression.",
      "ValidContexts": "Model"
    }
